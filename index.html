<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>J.A.R.V.I.S ‚Äî Just A Rather Very Intelligent System</title>
<link href="https://fonts.googleapis.com/css2?family=Rajdhani:wght@300;400;500;600;700&family=Orbitron:wght@400;500;600;700;900&family=Share+Tech+Mono&display=swap" rel="stylesheet">
<style>
  :root {
    --hud: #00d4ff;
    --hud2: #0066ff;
    --hud3: #00ffaa;
    --red: #ff3333;
    --orange: #ff8800;
    --bg: #010912;
    --panel: rgba(0,180,255,0.04);
    --border: rgba(0,212,255,0.2);
    --border2: rgba(0,212,255,0.5);
    --text: #c8eeff;
    --text2: rgba(0,212,255,0.6);
    --glow: 0 0 20px rgba(0,212,255,0.4), 0 0 60px rgba(0,212,255,0.1);
    --glow2: 0 0 30px rgba(0,212,255,0.6);
  }

  * { margin:0; padding:0; box-sizing:border-box; }

  body {
    font-family: 'Rajdhani', sans-serif;
    background: var(--bg);
    color: var(--text);
    min-height: 100vh;
    overflow-x: hidden;
    user-select: none;
  }

  /* SCANLINE OVERLAY */
  body::before {
    content: '';
    position: fixed; inset: 0;
    background: repeating-linear-gradient(0deg, transparent, transparent 2px, rgba(0,212,255,0.015) 2px, rgba(0,212,255,0.015) 4px);
    pointer-events: none; z-index: 9999;
  }

  /* GRID BACKGROUND */
  .grid-bg {
    position: fixed; inset: 0; z-index: 0;
    background-image:
      linear-gradient(rgba(0,212,255,0.04) 1px, transparent 1px),
      linear-gradient(90deg, rgba(0,212,255,0.04) 1px, transparent 1px);
    background-size: 50px 50px;
    mask-image: radial-gradient(ellipse 80% 80% at 50% 50%, black, transparent);
  }

  /* MAIN LAYOUT */
  .app {
    position: relative; z-index: 1;
    min-height: 100vh;
    display: grid;
    grid-template-rows: auto 1fr auto;
    grid-template-columns: 280px 1fr 280px;
    gap: 0;
    padding: 1rem;
  }

  /* HUD PANELS */
  .panel {
    background: var(--panel);
    border: 1px solid var(--border);
    border-radius: 4px;
    padding: 1rem;
    position: relative;
    overflow: hidden;
  }
  .panel::before {
    content: '';
    position: absolute; top:0; left:0; right:0; height:1px;
    background: linear-gradient(90deg, transparent, var(--hud), transparent);
    animation: scanH 3s linear infinite;
  }
  @keyframes scanH { 0%{transform:translateX(-100%)} 100%{transform:translateX(100%)} }

  .corner-tl, .corner-tr, .corner-bl, .corner-br {
    position: absolute; width: 12px; height: 12px;
    border-color: var(--hud); border-style: solid;
  }
  .corner-tl { top:0; left:0; border-width:2px 0 0 2px; }
  .corner-tr { top:0; right:0; border-width:2px 2px 0 0; }
  .corner-bl { bottom:0; left:0; border-width:0 0 2px 2px; }
  .corner-br { bottom:0; right:0; border-width:0 2px 2px 0; }

  /* HEADER */
  .header {
    grid-column: 1 / -1;
    display: flex; align-items: center; justify-content: space-between;
    padding: 0.75rem 1.5rem;
    border: 1px solid var(--border);
    background: rgba(0,20,40,0.6);
    margin-bottom: 1rem;
    position: relative;
    backdrop-filter: blur(10px);
  }
  .header-logo {
    font-family: 'Orbitron', monospace;
    font-size: 1.4rem;
    font-weight: 900;
    color: var(--hud);
    text-shadow: var(--glow);
    letter-spacing: 0.2em;
  }
  .header-logo span { color: var(--hud3); font-size: 0.65rem; display: block; letter-spacing: 0.3em; margin-top: -2px; font-weight: 400; }
  .header-status {
    display: flex; gap: 2rem; align-items: center;
  }
  .status-item {
    display: flex; flex-direction: column; align-items: center;
    font-size: 0.65rem; letter-spacing: 0.1em; color: var(--text2);
    font-family: 'Share Tech Mono', monospace;
  }
  .status-item .val {
    font-size: 1rem; color: var(--hud3); font-weight: 600;
    font-family: 'Orbitron', monospace;
  }
  .header-time {
    font-family: 'Orbitron', monospace;
    font-size: 1.5rem;
    color: var(--hud);
    text-shadow: var(--glow);
    letter-spacing: 0.1em;
  }
  .header-date {
    font-size: 0.65rem; color: var(--text2);
    font-family: 'Share Tech Mono', monospace;
    text-align: right; margin-top: 2px;
  }

  /* LEFT PANEL */
  .left-panel {
    grid-column: 1;
    grid-row: 2;
    display: flex; flex-direction: column; gap: 1rem;
    padding-right: 0.5rem;
  }

  /* RIGHT PANEL */
  .right-panel {
    grid-column: 3;
    grid-row: 2;
    display: flex; flex-direction: column; gap: 1rem;
    padding-left: 0.5rem;
  }

  /* CENTER */
  .center {
    grid-column: 2;
    grid-row: 2;
    display: flex; flex-direction: column; align-items: center; justify-content: center;
    gap: 1.5rem;
    padding: 0 1rem;
  }

  /* SECTION LABEL */
  .section-label {
    font-family: 'Share Tech Mono', monospace;
    font-size: 0.6rem;
    color: var(--text2);
    letter-spacing: 0.2em;
    margin-bottom: 0.75rem;
    display: flex; align-items: center; gap: 0.5rem;
  }
  .section-label::before { content: '‚ñ∏'; color: var(--hud); }
  .section-label::after { content: ''; flex:1; height:1px; background: linear-gradient(to right, var(--border), transparent); }

  /* ARC REACTOR / ORBS */
  .arc-container {
    position: relative;
    width: 260px; height: 260px;
    display: flex; align-items: center; justify-content: center;
  }
  .arc-ring {
    position: absolute;
    border-radius: 50%;
    border: 1px solid var(--border);
  }
  .arc-ring-1 { width:260px; height:260px; border-color:rgba(0,212,255,0.15); animation: spin 20s linear infinite; }
  .arc-ring-2 { width:220px; height:220px; border-color:rgba(0,212,255,0.2); border-style:dashed; animation: spin 15s linear infinite reverse; }
  .arc-ring-3 { width:180px; height:180px; border-color:rgba(0,212,255,0.3); animation: spin 10s linear infinite; }
  @keyframes spin { to { transform: rotate(360deg); } }

  .arc-tick {
    position: absolute; width:100%; height:100%;
    border-radius:50%;
  }
  .arc-tick::before {
    content: '';
    position: absolute;
    width: 6px; height: 6px;
    background: var(--hud);
    border-radius: 50%;
    top: -3px; left: 50%; transform: translateX(-50%);
    box-shadow: 0 0 10px var(--hud), 0 0 20px var(--hud);
  }
  .arc-ring-1 .arc-tick { animation: spin 20s linear infinite; }
  .arc-ring-3 .arc-tick { animation: spin 10s linear infinite; }

  .arc-core {
    width: 130px; height: 130px;
    border-radius: 50%;
    background: radial-gradient(circle, rgba(0,212,255,0.15) 0%, rgba(0,212,255,0.05) 50%, transparent 70%);
    border: 2px solid rgba(0,212,255,0.4);
    display: flex; align-items: center; justify-content: center;
    position: relative;
    cursor: pointer;
    transition: all 0.3s;
    box-shadow: 0 0 30px rgba(0,212,255,0.2), inset 0 0 30px rgba(0,212,255,0.1);
  }
  .arc-core:hover { box-shadow: 0 0 60px rgba(0,212,255,0.5), inset 0 0 40px rgba(0,212,255,0.2); }
  .arc-core.listening {
    border-color: var(--hud3);
    box-shadow: 0 0 60px rgba(0,255,170,0.5), inset 0 0 40px rgba(0,255,170,0.2);
    animation: listenPulse 1s ease-in-out infinite;
  }
  .arc-core.speaking {
    border-color: var(--orange);
    box-shadow: 0 0 60px rgba(255,136,0,0.5), inset 0 0 40px rgba(255,136,0,0.2);
    animation: speakPulse 0.4s ease-in-out infinite;
  }
  .arc-core.thinking {
    border-color: var(--hud2);
    box-shadow: 0 0 60px rgba(0,102,255,0.5), inset 0 0 40px rgba(0,102,255,0.2);
    animation: thinkSpin 1s linear infinite;
  }
  @keyframes listenPulse { 0%,100%{transform:scale(1)} 50%{transform:scale(1.05)} }
  @keyframes speakPulse {
    0%,100%{transform:scale(1)}
    25%{transform:scale(1.04)}
    75%{transform:scale(0.98)}
  }
  @keyframes thinkSpin { to { filter: hue-rotate(360deg); } }

  .arc-icon {
    font-size: 2.5rem;
    text-shadow: 0 0 20px var(--hud);
    transition: all 0.3s;
    pointer-events: none;
  }
  .arc-status-text {
    position: absolute;
    bottom: -32px;
    font-family: 'Share Tech Mono', monospace;
    font-size: 0.65rem;
    color: var(--hud);
    letter-spacing: 0.2em;
    text-transform: uppercase;
    text-shadow: var(--glow);
    white-space: nowrap;
  }

  /* WAVEFORM */
  .waveform-container {
    width: 100%;
    display: flex; align-items: center; justify-content: center;
    gap: 3px;
    height: 40px;
  }
  .wave-bar {
    width: 3px;
    background: var(--hud);
    border-radius: 2px;
    opacity: 0.3;
    height: 4px;
    transition: height 0.1s, opacity 0.1s;
  }
  .wave-bar.active { opacity: 1; }

  /* CHAT */
  .chat-area {
    width: 100%;
    max-width: 640px;
    height: 240px;
    overflow-y: auto;
    display: flex;
    flex-direction: column;
    gap: 0.75rem;
    padding: 1rem;
    background: rgba(0,0,0,0.3);
    border: 1px solid var(--border);
    border-radius: 4px;
    position: relative;
  }
  .chat-area::-webkit-scrollbar { width: 3px; }
  .chat-area::-webkit-scrollbar-thumb { background: var(--border2); border-radius: 99px; }

  .msg {
    display: flex; flex-direction: column; gap: 2px;
    animation: msgIn 0.3s ease both;
  }
  @keyframes msgIn { from{opacity:0;transform:translateY(8px)} to{opacity:1;transform:translateY(0)} }
  .msg-label {
    font-family: 'Share Tech Mono', monospace;
    font-size: 0.58rem;
    letter-spacing: 0.2em;
    text-transform: uppercase;
  }
  .msg.user .msg-label { color: var(--hud3); }
  .msg.jarvis .msg-label { color: var(--hud); }
  .msg.system .msg-label { color: var(--orange); }
  .msg-text {
    font-size: 0.95rem;
    line-height: 1.5;
    font-weight: 400;
  }
  .msg.user .msg-text { color: rgba(0,255,170,0.9); }
  .msg.jarvis .msg-text { color: var(--text); }
  .msg.system .msg-text { color: rgba(255,136,0,0.8); font-size:0.8rem; font-family:'Share Tech Mono',monospace; letter-spacing:0.05em; }

  .typing-indicator {
    display: flex; gap: 4px; align-items: center; padding: 4px 0;
  }
  .typing-dot {
    width: 5px; height: 5px;
    background: var(--hud);
    border-radius: 50%;
    animation: typingDot 1.2s ease-in-out infinite;
  }
  .typing-dot:nth-child(2) { animation-delay: 0.2s; }
  .typing-dot:nth-child(3) { animation-delay: 0.4s; }
  @keyframes typingDot { 0%,60%,100%{opacity:0.2;transform:scale(0.8)} 30%{opacity:1;transform:scale(1)} }

  /* INPUT */
  .input-row {
    display: flex; gap: 0.75rem; align-items: center;
    width: 100%; max-width: 640px;
  }
  .text-input {
    flex: 1;
    background: rgba(0,0,0,0.4);
    border: 1px solid var(--border);
    border-radius: 4px;
    padding: 0.75rem 1rem;
    font-family: 'Rajdhani', sans-serif;
    font-size: 0.95rem;
    color: var(--text);
    outline: none;
    transition: border-color 0.2s, box-shadow 0.2s;
    letter-spacing: 0.02em;
  }
  .text-input:focus { border-color: var(--border2); box-shadow: var(--glow); }
  .text-input::placeholder { color: rgba(0,212,255,0.25); font-size:0.85rem; letter-spacing:0.1em; }

  .hud-btn {
    background: rgba(0,212,255,0.08);
    border: 1px solid var(--border);
    color: var(--hud);
    border-radius: 4px;
    padding: 0.7rem 1.2rem;
    font-family: 'Share Tech Mono', monospace;
    font-size: 0.75rem;
    cursor: pointer;
    letter-spacing: 0.1em;
    transition: all 0.2s;
    white-space: nowrap;
  }
  .hud-btn:hover { background: rgba(0,212,255,0.15); border-color: var(--border2); box-shadow: var(--glow); }
  .hud-btn.active { background: rgba(0,255,170,0.1); border-color: rgba(0,255,170,0.5); color: var(--hud3); }
  .hud-btn.danger { border-color: rgba(255,51,51,0.4); color: var(--red); }
  .hud-btn.danger:hover { background: rgba(255,51,51,0.1); }

  /* LEFT SIDE WIDGETS */
  .mini-stat {
    display: flex; justify-content: space-between; align-items: center;
    padding: 0.5rem 0;
    border-bottom: 1px solid rgba(0,212,255,0.07);
    font-size: 0.8rem;
  }
  .mini-stat:last-child { border-bottom: none; }
  .mini-stat-label { color: var(--text2); letter-spacing: 0.05em; }
  .mini-stat-val { font-family: 'Orbitron', monospace; font-size: 0.75rem; color: var(--hud3); }

  .bar-track { height: 4px; background: rgba(255,255,255,0.06); border-radius: 99px; margin-top: 4px; overflow: hidden; }
  .bar-fill { height: 100%; border-radius: 99px; background: linear-gradient(90deg, var(--hud2), var(--hud)); position:relative; }
  .bar-fill::after { content:''; position:absolute; right:0; top:0; bottom:0; width:4px; background:white; border-radius:99px; box-shadow:0 0 8px white; }

  .memory-item {
    padding: 0.4rem 0.6rem;
    background: rgba(0,212,255,0.04);
    border: 1px solid rgba(0,212,255,0.08);
    border-left: 2px solid var(--hud);
    border-radius: 2px;
    font-size: 0.72rem;
    color: var(--text2);
    margin-bottom: 0.4rem;
    line-height: 1.4;
    letter-spacing: 0.02em;
    cursor: pointer;
    transition: background 0.2s;
  }
  .memory-item:hover { background: rgba(0,212,255,0.08); color: var(--text); }
  .memory-time { font-family: 'Share Tech Mono', monospace; font-size: 0.55rem; color: var(--text2); opacity: 0.5; display:block; margin-top:2px; }
  .mem-tab {
    background: rgba(0,212,255,0.04); border: 1px solid var(--border);
    color: var(--text2); border-radius: 3px; padding: 0.2rem 0.5rem;
    font-family: 'Share Tech Mono', monospace; font-size: 0.58rem;
    cursor: pointer; letter-spacing: 0.08em; transition: all 0.2s;
  }
  .mem-tab:hover, .mem-tab.active { background: rgba(0,212,255,0.15); color: var(--hud); border-color: var(--border2); }
  .mem-delete-btn {
    margin-left: auto; background: none; border: none; color: rgba(255,51,51,0.4);
    cursor: pointer; font-size: 0.7rem; padding: 0 2px; line-height: 1;
    transition: color 0.2s;
  }
  .mem-delete-btn:hover { color: var(--red); }
  .mem-cat-badge {
    font-family: 'Share Tech Mono', monospace; font-size: 0.52rem;
    padding: 0.1rem 0.35rem; border-radius: 2px; letter-spacing: 0.05em;
    margin-right: 4px;
  }
  .cat-personal { background: rgba(124,58,237,0.2); color: #a78bfa; }
  .cat-task     { background: rgba(255,136,0,0.15); color: var(--orange); }
  .cat-fact     { background: rgba(0,212,255,0.1); color: var(--hud); }
  .cat-general  { background: rgba(255,255,255,0.05); color: var(--text2); }

  /* RIGHT SIDE - VOICE VISUALIZER */
  .voice-bars {
    display: flex; gap: 2px; align-items: flex-end; height: 60px; padding: 0 4px;
  }
  .vbar {
    flex:1; background: linear-gradient(to top, var(--hud2), var(--hud));
    border-radius: 1px 1px 0 0;
    height: 4px;
    transition: height 0.08s;
    opacity: 0.6;
  }

  .quick-cmd {
    display: flex; align-items: center; gap: 8px;
    padding: 0.5rem 0.6rem;
    background: rgba(0,212,255,0.04);
    border: 1px solid var(--border);
    border-radius: 4px;
    cursor: pointer;
    transition: all 0.2s;
    font-size: 0.78rem;
    letter-spacing: 0.02em;
    color: var(--text2);
  }
  .quick-cmd:hover { background: rgba(0,212,255,0.1); color: var(--text); border-color: var(--border2); }
  .quick-cmd .qicon { color: var(--hud); font-size: 0.9rem; }

  /* FOOTER */
  .footer {
    grid-column: 1/-1;
    margin-top: 1rem;
    border: 1px solid var(--border);
    padding: 0.5rem 1.5rem;
    display: flex; justify-content: space-between; align-items: center;
    background: rgba(0,20,40,0.4);
    font-family: 'Share Tech Mono', monospace;
    font-size: 0.6rem;
    color: var(--text2);
    letter-spacing: 0.1em;
  }

  /* NOTIFICATIONS */
  #notif {
    position: fixed; top: 1rem; right: 1rem;
    z-index: 9000;
    display: flex; flex-direction: column; gap: 0.5rem;
  }
  .notif-item {
    background: rgba(0,20,40,0.95);
    border: 1px solid var(--border2);
    border-left: 3px solid var(--hud);
    padding: 0.6rem 1rem;
    border-radius: 4px;
    font-family: 'Share Tech Mono', monospace;
    font-size: 0.7rem;
    color: var(--text);
    animation: notifIn 0.3s ease both;
    backdrop-filter: blur(10px);
    max-width: 280px;
  }
  @keyframes notifIn { from{opacity:0;transform:translateX(20px)} to{opacity:1;transform:translateX(0)} }

  /* ANIMATED GRADIENT BORDER */
  @keyframes borderGlow {
    0%,100% { box-shadow: 0 0 10px rgba(0,212,255,0.2); }
    50% { box-shadow: 0 0 30px rgba(0,212,255,0.5); }
  }

  .glowing { animation: borderGlow 3s ease-in-out infinite; }

  /* HEX GRID DECORATION */
  .hex-deco {
    position: fixed; opacity: 0.03; font-size: 1.5rem; pointer-events: none; z-index: 0;
    font-family: monospace; color: var(--hud);
    animation: hexFloat 8s ease-in-out infinite;
  }
  @keyframes hexFloat { 0%,100%{transform:translateY(0)} 50%{transform:translateY(-20px)} }

  /* SCROLLBAR */
  ::-webkit-scrollbar { width: 4px; }
  ::-webkit-scrollbar-track { background: transparent; }
  ::-webkit-scrollbar-thumb { background: var(--border); border-radius: 99px; }
</style>
</head>
<body>

<div class="grid-bg"></div>

<!-- Decorative elements -->
<div class="hex-deco" style="top:15%;left:3%;">‚¨°‚¨°‚¨°<br>‚¨°‚¨°‚¨°<br>‚¨°‚¨°‚¨°</div>
<div class="hex-deco" style="top:60%;right:3%;animation-delay:3s;">‚¨°‚¨°‚¨°<br>‚¨°‚¨°‚¨°<br>‚¨°‚¨°‚¨°</div>

<!-- NOTIFICATIONS -->
<div id="notif"></div>

<!-- MAIN APP -->
<div class="app">

  <!-- HEADER -->
  <div class="header glowing">
    <div class="corner-tl"></div><div class="corner-tr"></div>
    <div class="corner-bl"></div><div class="corner-br"></div>
    <div class="header-logo">
      J.A.R.V.I.S
      <span>JUST A RATHER VERY INTELLIGENT SYSTEM ¬∑ v7.3.1</span>
    </div>
    <div class="header-status">
      <div class="status-item"><span class="val" id="stat-ops">0</span>OPERATIONS</div>
      <div class="status-item"><span class="val" id="stat-uptime">100%</span>UPTIME</div>
      <div class="status-item"><span class="val" id="stat-mode">STANDBY</span>MODE</div>
    </div>
    <div>
      <div class="header-time" id="clock">00:00:00</div>
      <div class="header-date" id="date-display">LOADING...</div>
    </div>
  </div>

  <!-- LEFT PANEL -->
  <div class="left-panel">

    <!-- SYSTEM STATUS -->
    <div class="panel">
      <div class="corner-tl"></div><div class="corner-tr"></div>
      <div class="corner-bl"></div><div class="corner-br"></div>
      <div class="section-label">SYSTEM DIAGNOSTICS</div>
      <div class="mini-stat">
        <span class="mini-stat-label">CPU CORE</span>
        <span class="mini-stat-val" id="cpu-val">--</span>
      </div>
      <div class="bar-track"><div class="bar-fill" id="cpu-bar" style="width:45%"></div></div>
      <div style="height:10px"></div>
      <div class="mini-stat">
        <span class="mini-stat-label">MEMORY</span>
        <span class="mini-stat-val" id="mem-val">--</span>
      </div>
      <div class="bar-track"><div class="bar-fill" id="mem-bar" style="width:62%;background:linear-gradient(90deg,#7c3aed,#a78bfa)"></div></div>
      <div style="height:10px"></div>
      <div class="mini-stat">
        <span class="mini-stat-label">AI ENGINE</span>
        <span class="mini-stat-val" style="color:var(--hud3)">ONLINE</span>
      </div>
      <div class="bar-track"><div class="bar-fill" style="width:100%;background:linear-gradient(90deg,#10b981,#00ffaa)"></div></div>
      <div style="height:10px"></div>
      <div class="mini-stat">
        <span class="mini-stat-label">SPEECH SYS</span>
        <span class="mini-stat-val" id="speech-stat" style="color:var(--orange)">INIT</span>
      </div>
      <div class="bar-track"><div class="bar-fill" id="speech-bar" style="width:0%;background:linear-gradient(90deg,var(--orange),#ffbb00)"></div></div>
    </div>

    <!-- PERSISTENT MEMORY VAULT -->
    <div class="panel" style="flex:1;overflow:hidden;display:flex;flex-direction:column;">
      <div class="corner-tl"></div><div class="corner-tr"></div>
      <div class="corner-bl"></div><div class="corner-br"></div>
      <div class="section-label">MEMORY VAULT <span id="mem-count" style="color:var(--hud3);margin-left:4px;font-size:0.6rem;">0 STORED</span></div>
      <div style="display:flex;gap:0.4rem;margin-bottom:0.6rem;">
        <input id="memInput" placeholder="Save something for JARVIS to remember..." style="flex:1;background:rgba(0,0,0,0.4);border:1px solid var(--border);border-radius:3px;padding:0.4rem 0.6rem;font-family:'Rajdhani',sans-serif;font-size:0.78rem;color:var(--text);outline:none;" onkeydown="if(event.key==='Enter')saveMemory()">
        <button class="hud-btn" onclick="saveMemory()" style="padding:0.4rem 0.6rem;font-size:0.65rem;">SAVE</button>
      </div>
      <div style="display:flex;gap:0.3rem;margin-bottom:0.6rem;flex-wrap:wrap;" id="mem-tabs">
        <button class="mem-tab active" data-cat="all" onclick="filterMemories('all',this)">ALL</button>
        <button class="mem-tab" data-cat="personal" onclick="filterMemories('personal',this)">PERSONAL</button>
        <button class="mem-tab" data-cat="task" onclick="filterMemories('task',this)">TASKS</button>
        <button class="mem-tab" data-cat="fact" onclick="filterMemories('fact',this)">FACTS</button>
      </div>
      <div id="memory-list" style="flex:1;overflow-y:auto;"></div>
      <button class="hud-btn danger" onclick="clearAllMemories()" style="width:100%;margin-top:0.5rem;font-size:0.65rem;">‚ö† WIPE ALL MEMORIES</button>
    </div>

    <!-- QUICK COMMANDS -->
    <div class="panel">
      <div class="corner-tl"></div><div class="corner-tr"></div>
      <div class="corner-bl"></div><div class="corner-br"></div>
      <div class="section-label">QUICK COMMANDS</div>
      <div style="display:flex;flex-direction:column;gap:0.4rem;">
        <div class="quick-cmd" onclick="quickCmd('What time is it and what can you tell me about today?')"><span class="qicon">‚è∞</span>TIME & DATE</div>
        <div class="quick-cmd" onclick="quickCmd('Tell me a fascinating science fact I probably dont know.')"><span class="qicon">üî¨</span>SCIENCE BRIEF</div>
        <div class="quick-cmd" onclick="quickCmd('Give me 3 strategic productivity tips for high performance.')"><span class="qicon">‚ö°</span>PRODUCTIVITY</div>
        <div class="quick-cmd" onclick="quickCmd('Tell me something interesting about artificial intelligence and its future.')"><span class="qicon">üß†</span>AI BRIEFING</div>
        <div class="quick-cmd" onclick="quickCmd('Write me a short motivational speech in the style of Tony Stark.')"><span class="qicon">üéØ</span>MOTIVATION</div>
      </div>
    </div>

  </div>

  <!-- CENTER -->
  <div class="center">

    <!-- ARC REACTOR -->
    <div class="arc-container">
      <div class="arc-ring arc-ring-1"><div class="arc-tick"></div></div>
      <div class="arc-ring arc-ring-2"></div>
      <div class="arc-ring arc-ring-3"><div class="arc-tick"></div></div>
      <div class="arc-core" id="arcCore" onclick="toggleListen()">
        <span class="arc-icon" id="arcIcon">‚¨°</span>
        <div class="arc-status-text" id="arcStatusText">CLICK TO SPEAK</div>
      </div>
    </div>

    <!-- WAVEFORM -->
    <div class="waveform-container" id="waveform"></div>

    <!-- CHAT AREA -->
    <div class="chat-area" id="chatArea">
      <div class="msg system">
        <span class="msg-label">‚ñ∏ SYSTEM</span>
        <span class="msg-text">J.A.R.V.I.S online. All systems nominal. Good day, sir. I am at your disposal.</span>
      </div>
    </div>

    <!-- INPUT ROW -->
    <div class="input-row">
      <input class="text-input" id="textInput" placeholder="ENTER COMMAND OR QUERY..." onkeydown="if(event.key==='Enter')sendText()" autocomplete="off">
      <button class="hud-btn" onclick="sendText()">SEND</button>
      <button class="hud-btn" id="voiceBtn" onclick="toggleListen()">üé§ VOICE</button>
    </div>

    <!-- BOTTOM CONTROLS -->
    <div style="display:flex;gap:0.75rem;flex-wrap:wrap;justify-content:center;">
      <button class="hud-btn" onclick="clearChat()">CLEAR LOG</button>
      <button class="hud-btn" id="autoSpeakBtn" onclick="toggleAutoSpeak()">üîä AUTO-SPEAK: ON</button>
      <button class="hud-btn" onclick="showApiKeyModal()">‚öô API KEY</button>
      <button class="hud-btn danger" onclick="emergencyStop()">‚ñ† STOP</button>
    </div>

  </div>

  <!-- RIGHT PANEL -->
  <div class="right-panel">

    <!-- VOICE ANALYZER -->
    <div class="panel">
      <div class="corner-tl"></div><div class="corner-tr"></div>
      <div class="corner-bl"></div><div class="corner-br"></div>
      <div class="section-label">VOICE ANALYZER</div>
      <div class="voice-bars" id="voiceBars">
      </div>
      <div style="margin-top:0.75rem;display:grid;grid-template-columns:1fr 1fr;gap:0.5rem;">
        <div class="mini-stat" style="flex-direction:column;align-items:flex-start;border:none;gap:2px;">
          <span class="mini-stat-label" style="font-size:0.58rem;">RECOGNITION</span>
          <span class="mini-stat-val" id="rec-accuracy">--</span>
        </div>
        <div class="mini-stat" style="flex-direction:column;align-items:flex-start;border:none;gap:2px;">
          <span class="mini-stat-label" style="font-size:0.58rem;">VOICE RATE</span>
          <span class="mini-stat-val" id="voice-rate" style="color:var(--hud2)">1.0x</span>
        </div>
      </div>
    </div>

    <!-- VOICE SETTINGS -->
    <div class="panel">
      <div class="corner-tl"></div><div class="corner-tr"></div>
      <div class="corner-bl"></div><div class="corner-br"></div>
      <div class="section-label">VOICE SETTINGS</div>
      <div style="display:flex;flex-direction:column;gap:0.85rem;">
        <div>
          <div class="mini-stat-label" style="font-size:0.65rem;margin-bottom:6px;">SPEECH RATE</div>
          <input type="range" min="0.5" max="2" step="0.1" value="0.95" id="rateSlider" style="width:100%;accent-color:var(--hud);" oninput="updateVoiceSettings()">
          <div style="display:flex;justify-content:space-between;font-size:0.6rem;color:var(--text2);margin-top:2px;font-family:'Share Tech Mono',monospace;"><span>0.5x</span><span id="rate-label">0.95x</span><span>2.0x</span></div>
        </div>
        <div>
          <div class="mini-stat-label" style="font-size:0.65rem;margin-bottom:6px;">PITCH</div>
          <input type="range" min="0.5" max="1.5" step="0.1" value="0.85" id="pitchSlider" style="width:100%;accent-color:var(--hud2);" oninput="updateVoiceSettings()">
          <div style="display:flex;justify-content:space-between;font-size:0.6rem;color:var(--text2);margin-top:2px;font-family:'Share Tech Mono',monospace;"><span>LOW</span><span id="pitch-label">0.85</span><span>HIGH</span></div>
        </div>
        <div>
          <div class="mini-stat-label" style="font-size:0.65rem;margin-bottom:6px;">VOICE PROFILE</div>
          <select id="voiceSelect" style="width:100%;background:rgba(0,0,0,0.4);border:1px solid var(--border);color:var(--text);padding:0.4rem;border-radius:4px;font-family:'Share Tech Mono',monospace;font-size:0.7rem;outline:none;">
            <option>Loading voices...</option>
          </select>
        </div>
        <button class="hud-btn" onclick="testVoice()" style="width:100%;">TEST VOICE OUTPUT</button>
      </div>
    </div>

    <!-- CAPABILITIES -->
    <div class="panel" style="flex:1;">
      <div class="corner-tl"></div><div class="corner-tr"></div>
      <div class="corner-bl"></div><div class="corner-br"></div>
      <div class="section-label">CAPABILITIES</div>
      <div style="display:flex;flex-direction:column;gap:0.5rem;">
        <div style="display:flex;align-items:center;gap:8px;font-size:0.78rem;"><span style="color:var(--hud3);">‚óâ</span><span style="color:var(--text2);">Voice recognition (STT)</span></div>
        <div style="display:flex;align-items:center;gap:8px;font-size:0.78rem;"><span style="color:var(--hud3);">‚óâ</span><span style="color:var(--text2);">Speech synthesis (TTS)</span></div>
        <div style="display:flex;align-items:center;gap:8px;font-size:0.78rem;"><span style="color:var(--hud3);">‚óâ</span><span style="color:var(--text2);">OpenAI GPT-4o brain (via API)</span></div>
        <div style="display:flex;align-items:center;gap:8px;font-size:0.78rem;"><span style="color:var(--hud3);">‚óâ</span><span style="color:var(--text2);">Conversation memory</span></div>
        <div style="display:flex;align-items:center;gap:8px;font-size:0.78rem;"><span style="color:var(--hud3);">‚óâ</span><span style="color:var(--text2);">Real-time voice visualization</span></div>
        <div style="display:flex;align-items:center;gap:8px;font-size:0.78rem;"><span style="color:var(--hud);">‚óé</span><span style="color:var(--text2);">Adjustable voice profile</span></div>
      </div>
      <div style="margin-top:1rem;padding:0.75rem;background:rgba(255,136,0,0.05);border:1px solid rgba(255,136,0,0.2);border-radius:4px;font-size:0.68rem;color:rgba(255,136,0,0.8);font-family:'Share Tech Mono',monospace;line-height:1.5;">
        ‚ö† Voice recognition requires microphone permission. Speak clearly for best results.
      </div>
    </div>

  </div>

  <!-- FOOTER -->
  <div class="footer">
    <span>STARK INDUSTRIES ¬∑ ADVANCED AI DIVISION ¬∑ CONFIDENTIAL</span>
    <span id="footer-status">SYSTEM NOMINAL ¬∑ ALL SUBSYSTEMS ONLINE</span>
    <span>BUILD 7.3.1-ALPHA ¬∑ <span id="session-id">SES-XXXX</span></span>
  </div>

</div>

<script>
// ==================== INIT ====================
const sessionId = 'SES-' + Math.random().toString(36).substr(2,6).toUpperCase();
document.getElementById('session-id').textContent = sessionId;

let conversationHistory = [];
let isListening = false;
let isSpeaking = false;
let isThinking = false;
let autoSpeak = true;
let totalOps = 0;
let recognition = null;
let currentUtterance = null;
let voiceList = [];
let currentMemFilter = 'all';

// ==================== PERSISTENT MEMORY ====================
const MEMORY_KEY = 'jarvis_memories';

function loadMemories() {
  try { return JSON.parse(localStorage.getItem(MEMORY_KEY)) || []; }
  catch(e) { return []; }
}

function saveMemoriesToStorage(mems) {
  localStorage.setItem(MEMORY_KEY, JSON.stringify(mems));
}

function saveMemory() {
  const input = document.getElementById('memInput');
  const text = input.value.trim();
  if(!text) return;

  // Auto-detect category from keywords
  let cat = 'general';
  const lower = text.toLowerCase();
  if(lower.includes('my name') || lower.includes('i am') || lower.includes('i like') || lower.includes('i live') || lower.includes('my ') || lower.includes('i\'m ') || lower.includes('im ')) cat = 'personal';
  else if(lower.includes('todo') || lower.includes('task') || lower.includes('remind') || lower.includes('need to') || lower.includes('must') || lower.includes('deadline') || lower.includes('meeting')) cat = 'task';
  else if(lower.includes('fact') || lower.includes('note') || lower.includes('remember that') || lower.includes('always') || lower.includes('never')) cat = 'fact';

  const mems = loadMemories();
  const entry = {
    id: Date.now(),
    text,
    cat,
    ts: new Date().toISOString(),
    tsLabel: new Date().toLocaleString()
  };
  mems.unshift(entry);
  saveMemoriesToStorage(mems);
  input.value = '';
  renderMemories();
  showNotif(`Memory saved: "${text.slice(0,40)}${text.length>40?'...':''}"`, 'hud3');
  speak(`Memory stored, sir. I'll remember that.`);
}

function deleteMemory(id) {
  const mems = loadMemories().filter(m => m.id !== id);
  saveMemoriesToStorage(mems);
  renderMemories();
  showNotif('Memory deleted.', 'orange');
}

function clearAllMemories() {
  if(!confirm('Wipe ALL memories from JARVIS? This cannot be undone.')) return;
  localStorage.removeItem(MEMORY_KEY);
  renderMemories();
  showNotif('All memories wiped, sir.', 'red');
  speak('All memories have been wiped, sir. Starting with a clean slate.');
}

function filterMemories(cat, btn) {
  currentMemFilter = cat;
  document.querySelectorAll('.mem-tab').forEach(t => t.classList.remove('active'));
  btn.classList.add('active');
  renderMemories();
}

function renderMemories() {
  const mems = loadMemories();
  const filtered = currentMemFilter === 'all' ? mems : mems.filter(m => m.cat === currentMemFilter);
  const list = document.getElementById('memory-list');
  document.getElementById('mem-count').textContent = mems.length + ' STORED';

  if(filtered.length === 0) {
    list.innerHTML = `<div style="color:var(--text2);font-size:0.72rem;font-family:'Share Tech Mono',monospace;padding:0.5rem;opacity:0.5;">No memories in this category.</div>`;
    return;
  }

  list.innerHTML = filtered.map(m => `
    <div class="memory-item" style="display:flex;align-items:flex-start;gap:4px;">
      <div style="flex:1;">
        <span class="mem-cat-badge cat-${m.cat}">${m.cat.toUpperCase()}</span>${escHtml(m.text)}
        <span class="memory-time">${m.tsLabel}</span>
      </div>
      <button class="mem-delete-btn" onclick="deleteMemory(${m.id})" title="Delete">‚úï</button>
    </div>
  `).join('');
}

function getMemoriesAsContext() {
  const mems = loadMemories();
  if(mems.length === 0) return '';
  return '\n\nPersistent Memory Vault (things the user has told you to remember across sessions):\n' +
    mems.slice(0, 30).map(m => `- [${m.cat.toUpperCase()}] ${m.text}`).join('\n');
}

// ==================== CLOCK ====================
function updateClock() {
  const now = new Date();
  const h = String(now.getHours()).padStart(2,'0');
  const m = String(now.getMinutes()).padStart(2,'0');
  const s = String(now.getSeconds()).padStart(2,'0');
  document.getElementById('clock').textContent = `${h}:${m}:${s}`;
  const days = ['SUNDAY','MONDAY','TUESDAY','WEDNESDAY','THURSDAY','FRIDAY','SATURDAY'];
  const months = ['JAN','FEB','MAR','APR','MAY','JUN','JUL','AUG','SEP','OCT','NOV','DEC'];
  document.getElementById('date-display').textContent =
    `${days[now.getDay()]} ¬∑ ${String(now.getDate()).padStart(2,'0')} ${months[now.getMonth()]} ${now.getFullYear()}`;
}
updateClock(); setInterval(updateClock, 1000);

// ==================== SYSTEM STATS ====================
function updateStats() {
  const cpu = 30 + Math.random() * 40;
  const mem = 50 + Math.random() * 30;
  document.getElementById('cpu-val').textContent = cpu.toFixed(1) + '%';
  document.getElementById('mem-val').textContent = mem.toFixed(1) + '%';
  document.getElementById('cpu-bar').style.width = cpu + '%';
  document.getElementById('mem-bar').style.width = mem + '%';
  document.getElementById('stat-ops').textContent = totalOps.toLocaleString();
}
setInterval(updateStats, 2000);
updateStats();

// ==================== WAVEFORM ====================
const waveformEl = document.getElementById('waveform');
const BARS = 40;
for(let i=0;i<BARS;i++){
  const b = document.createElement('div');
  b.className = 'wave-bar';
  waveformEl.appendChild(b);
}
function animateWave(active = false) {
  const bars = waveformEl.querySelectorAll('.wave-bar');
  bars.forEach((b,i) => {
    if(active) {
      const h = 4 + Math.random() * 32;
      b.style.height = h + 'px';
      b.classList.add('active');
    } else {
      b.style.height = '4px';
      b.classList.remove('active');
    }
  });
}
let waveInterval = null;
function startWave() { if(!waveInterval) waveInterval = setInterval(()=>animateWave(true), 80); }
function stopWave() { clearInterval(waveInterval); waveInterval = null; animateWave(false); }

// ==================== VOICE BARS ====================
const voiceBarsEl = document.getElementById('voiceBars');
for(let i=0;i<24;i++){
  const b = document.createElement('div');
  b.className = 'vbar';
  voiceBarsEl.appendChild(b);
}
function animateVoiceBars(speaking=false) {
  const bars = voiceBarsEl.querySelectorAll('.vbar');
  bars.forEach(b => {
    const h = speaking ? (8 + Math.random() * 50) : (2 + Math.random() * 8);
    b.style.height = h + 'px';
    b.style.opacity = speaking ? '0.9' : '0.2';
  });
}
let vbarInterval = null;
function startVBars() { if(!vbarInterval) vbarInterval = setInterval(()=>animateVoiceBars(true), 80); }
function stopVBars() { clearInterval(vbarInterval); vbarInterval = null; animateVoiceBars(false); }

// ==================== ARC STATE ====================
function setArcState(state) {
  const core = document.getElementById('arcCore');
  const icon = document.getElementById('arcIcon');
  const statusText = document.getElementById('arcStatusText');
  const modeEl = document.getElementById('stat-mode');
  core.className = 'arc-core';
  if(state === 'standby') {
    icon.textContent = '‚¨°'; statusText.textContent = 'CLICK TO SPEAK';
    modeEl.textContent = 'STANDBY';
  } else if(state === 'listening') {
    core.classList.add('listening'); icon.textContent = '‚óé';
    statusText.textContent = 'LISTENING...'; modeEl.textContent = 'LISTEN';
    startWave(); startVBars();
  } else if(state === 'thinking') {
    core.classList.add('thinking'); icon.textContent = '‚Üª';
    statusText.textContent = 'PROCESSING...'; modeEl.textContent = 'THINK';
    stopWave(); stopVBars();
  } else if(state === 'speaking') {
    core.classList.add('speaking'); icon.textContent = '‚óâ';
    statusText.textContent = 'SPEAKING...'; modeEl.textContent = 'SPEAK';
    startWave(); startVBars();
  }
}

// ==================== SPEECH SYNTHESIS ====================
function initVoices() {
  const voices = window.speechSynthesis.getVoices();
  if(voices.length === 0) { setTimeout(initVoices, 200); return; }
  voiceList = voices;
  const sel = document.getElementById('voiceSelect');
  sel.innerHTML = '';
  // Prefer English male voices
  const eng = voices.filter(v => v.lang.startsWith('en'));
  const preferred = eng.length > 0 ? eng : voices;
  preferred.forEach((v, i) => {
    const opt = document.createElement('option');
    opt.value = i;
    opt.textContent = v.name + (v.lang ? ` (${v.lang})` : '');
    sel.appendChild(opt);
  });
  // Try to pick a deep/male voice
  const maleVoice = preferred.findIndex(v =>
    v.name.toLowerCase().includes('male') ||
    v.name.toLowerCase().includes('david') ||
    v.name.toLowerCase().includes('mark') ||
    v.name.toLowerCase().includes('alex') ||
    v.name.toLowerCase().includes('daniel') ||
    v.name.toLowerCase().includes('james')
  );
  if(maleVoice >= 0) sel.value = maleVoice;
  document.getElementById('speech-stat').textContent = 'READY';
  document.getElementById('speech-stat').style.color = 'var(--hud3)';
  document.getElementById('speech-bar').style.width = '100%';
  showNotif('Speech synthesis online.', 'hud3');
}
window.speechSynthesis.onvoiceschanged = initVoices;
setTimeout(initVoices, 500);

function updateVoiceSettings() {
  const rate = document.getElementById('rateSlider').value;
  const pitch = document.getElementById('pitchSlider').value;
  document.getElementById('rate-label').textContent = rate + 'x';
  document.getElementById('pitch-label').textContent = pitch;
  document.getElementById('voice-rate').textContent = rate + 'x';
}

function speak(text) {
  if(!text || !autoSpeak) return;
  window.speechSynthesis.cancel();
  const utt = new SpeechSynthesisUtterance(text);
  const sel = document.getElementById('voiceSelect');
  const voices = window.speechSynthesis.getVoices().filter(v => v.lang.startsWith('en'));
  const allVoices = voices.length > 0 ? voices : window.speechSynthesis.getVoices();
  if(allVoices[sel.value]) utt.voice = allVoices[sel.value];
  utt.rate = parseFloat(document.getElementById('rateSlider').value);
  utt.pitch = parseFloat(document.getElementById('pitchSlider').value);
  utt.volume = 1;
  utt.onstart = () => { isSpeaking=true; setArcState('speaking'); startVBars(); };
  utt.onend = () => { isSpeaking=false; setArcState('standby'); stopVBars(); };
  utt.onerror = () => { isSpeaking=false; setArcState('standby'); stopVBars(); };
  currentUtterance = utt;
  window.speechSynthesis.speak(utt);
}

function testVoice() {
  speak("J.A.R.V.I.S. systems are fully operational. Voice synthesis confirmed. Ready to assist, sir.");
}

// ==================== SPEECH RECOGNITION ====================
function initRecognition() {
  if(!('webkitSpeechRecognition' in window) && !('SpeechRecognition' in window)) {
    showNotif('Speech recognition not supported in this browser.', 'red');
    document.getElementById('voiceBtn').style.display = 'none';
    return;
  }
  const SR = window.SpeechRecognition || window.webkitSpeechRecognition;
  recognition = new SR();
  recognition.continuous = false;
  recognition.interimResults = true;
  recognition.lang = 'en-US';
  recognition.onstart = () => {
    isListening = true; setArcState('listening');
    document.getElementById('voiceBtn').classList.add('active');
    document.getElementById('voiceBtn').textContent = 'üé§ STOP';
    document.getElementById('rec-accuracy').textContent = '--';
  };
  recognition.onresult = (e) => {
    let interim = '', final = '';
    for(let i=e.resultIndex;i<e.results.length;i++) {
      const t = e.results[i][0].transcript;
      if(e.results[i].isFinal) final += t;
      else interim += t;
    }
    const conf = e.results[e.results.length-1][0].confidence;
    if(conf) document.getElementById('rec-accuracy').textContent = (conf*100).toFixed(0)+'%';
    if(final) {
      document.getElementById('textInput').value = final;
      sendMessage(final);
    } else if(interim) {
      document.getElementById('textInput').value = interim + '...';
    }
  };
  recognition.onend = () => {
    isListening = false;
    document.getElementById('voiceBtn').classList.remove('active');
    document.getElementById('voiceBtn').textContent = 'üé§ VOICE';
    if(!isThinking) setArcState('standby');
    stopWave();
  };
  recognition.onerror = (e) => {
    isListening = false;
    document.getElementById('voiceBtn').classList.remove('active');
    document.getElementById('voiceBtn').textContent = 'üé§ VOICE';
    setArcState('standby'); stopWave();
    if(e.error !== 'no-speech') showNotif('Voice error: ' + e.error, 'red');
  };
}
initRecognition();

function toggleListen() {
  if(!recognition) { showNotif('Speech recognition unavailable.', 'red'); return; }
  if(isListening) { recognition.stop(); }
  else {
    if(isSpeaking) { window.speechSynthesis.cancel(); isSpeaking=false; stopVBars(); }
    try { recognition.start(); } catch(e) { console.log(e); }
  }
}

// ==================== AI BRAIN ====================
async function sendMessage(text) {
  if(!text || isThinking) return;
  document.getElementById('textInput').value = '';
  totalOps++;
  addMsg('user', text);
  conversationHistory.push({ role: 'user', content: text });
  isThinking = true;
  setArcState('thinking');
  showTyping();

  // Auto-detect "remember" commands ‚Üí save to vault instantly
  const rememberPatterns = [
    /^(?:please\s+)?remember\s+(?:that\s+)?(.+)/i,
    /^(?:please\s+)?save (?:this|that)?\s*(?:to (?:your\s+)?memory)?[:\s]+(.+)/i,
    /^(?:please\s+)?(?:add|store|keep)\s+(?:this\s+)?(?:to|in)\s+(?:your\s+)?memory[:\s]+(.+)/i,
    /^(?:please\s+)?don'?t forget\s+(?:that\s+)?(.+)/i,
  ];
  for(const pat of rememberPatterns) {
    const match = text.match(pat);
    if(match) {
      const memText = match[1].trim();
      const l = memText.toLowerCase();
      let cat = 'general';
      if(l.includes('my name') || l.includes('i am') || l.includes('i like') || l.includes('i live') || l.startsWith('i ') || l.includes('my ')) cat = 'personal';
      else if(l.includes('task') || l.includes('todo') || l.includes('remind') || l.includes('need to') || l.includes('must') || l.includes('deadline')) cat = 'task';
      else if(l.includes('fact') || l.includes('note') || l.includes('always') || l.includes('never') || l.includes('important')) cat = 'fact';
      const mems = loadMemories();
      mems.unshift({ id: Date.now(), text: memText, cat, ts: new Date().toISOString(), tsLabel: new Date().toLocaleString() });
      saveMemoriesToStorage(mems);
      renderMemories();
      showNotif(`Saved to Memory Vault: "${memText.slice(0,40)}${memText.length>40?'...':''}"`, 'hud3');
      break;
    }
  }

  const apiKey = localStorage.getItem('jarvis_openai_key');
  if(!apiKey) {
    removeTyping();
    isThinking = false;
    setArcState('standby');
    addMsg('system', 'No API key configured. Click the API KEY button below to enter your OpenAI key.');
    showApiKeyModal();
    return;
  }

  try {
    const memContext = getMemoriesAsContext();
    const systemPrompt = `You are J.A.R.V.I.S. ‚Äî a voice AI assistant. You speak OUT LOUD directly to the user, so keep every response SHORT and SPOKEN ‚Äî like a real conversation, not an essay. Maximum 2-3 sentences per reply. No paragraphs. No lists. No bullet points. No markdown. Just natural spoken words, direct and confident. If asked something complex, give the key answer in one punchy sentence, then offer to go deeper if they want. You have a dry British wit. Occasionally say "sir" or "boss". You are calm, precise, never over-explain. Think of how JARVIS speaks in Iron Man films ‚Äî short, smart, to the point. When the user asks you to remember something, confirm it in one sentence. Use stored memories naturally to personalise your replies.${memContext}`;

    const response = await fetch('https://api.openai.com/v1/chat/completions', {
      method: 'POST',
      headers: {
        'Content-Type': 'application/json',
        'Authorization': 'Bearer ' + apiKey
      },
      body: JSON.stringify({
        model: 'gpt-4o',
        max_tokens: 300,
        messages: [
          { role: 'system', content: systemPrompt },
          ...conversationHistory
        ]
      })
    });

    const data = await response.json();
    removeTyping();

    if(data.choices && data.choices[0]) {
      const reply = data.choices[0].message.content;
      conversationHistory.push({ role: 'assistant', content: reply });
      if(conversationHistory.length > 20) conversationHistory = conversationHistory.slice(-20);
      addMsg('jarvis', reply);
      isThinking = false;
      setArcState('standby');
      if(autoSpeak) speak(reply);
    } else {
      throw new Error(data.error?.message || 'Unknown error from OpenAI');
    }
  } catch(err) {
    removeTyping();
    isThinking = false;
    setArcState('standby');
    addMsg('system', 'ERROR: ' + err.message);
    addMsg('jarvis', 'I apologize, sir. I encountered a connectivity issue: ' + err.message);
    if(autoSpeak) speak('I apologize, sir. I encountered a connectivity issue.');
    console.error(err);
  }
}

function sendText() {
  const val = document.getElementById('textInput').value.trim();
  if(val) sendMessage(val);
}

function quickCmd(cmd) {
  document.getElementById('textInput').value = cmd;
  sendMessage(cmd);
}

// ==================== CHAT UI ====================
function addMsg(type, text) {
  const chatArea = document.getElementById('chatArea');
  const div = document.createElement('div');
  div.className = 'msg ' + type;
  const label = type === 'user' ? '‚ñ∏ YOU' : type === 'jarvis' ? '‚ñ∏ J.A.R.V.I.S' : '‚ñ∏ SYSTEM';
  div.innerHTML = `<span class="msg-label">${label}</span><span class="msg-text">${escHtml(text)}</span>`;
  chatArea.appendChild(div);
  chatArea.scrollTop = chatArea.scrollHeight;
}

function showTyping() {
  const chatArea = document.getElementById('chatArea');
  const div = document.createElement('div');
  div.id = 'typing-indicator';
  div.className = 'msg jarvis';
  div.innerHTML = `<span class="msg-label">‚ñ∏ J.A.R.V.I.S PROCESSING</span><div class="typing-indicator"><div class="typing-dot"></div><div class="typing-dot"></div><div class="typing-dot"></div></div>`;
  chatArea.appendChild(div);
  chatArea.scrollTop = chatArea.scrollHeight;
}

function removeTyping() {
  const t = document.getElementById('typing-indicator');
  if(t) t.remove();
}

function escHtml(str) {
  return str.replace(/&/g,'&amp;').replace(/</g,'&lt;').replace(/>/g,'&gt;').replace(/\n/g,'<br>');
}

function clearChat() {
  document.getElementById('chatArea').innerHTML = '';
  conversationHistory = [];
  addMsg('system', 'Conversation log cleared. Persistent memories retained in vault.');
  speak('Conversation log cleared, sir. Your memory vault remains intact.');
  totalOps++;
}

// ==================== CONTROLS ====================
function toggleAutoSpeak() {
  autoSpeak = !autoSpeak;
  const btn = document.getElementById('autoSpeakBtn');
  btn.textContent = `üîä AUTO-SPEAK: ${autoSpeak ? 'ON' : 'OFF'}`;
  if(!autoSpeak) window.speechSynthesis.cancel();
}

function emergencyStop() {
  window.speechSynthesis.cancel();
  if(recognition && isListening) recognition.stop();
  isListening = false; isSpeaking = false; isThinking = false;
  setArcState('standby'); stopWave(); stopVBars(); removeTyping();
  showNotif('EMERGENCY STOP ENGAGED. All processes halted.', 'red');
}

// ==================== NOTIFICATIONS ====================
function showNotif(msg, color='hud') {
  const container = document.getElementById('notif');
  const div = document.createElement('div');
  div.className = 'notif-item';
  div.style.borderLeftColor = `var(--${color})`;
  div.textContent = '‚ñ∏ ' + msg;
  container.appendChild(div);
  setTimeout(()=>{ div.style.opacity='0'; div.style.transition='opacity 0.5s'; setTimeout(()=>div.remove(),500); }, 3500);
}

// ==================== BOOT SEQUENCE ====================
renderMemories(); // Load saved memories on startup
const savedCount = loadMemories().length;
setTimeout(()=>{
  showNotif('J.A.R.V.I.S. systems online.', 'hud3');
  const memGreet = savedCount > 0
    ? `Good day, sir. All systems are fully operational. I have ${savedCount} stored ${savedCount===1?'memory':'memories'} in my vault. I am ready to assist.`
    : 'Good day, sir. All systems are fully operational. I am J.A.R.V.I.S. ‚Äî your personal AI assistant. You may speak to me by clicking the arc reactor, using the microphone button, or simply typing your query below. How may I assist you?';
  addMsg('jarvis', memGreet);
  if(autoSpeak) setTimeout(()=>{
    speak(savedCount > 0
      ? `Good day, sir. I have ${savedCount} stored ${savedCount===1?'memory':'memories'} ready. How may I assist you?`
      : 'Good day, sir. All systems are fully operational. I am J.A.R.V.I.S. How may I assist you today?');
  }, 800);
}, 1000);

setTimeout(()=>showNotif('Voice recognition initialized.', 'hud'), 1800);

// ==================== KEYBOARD SHORTCUT ====================
document.addEventListener('keydown', e => {
  if(e.key === 'Escape') emergencyStop();
  if(e.key === ' ' && e.target === document.body) { e.preventDefault(); toggleListen(); }
});

console.log('%cJ.A.R.V.I.S.', 'color:#00d4ff;font-size:28px;font-weight:900;font-family:monospace;');
console.log('%cJust A Rather Very Intelligent System ¬∑ v7.3.1', 'color:#00ffaa;font-size:12px;');
console.log('%c¬© Stark Industries Advanced AI Division', 'color:#666;font-size:10px;');
</script>

<!-- API KEY MODAL -->
<div id="apiModal" style="display:none;position:fixed;inset:0;z-index:99999;background:rgba(0,0,0,0.85);backdrop-filter:blur(8px);align-items:center;justify-content:center;">
  <div style="background:#010d1f;border:1px solid rgba(0,212,255,0.4);border-radius:8px;padding:2rem;max-width:480px;width:90%;box-shadow:0 0 60px rgba(0,212,255,0.2);">
    <div style="font-family:'Orbitron',monospace;font-size:1rem;color:#00d4ff;margin-bottom:0.5rem;letter-spacing:0.2em;">&#9881; OPENAI API KEY</div>
    <div style="font-family:'Share Tech Mono',monospace;font-size:0.7rem;color:rgba(0,212,255,0.55);margin-bottom:1.5rem;line-height:1.7;">
      Enter your OpenAI API key below. It's saved only in your browser's local storage
      and is sent directly to OpenAI ‚Äî never anywhere else.<br><br>
      &#9654; Get a key at:
      <a href="https://platform.openai.com/api-keys" target="_blank" style="color:#00d4ff;text-decoration:underline;">platform.openai.com/api-keys</a>
    </div>
    <input id="apiKeyInput" type="password" placeholder="sk-..." autocomplete="off"
      style="width:100%;background:rgba(0,0,0,0.5);border:1px solid rgba(0,212,255,0.3);border-radius:4px;padding:0.75rem 1rem;font-family:'Share Tech Mono',monospace;font-size:0.85rem;color:#c8eeff;outline:none;letter-spacing:0.05em;margin-bottom:1rem;"
      onkeydown="if(event.key==='Enter')saveApiKey()">
    <div style="display:flex;gap:0.75rem;">
      <button class="hud-btn" onclick="saveApiKey()" style="flex:1;">SAVE &amp; CONNECT</button>
      <button class="hud-btn danger" onclick="clearApiKey()" style="flex:1;">CLEAR KEY</button>
      <button class="hud-btn" onclick="closeApiModal()" style="padding:0.7rem 1rem;">&#10005;</button>
    </div>
    <div id="apiKeyStatus" style="margin-top:0.75rem;font-family:'Share Tech Mono',monospace;font-size:0.68rem;color:rgba(0,212,255,0.6);"></div>
  </div>
</div>

<script>
// ==================== API KEY MANAGEMENT ====================
function showApiKeyModal() {
  const modal = document.getElementById('apiModal');
  modal.style.display = 'flex';
  const existing = localStorage.getItem('jarvis_openai_key');
  const input = document.getElementById('apiKeyInput');
  const status = document.getElementById('apiKeyStatus');
  if(existing) {
    input.value = existing;
    status.textContent = '&#10003; Key loaded from storage. Edit and save to update.';
    status.style.color = 'rgba(0,255,170,0.7)';
  } else {
    input.value = '';
    status.textContent = 'No key saved yet.';
    status.style.color = 'rgba(0,212,255,0.5)';
  }
  setTimeout(()=>input.focus(), 100);
}

function closeApiModal() {
  document.getElementById('apiModal').style.display = 'none';
}

function saveApiKey() {
  const key = document.getElementById('apiKeyInput').value.trim();
  const status = document.getElementById('apiKeyStatus');
  if(!key) {
    status.textContent = '&#9888; Please enter a valid API key.';
    status.style.color = 'rgba(255,136,0,0.8)';
    return;
  }
  if(!key.startsWith('sk-')) {
    status.textContent = '&#9888; Key should start with "sk-". Double-check your key.';
    status.style.color = 'rgba(255,136,0,0.8)';
    return;
  }
  localStorage.setItem('jarvis_openai_key', key);
  status.textContent = '&#10003; API key saved successfully. JARVIS is ready, sir.';
  status.style.color = 'rgba(0,255,170,0.8)';
  showNotif('API key saved. J.A.R.V.I.S. connected to OpenAI.', 'hud3');
  setTimeout(closeApiModal, 1200);
}

function clearApiKey() {
  localStorage.removeItem('jarvis_openai_key');
  document.getElementById('apiKeyInput').value = '';
  const status = document.getElementById('apiKeyStatus');
  status.textContent = 'Key cleared.';
  status.style.color = 'rgba(255,51,51,0.7)';
  showNotif('API key removed.', 'red');
}

// Auto-show API key modal on first load if no key set
window.addEventListener('load', () => {
  if(!localStorage.getItem('jarvis_openai_key')) {
    setTimeout(showApiKeyModal, 1500);
  }
});
</script>


</body>
</html>
