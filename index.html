<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>J.A.R.V.I.S ‚Äî Just A Rather Very Intelligent System</title>
<link href="https://fonts.googleapis.com/css2?family=Rajdhani:wght@300;400;500;600;700&family=Orbitron:wght@400;500;600;700;900&family=Share+Tech+Mono&display=swap" rel="stylesheet">
<style>
  :root {
    --hud: #00d4ff;
    --hud2: #0066ff;
    --hud3: #00ffaa;
    --red: #ff3333;
    --orange: #ff8800;
    --bg: #010912;
    --panel: rgba(0,180,255,0.04);
    --border: rgba(0,212,255,0.2);
    --border2: rgba(0,212,255,0.5);
    --text: #c8eeff;
    --text2: rgba(0,212,255,0.6);
    --glow: 0 0 20px rgba(0,212,255,0.4), 0 0 60px rgba(0,212,255,0.1);
  }
  * { margin:0; padding:0; box-sizing:border-box; }
  body { font-family:'Rajdhani',sans-serif; background:var(--bg); color:var(--text); min-height:100vh; overflow-x:hidden; user-select:none; }
  body::before { content:''; position:fixed; inset:0; background:repeating-linear-gradient(0deg,transparent,transparent 2px,rgba(0,212,255,0.012) 2px,rgba(0,212,255,0.012) 4px); pointer-events:none; z-index:9999; }
  .grid-bg { position:fixed; inset:0; z-index:0; background-image:linear-gradient(rgba(0,212,255,0.04) 1px,transparent 1px),linear-gradient(90deg,rgba(0,212,255,0.04) 1px,transparent 1px); background-size:50px 50px; mask-image:radial-gradient(ellipse 80% 80% at 50% 50%,black,transparent); }
  .app { position:relative; z-index:1; min-height:100vh; display:grid; grid-template-rows:auto 1fr auto; grid-template-columns:280px 1fr 280px; gap:0; padding:1rem; }
  .panel { background:var(--panel); border:1px solid var(--border); border-radius:4px; padding:1rem; position:relative; overflow:hidden; }
  .panel::before { content:''; position:absolute; top:0; left:0; right:0; height:1px; background:linear-gradient(90deg,transparent,var(--hud),transparent); animation:scanH 3s linear infinite; }
  @keyframes scanH { 0%{transform:translateX(-100%)} 100%{transform:translateX(100%)} }
  .corner-tl,.corner-tr,.corner-bl,.corner-br { position:absolute; width:12px; height:12px; border-color:var(--hud); border-style:solid; }
  .corner-tl{top:0;left:0;border-width:2px 0 0 2px;} .corner-tr{top:0;right:0;border-width:2px 2px 0 0;} .corner-bl{bottom:0;left:0;border-width:0 0 2px 2px;} .corner-br{bottom:0;right:0;border-width:0 2px 2px 0;}
  .header { grid-column:1/-1; display:flex; align-items:center; justify-content:space-between; padding:0.75rem 1.5rem; border:1px solid var(--border); background:rgba(0,20,40,0.7); margin-bottom:1rem; position:relative; backdrop-filter:blur(10px); overflow:hidden; }
  .header::after { content:''; position:absolute; bottom:0; left:0; right:0; height:1px; background:linear-gradient(90deg,transparent,var(--hud),transparent); animation:scanH 4s linear infinite; }
  .header-logo { font-family:'Orbitron',monospace; font-size:1.4rem; font-weight:900; color:var(--hud); text-shadow:var(--glow); letter-spacing:0.2em; }
  .header-logo span { color:var(--hud3); font-size:0.65rem; display:block; letter-spacing:0.3em; margin-top:-2px; font-weight:400; }
  .header-status { display:flex; gap:2rem; align-items:center; }
  .status-item { display:flex; flex-direction:column; align-items:center; font-size:0.65rem; letter-spacing:0.1em; color:var(--text2); font-family:'Share Tech Mono',monospace; }
  .status-item .val { font-size:1rem; color:var(--hud3); font-weight:600; font-family:'Orbitron',monospace; }
  .header-time { font-family:'Orbitron',monospace; font-size:1.5rem; color:var(--hud); text-shadow:var(--glow); letter-spacing:0.1em; }
  .header-date { font-size:0.65rem; color:var(--text2); font-family:'Share Tech Mono',monospace; text-align:right; margin-top:2px; }
  .left-panel{grid-column:1;grid-row:2;display:flex;flex-direction:column;gap:1rem;padding-right:0.5rem;}
  .right-panel{grid-column:3;grid-row:2;display:flex;flex-direction:column;gap:1rem;padding-left:0.5rem;}
  .center{grid-column:2;grid-row:2;display:flex;flex-direction:column;align-items:center;justify-content:center;gap:1.5rem;padding:0 1rem;}
  .section-label { font-family:'Share Tech Mono',monospace; font-size:0.6rem; color:var(--text2); letter-spacing:0.2em; margin-bottom:0.75rem; display:flex; align-items:center; gap:0.5rem; }
  .section-label::before{content:'‚ñ∏';color:var(--hud);}
  .section-label::after{content:'';flex:1;height:1px;background:linear-gradient(to right,var(--border),transparent);}

  /* ARC REACTOR */
  .arc-container { position:relative; width:280px; height:280px; display:flex; align-items:center; justify-content:center; }
  .arc-ring { position:absolute; border-radius:50%; }
  .arc-ring-1 { width:280px; height:280px; border:1px solid rgba(0,212,255,0.12); animation:spinCW 25s linear infinite; }
  .arc-ring-2 { width:240px; height:240px; border:1px dashed rgba(0,212,255,0.18); animation:spinCCW 18s linear infinite; }
  .arc-ring-3 { width:200px; height:200px; border:1px solid rgba(0,212,255,0.25); animation:spinCW 12s linear infinite; }
  .arc-ring-4 { width:160px; height:160px; border:2px solid rgba(0,212,255,0.15); animation:spinCCW 8s linear infinite; }
  @keyframes spinCW{to{transform:rotate(360deg)}} @keyframes spinCCW{to{transform:rotate(-360deg)}}
  .tick-wrap { position:absolute; width:280px; height:280px; border-radius:50%; pointer-events:none; }
  .tick { position:absolute; width:1px; height:10px; background:rgba(0,212,255,0.45); left:calc(50% - 0.5px); top:0; transform-origin:50% 140px; }
  .tick.major { height:16px; width:2px; background:rgba(0,212,255,0.75); left:calc(50% - 1px); }
  .arc-core { width:126px; height:126px; border-radius:50%; background:radial-gradient(circle,rgba(0,180,255,0.18) 0%,rgba(0,100,200,0.08) 50%,transparent 70%); border:2px solid rgba(0,212,255,0.5); display:flex; align-items:center; justify-content:center; flex-direction:column; position:relative; cursor:pointer; transition:all 0.3s; box-shadow:0 0 30px rgba(0,212,255,0.25),inset 0 0 30px rgba(0,212,255,0.1); }
  .arc-core:hover { box-shadow:0 0 60px rgba(0,212,255,0.5),inset 0 0 40px rgba(0,212,255,0.2); }
  .arc-core.listening { border-color:var(--hud3); box-shadow:0 0 60px rgba(0,255,170,0.5),inset 0 0 40px rgba(0,255,170,0.15); animation:listenPulse 1s ease infinite; }
  .arc-core.speaking { border-color:var(--orange); box-shadow:0 0 60px rgba(255,136,0,0.5),inset 0 0 40px rgba(255,136,0,0.15); animation:speakPulse 0.35s ease infinite; }
  .arc-core.thinking { border-color:var(--hud2); box-shadow:0 0 60px rgba(0,102,255,0.5),inset 0 0 40px rgba(0,102,255,0.15); animation:thinkGlow 0.9s ease infinite alternate; }
  .arc-core.imaging { border-color:#aa44ff; box-shadow:0 0 60px rgba(170,68,255,0.5),inset 0 0 40px rgba(170,68,255,0.15); animation:thinkGlow 0.5s ease infinite alternate; }
  @keyframes listenPulse{0%,100%{transform:scale(1)}50%{transform:scale(1.06)}}
  @keyframes speakPulse{0%,100%{transform:scale(1)}50%{transform:scale(1.05)}}
  @keyframes thinkGlow{from{filter:brightness(1)}to{filter:brightness(1.4) hue-rotate(15deg)}}
  .reactor-glow { width:52px; height:52px; border-radius:50%; background:radial-gradient(circle,rgba(180,240,255,0.95) 0%,rgba(0,180,255,0.7) 35%,rgba(0,100,200,0.3) 65%,transparent 100%); box-shadow:0 0 20px rgba(0,200,255,0.9),0 0 50px rgba(0,150,255,0.5),0 0 80px rgba(0,100,255,0.2); animation:reactorPulse 2s ease infinite; }
  @keyframes reactorPulse{0%,100%{opacity:0.85;transform:scale(1)}50%{opacity:1;transform:scale(1.1)}}
  .arc-status-text { position:absolute; bottom:-30px; font-family:'Share Tech Mono',monospace; font-size:0.65rem; color:var(--hud); letter-spacing:0.2em; text-shadow:var(--glow); white-space:nowrap; }
  .waveform-container { width:100%; display:flex; align-items:center; justify-content:center; gap:2px; height:40px; }
  .wave-bar { width:2px; background:linear-gradient(to top,var(--hud2),var(--hud)); border-radius:1px; opacity:0.25; height:3px; transition:height 0.08s,opacity 0.08s; }
  .wave-bar.active{opacity:1;}
  .chat-area { width:100%; max-width:640px; height:260px; overflow-y:auto; display:flex; flex-direction:column; gap:0.75rem; padding:1rem; background:rgba(0,0,0,0.35); border:1px solid var(--border); border-radius:4px; }
  .chat-area::-webkit-scrollbar{width:3px;} .chat-area::-webkit-scrollbar-thumb{background:var(--border2);border-radius:99px;}
  .msg { display:flex; flex-direction:column; gap:2px; animation:msgIn 0.3s ease both; }
  @keyframes msgIn{from{opacity:0;transform:translateY(8px)}to{opacity:1;transform:translateY(0)}}
  .msg-label { font-family:'Share Tech Mono',monospace; font-size:0.58rem; letter-spacing:0.2em; text-transform:uppercase; }
  .msg.user .msg-label{color:var(--hud3);} .msg.jarvis .msg-label{color:var(--hud);} .msg.system .msg-label{color:var(--orange);}
  .msg-text{font-size:0.95rem;line-height:1.5;font-weight:400;}
  .msg.user .msg-text{color:rgba(0,255,170,0.9);} .msg.jarvis .msg-text{color:var(--text);} .msg.system .msg-text{color:rgba(255,136,0,0.8);font-size:0.8rem;font-family:'Share Tech Mono',monospace;letter-spacing:0.05em;}
  .msg-img-wrap{position:relative;display:inline-block;margin-top:8px;border:1px solid var(--border2);border-radius:4px;overflow:hidden;}
  .msg-img-wrap::before{content:attr(data-label);position:absolute;top:0;left:0;right:0;font-family:'Share Tech Mono',monospace;font-size:0.52rem;color:var(--hud);background:rgba(0,10,20,0.85);padding:3px 8px;letter-spacing:0.15em;z-index:1;}
  .msg-img-wrap img{display:block;max-width:300px;max-height:220px;object-fit:contain;margin-top:20px;box-shadow:var(--glow);}
  .msg-img-wrap.generated img{max-width:320px;max-height:320px;}
  .img-gen-progress{display:flex;align-items:center;gap:8px;padding:8px 0;font-family:'Share Tech Mono',monospace;font-size:0.7rem;color:var(--hud2);}
  .img-gen-spinner{width:14px;height:14px;border:2px solid rgba(0,102,255,0.3);border-top-color:var(--hud2);border-radius:50%;animation:spinnerAnim 0.8s linear infinite;}
  @keyframes spinnerAnim{to{transform:rotate(360deg)}}
  .typing-indicator{display:flex;gap:4px;align-items:center;padding:4px 0;}
  .typing-dot{width:5px;height:5px;background:var(--hud);border-radius:50%;animation:typingDot 1.2s ease infinite;}
  .typing-dot:nth-child(2){animation-delay:0.2s;} .typing-dot:nth-child(3){animation-delay:0.4s;}
  @keyframes typingDot{0%,60%,100%{opacity:0.2;transform:scale(0.8)}30%{opacity:1;transform:scale(1)}}
  .img-preview-bar{display:none;align-items:center;gap:0.75rem;width:100%;max-width:640px;padding:0.45rem 0.75rem;background:rgba(0,255,170,0.04);border:1px solid rgba(0,255,170,0.25);border-radius:4px;font-family:'Share Tech Mono',monospace;font-size:0.65rem;color:var(--hud3);letter-spacing:0.1em;}
  .img-preview-bar.visible{display:flex;}
  .img-preview-thumb{width:36px;height:36px;object-fit:cover;border:1px solid rgba(0,255,170,0.4);border-radius:3px;}
  .img-preview-name{flex:1;overflow:hidden;text-overflow:ellipsis;white-space:nowrap;}
  .img-preview-clear{background:none;border:none;color:var(--red);cursor:pointer;font-size:1rem;padding:0 4px;line-height:1;}
  .input-row{display:flex;gap:0.6rem;align-items:center;width:100%;max-width:640px;}
  .text-input{flex:1;background:rgba(0,0,0,0.4);border:1px solid var(--border);border-radius:4px;padding:0.75rem 1rem;font-family:'Rajdhani',sans-serif;font-size:0.95rem;color:var(--text);outline:none;transition:border-color 0.2s,box-shadow 0.2s;letter-spacing:0.02em;}
  .text-input:focus{border-color:var(--border2);box-shadow:var(--glow);}
  .text-input::placeholder{color:rgba(0,212,255,0.25);font-size:0.85rem;letter-spacing:0.1em;}
  .hud-btn{background:rgba(0,212,255,0.08);border:1px solid var(--border);color:var(--hud);border-radius:4px;padding:0.7rem 1.2rem;font-family:'Share Tech Mono',monospace;font-size:0.75rem;cursor:pointer;letter-spacing:0.1em;transition:all 0.2s;white-space:nowrap;}
  .hud-btn:hover{background:rgba(0,212,255,0.15);border-color:var(--border2);box-shadow:var(--glow);}
  .hud-btn.active{background:rgba(0,255,170,0.1);border-color:rgba(0,255,170,0.5);color:var(--hud3);}
  .hud-btn.danger{border-color:rgba(255,51,51,0.4);color:var(--red);}
  .hud-btn.danger:hover{background:rgba(255,51,51,0.1);}
  .img-attach-btn{background:rgba(0,255,170,0.06);border:1px solid rgba(0,255,170,0.25);color:var(--hud3);border-radius:4px;padding:0.7rem 0.85rem;font-size:1rem;cursor:pointer;transition:all 0.2s;line-height:1;display:flex;align-items:center;justify-content:center;}
  .img-attach-btn:hover{background:rgba(0,255,170,0.15);border-color:rgba(0,255,170,0.5);}
  .img-attach-btn.has-image{background:rgba(0,255,170,0.15);border-color:rgba(0,255,170,0.6);}
  .mini-stat{display:flex;justify-content:space-between;align-items:center;padding:0.5rem 0;border-bottom:1px solid rgba(0,212,255,0.07);font-size:0.8rem;}
  .mini-stat:last-child{border-bottom:none;}
  .mini-stat-label{color:var(--text2);letter-spacing:0.05em;}
  .mini-stat-val{font-family:'Orbitron',monospace;font-size:0.75rem;color:var(--hud3);}
  .bar-track{height:4px;background:rgba(255,255,255,0.06);border-radius:99px;margin-top:4px;overflow:hidden;}
  .bar-fill{height:100%;border-radius:99px;background:linear-gradient(90deg,var(--hud2),var(--hud));position:relative;}
  .bar-fill::after{content:'';position:absolute;right:0;top:0;bottom:0;width:4px;background:white;border-radius:99px;box-shadow:0 0 8px white;}
  .memory-item{padding:0.4rem 0.6rem;background:rgba(0,212,255,0.04);border:1px solid rgba(0,212,255,0.08);border-left:2px solid var(--hud);border-radius:2px;font-size:0.72rem;color:var(--text2);margin-bottom:0.4rem;line-height:1.4;letter-spacing:0.02em;cursor:pointer;transition:background 0.2s;}
  .memory-item:hover{background:rgba(0,212,255,0.08);color:var(--text);}
  .memory-time{font-family:'Share Tech Mono',monospace;font-size:0.55rem;color:var(--text2);opacity:0.5;display:block;margin-top:2px;}
  .mem-tab{background:rgba(0,212,255,0.04);border:1px solid var(--border);color:var(--text2);border-radius:3px;padding:0.2rem 0.5rem;font-family:'Share Tech Mono',monospace;font-size:0.58rem;cursor:pointer;letter-spacing:0.08em;transition:all 0.2s;}
  .mem-tab:hover,.mem-tab.active{background:rgba(0,212,255,0.15);color:var(--hud);border-color:var(--border2);}
  .mem-delete-btn{margin-left:auto;background:none;border:none;color:rgba(255,51,51,0.4);cursor:pointer;font-size:0.7rem;padding:0 2px;line-height:1;transition:color 0.2s;}
  .mem-delete-btn:hover{color:var(--red);}
  .mem-cat-badge{font-family:'Share Tech Mono',monospace;font-size:0.52rem;padding:0.1rem 0.35rem;border-radius:2px;letter-spacing:0.05em;margin-right:4px;}
  .cat-personal{background:rgba(124,58,237,0.2);color:#a78bfa;} .cat-task{background:rgba(255,136,0,0.15);color:var(--orange);} .cat-fact{background:rgba(0,212,255,0.1);color:var(--hud);} .cat-general{background:rgba(255,255,255,0.05);color:var(--text2);}
  .voice-bars{display:flex;gap:2px;align-items:flex-end;height:60px;padding:0 4px;}
  .vbar{flex:1;background:linear-gradient(to top,var(--hud2),var(--hud));border-radius:1px 1px 0 0;height:4px;transition:height 0.08s;opacity:0.6;}
  .quick-cmd{display:flex;align-items:center;gap:8px;padding:0.5rem 0.6rem;background:rgba(0,212,255,0.04);border:1px solid var(--border);border-radius:4px;cursor:pointer;transition:all 0.2s;font-size:0.78rem;letter-spacing:0.02em;color:var(--text2);}
  .quick-cmd:hover{background:rgba(0,212,255,0.1);color:var(--text);border-color:var(--border2);}
  .quick-cmd .qicon{color:var(--hud);font-size:0.9rem;}
  .history-item{padding:0.35rem 0.55rem;background:rgba(0,0,0,0.25);border:1px solid rgba(0,212,255,0.07);border-radius:2px;font-size:0.68rem;color:var(--text2);margin-bottom:0.3rem;cursor:pointer;transition:all 0.2s;display:flex;align-items:center;gap:6px;}
  .history-item:hover{background:rgba(0,212,255,0.08);color:var(--text);border-color:var(--border);}
  .hi-time{font-family:'Share Tech Mono',monospace;font-size:0.5rem;opacity:0.5;white-space:nowrap;}
  .hi-text{flex:1;overflow:hidden;text-overflow:ellipsis;white-space:nowrap;}
  .launch-overlay{display:none;position:fixed;inset:0;z-index:99998;background:rgba(0,0,0,0.88);backdrop-filter:blur(10px);align-items:center;justify-content:center;flex-direction:column;gap:1.5rem;}
  .launch-overlay.visible{display:flex;}
  .launch-box{background:rgba(0,10,25,0.98);border:1px solid rgba(0,212,255,0.5);border-radius:4px;padding:2rem 3rem;text-align:center;box-shadow:0 0 80px rgba(0,180,255,0.2);}
  .launch-title{font-family:'Orbitron',monospace;font-size:0.8rem;color:var(--hud);letter-spacing:0.3em;margin-bottom:1rem;}
  .launch-target{font-family:'Share Tech Mono',monospace;font-size:1.1rem;color:var(--hud3);letter-spacing:0.15em;margin-bottom:1.5rem;text-shadow:0 0 10px rgba(0,255,170,0.5);}
  .launch-bar-track{width:280px;height:3px;background:rgba(0,212,255,0.1);border-radius:99px;overflow:hidden;}
  .launch-bar-fill{height:100%;background:linear-gradient(90deg,var(--hud2),var(--hud));border-radius:99px;animation:launchFill 1.5s ease-out forwards;}
  @keyframes launchFill{from{width:0}to{width:100%}}
  .launch-status{font-family:'Share Tech Mono',monospace;font-size:0.6rem;color:var(--text2);letter-spacing:0.2em;margin-top:0.75rem;}
  .footer{grid-column:1/-1;margin-top:1rem;border:1px solid var(--border);padding:0.5rem 1.5rem;display:flex;justify-content:space-between;align-items:center;background:rgba(0,20,40,0.4);font-family:'Share Tech Mono',monospace;font-size:0.6rem;color:var(--text2);letter-spacing:0.1em;}
  #notif{position:fixed;top:1rem;right:1rem;z-index:9000;display:flex;flex-direction:column;gap:0.5rem;}
  .notif-item{background:rgba(0,20,40,0.95);border:1px solid var(--border2);border-left:3px solid var(--hud);padding:0.6rem 1rem;border-radius:4px;font-family:'Share Tech Mono',monospace;font-size:0.7rem;color:var(--text);animation:notifIn 0.3s ease both;backdrop-filter:blur(10px);max-width:300px;}
  @keyframes notifIn{from{opacity:0;transform:translateX(20px)}to{opacity:1;transform:translateX(0)}}
  @keyframes borderGlow{0%,100%{box-shadow:0 0 10px rgba(0,212,255,0.2)}50%{box-shadow:0 0 30px rgba(0,212,255,0.5)}}
  .glowing{animation:borderGlow 3s ease infinite;}
  ::-webkit-scrollbar{width:4px;} ::-webkit-scrollbar-track{background:transparent;} ::-webkit-scrollbar-thumb{background:var(--border);border-radius:99px;}
  .modal-overlay{display:none;position:fixed;inset:0;z-index:99999;background:rgba(0,0,0,0.88);backdrop-filter:blur(8px);align-items:center;justify-content:center;}
  .modal-overlay.visible{display:flex;}
  .modal-box{background:#010d1f;border:1px solid rgba(0,212,255,0.4);border-radius:8px;padding:2rem;max-width:480px;width:90%;box-shadow:0 0 60px rgba(0,212,255,0.2);}
</style>
</head>
<body>
<div class="grid-bg"></div>

<div class="launch-overlay" id="launchOverlay">
  <div class="launch-box">
    <div class="corner-tl"></div><div class="corner-tr"></div><div class="corner-bl"></div><div class="corner-br"></div>
    <div class="launch-title">‚ñ∏ INITIATING TARGET LINK</div>
    <div class="launch-target" id="launchTarget">TARGET</div>
    <div class="launch-bar-track"><div class="launch-bar-fill" id="launchBarFill"></div></div>
    <div class="launch-status" id="launchStatus">ESTABLISHING CONNECTION...</div>
  </div>
</div>

<div class="modal-overlay" id="apiModal">
  <div class="modal-box">
    <div class="corner-tl"></div><div class="corner-tr"></div><div class="corner-bl"></div><div class="corner-br"></div>
    <div style="font-family:'Orbitron',monospace;font-size:1rem;color:var(--hud);margin-bottom:0.5rem;letter-spacing:0.2em;">‚öô OPENAI API KEY</div>
    <div style="font-family:'Share Tech Mono',monospace;font-size:0.7rem;color:rgba(0,212,255,0.55);margin-bottom:1.5rem;line-height:1.7;">
      Required for <b style="color:var(--hud3)">image analysis</b> (GPT-4o) and <b style="color:var(--hud3)">image generation</b> (DALL-E 3).<br>
      AI chat uses Cohere ‚Äî no key needed.<br>
      Key stored locally in your browser only.<br><br>
      ‚ñ∏ <a href="https://platform.openai.com/api-keys" target="_blank" style="color:var(--hud);text-decoration:underline;">platform.openai.com/api-keys</a>
    </div>
    <input id="apiKeyInput" type="password" placeholder="sk-..." autocomplete="off"
      style="width:100%;background:rgba(0,0,0,0.5);border:1px solid rgba(0,212,255,0.3);border-radius:4px;padding:0.75rem 1rem;font-family:'Share Tech Mono',monospace;font-size:0.85rem;color:var(--hud3);outline:none;letter-spacing:0.05em;margin-bottom:1rem;"
      onkeydown="if(event.key==='Enter')saveApiKey()">
    <div style="display:flex;gap:0.75rem;">
      <button class="hud-btn" onclick="saveApiKey()" style="flex:1;">SAVE & CONNECT</button>
      <button class="hud-btn danger" onclick="clearApiKey()" style="flex:1;">CLEAR KEY</button>
      <button class="hud-btn" onclick="closeApiModal()" style="padding:0.7rem 1rem;">‚úï</button>
    </div>
    <div id="apiKeyStatus" style="margin-top:0.75rem;font-family:'Share Tech Mono',monospace;font-size:0.68rem;color:rgba(0,212,255,0.6);"></div>
  </div>
</div>

<div id="notif"></div>

<div class="app">
  <div class="header glowing">
    <div class="corner-tl"></div><div class="corner-tr"></div><div class="corner-bl"></div><div class="corner-br"></div>
    <div class="header-logo">J.A.R.V.I.S<span>JUST A RATHER VERY INTELLIGENT SYSTEM ¬∑ v9.0.0</span></div>
    <div class="header-status">
      <div class="status-item"><span class="val" id="stat-ops">0</span>OPERATIONS</div>
      <div class="status-item"><span class="val" id="stat-uptime">100%</span>UPTIME</div>
      <div class="status-item"><span class="val" id="stat-mode">STANDBY</span>MODE</div>
    </div>
    <div>
      <div class="header-time" id="clock">00:00:00</div>
      <div class="header-date" id="date-display">LOADING...</div>
    </div>
  </div>

  <div class="left-panel">
    <div class="panel">
      <div class="corner-tl"></div><div class="corner-tr"></div><div class="corner-bl"></div><div class="corner-br"></div>
      <div class="section-label">SYSTEM DIAGNOSTICS</div>
      <div class="mini-stat"><span class="mini-stat-label">CPU CORE</span><span class="mini-stat-val" id="cpu-val">--</span></div>
      <div class="bar-track"><div class="bar-fill" id="cpu-bar" style="width:45%"></div></div>
      <div style="height:10px"></div>
      <div class="mini-stat"><span class="mini-stat-label">MEMORY</span><span class="mini-stat-val" id="mem-val">--</span></div>
      <div class="bar-track"><div class="bar-fill" id="mem-bar" style="width:62%;background:linear-gradient(90deg,#7c3aed,#a78bfa)"></div></div>
      <div style="height:10px"></div>
      <div class="mini-stat"><span class="mini-stat-label">AI ENGINE (COHERE)</span><span class="mini-stat-val" style="color:var(--hud3)">ONLINE</span></div>
      <div class="bar-track"><div class="bar-fill" style="width:100%;background:linear-gradient(90deg,#10b981,#00ffaa)"></div></div>
      <div style="height:10px"></div>
      <div class="mini-stat"><span class="mini-stat-label">SPEECH SYS</span><span class="mini-stat-val" id="speech-stat" style="color:var(--orange)">INIT</span></div>
      <div class="bar-track"><div class="bar-fill" id="speech-bar" style="width:0%;background:linear-gradient(90deg,var(--orange),#ffbb00)"></div></div>
      <div style="height:10px"></div>
      <div class="mini-stat"><span class="mini-stat-label">VISION SYS</span><span class="mini-stat-val" style="color:var(--hud3)">ONLINE</span></div>
      <div class="bar-track"><div class="bar-fill" style="width:100%;background:linear-gradient(90deg,#0066ff,#00d4ff)"></div></div>
    </div>

    <div class="panel" style="flex:1;overflow:hidden;display:flex;flex-direction:column;">
      <div class="corner-tl"></div><div class="corner-tr"></div><div class="corner-bl"></div><div class="corner-br"></div>
      <div class="section-label">MEMORY VAULT <span id="mem-count" style="color:var(--hud3);margin-left:4px;font-size:0.6rem;">0 STORED</span></div>
      <div style="display:flex;gap:0.4rem;margin-bottom:0.6rem;">
        <input id="memInput" placeholder="Save something for JARVIS to remember..." style="flex:1;background:rgba(0,0,0,0.4);border:1px solid var(--border);border-radius:3px;padding:0.4rem 0.6rem;font-family:'Rajdhani',sans-serif;font-size:0.78rem;color:var(--text);outline:none;" onkeydown="if(event.key==='Enter')saveMemory()">
        <button class="hud-btn" onclick="saveMemory()" style="padding:0.4rem 0.6rem;font-size:0.65rem;">SAVE</button>
      </div>
      <div style="display:flex;gap:0.3rem;margin-bottom:0.6rem;flex-wrap:wrap;">
        <button class="mem-tab active" onclick="filterMemories('all',this)">ALL</button>
        <button class="mem-tab" onclick="filterMemories('personal',this)">PERSONAL</button>
        <button class="mem-tab" onclick="filterMemories('task',this)">TASKS</button>
        <button class="mem-tab" onclick="filterMemories('fact',this)">FACTS</button>
      </div>
      <div id="memory-list" style="flex:1;overflow-y:auto;"></div>
      <button class="hud-btn danger" onclick="clearAllMemories()" style="width:100%;margin-top:0.5rem;font-size:0.65rem;">‚ö† WIPE ALL MEMORIES</button>
    </div>

    <div class="panel">
      <div class="corner-tl"></div><div class="corner-tr"></div><div class="corner-bl"></div><div class="corner-br"></div>
      <div class="section-label">QUICK COMMANDS</div>
      <div style="display:flex;flex-direction:column;gap:0.4rem;">
        <div class="quick-cmd" onclick="quickCmd('open youtube')"><span class="qicon">‚ñ∂</span>OPEN YOUTUBE</div>
        <div class="quick-cmd" onclick="quickCmd('play lofi hip hop music')"><span class="qicon">üéµ</span>PLAY LOFI MUSIC</div>
        <div class="quick-cmd" onclick="quickCmd('open google')"><span class="qicon">üåê</span>OPEN GOOGLE</div>
        <div class="quick-cmd" onclick="quickCmd('Generate an image of the Iron Man suit glowing in a futuristic Stark Industries lab.')"><span class="qicon">üñºÔ∏è</span>GENERATE IMAGE</div>
        <div class="quick-cmd" onclick="quickCmd('Tell me something fascinating about artificial intelligence.')"><span class="qicon">üß†</span>AI BRIEFING</div>
        <div class="quick-cmd" onclick="quickCmd('Give me a motivational speech in the style of Tony Stark.')"><span class="qicon">üéØ</span>TONY STARK MODE</div>
      </div>
    </div>
  </div>

  <div class="center">
    <div class="arc-container">
      <div class="tick-wrap" id="tickWrap"></div>
      <div class="arc-ring arc-ring-1"></div>
      <div class="arc-ring arc-ring-2"></div>
      <div class="arc-ring arc-ring-3"></div>
      <div class="arc-ring arc-ring-4"></div>
      <div style="position:absolute;width:280px;height:280px;border-radius:50%;animation:spinCW 25s linear infinite;">
        <div style="position:absolute;width:6px;height:6px;border-radius:50%;background:var(--hud);box-shadow:0 0 10px var(--hud),0 0 20px var(--hud);top:-3px;left:calc(50% - 3px);"></div>
      </div>
      <div style="position:absolute;width:200px;height:200px;border-radius:50%;animation:spinCW 12s linear infinite;">
        <div style="position:absolute;width:5px;height:5px;border-radius:50%;background:var(--hud3);box-shadow:0 0 8px var(--hud3),0 0 16px var(--hud3);top:-2.5px;left:calc(50% - 2.5px);"></div>
      </div>
      <div class="arc-core" id="arcCore" onclick="toggleListen()">
        <div class="reactor-glow"></div>
        <div class="arc-status-text" id="arcStatusText">CLICK TO SPEAK</div>
      </div>
    </div>

    <div class="waveform-container" id="waveform"></div>

    <div class="chat-area" id="chatArea">
      <div class="msg system">
        <span class="msg-label">‚ñ∏ SYSTEM BOOT</span>
        <span class="msg-text">J.A.R.V.I.S online. All modules operational. Good day, sir.</span>
      </div>
    </div>

    <div class="img-preview-bar" id="imgPreviewBar">
      <img id="imgPreviewThumb" class="img-preview-thumb" src="" alt="">
      <span class="img-preview-name" id="imgPreviewName">image.png</span>
      <span style="font-size:0.6rem;color:var(--text2);">READY TO ANALYZE</span>
      <button class="img-preview-clear" onclick="clearAttachedImage()">‚úï</button>
    </div>

    <div class="input-row">
      <button class="img-attach-btn" id="imgAttachBtn" onclick="document.getElementById('imgFileInput').click()" title="Attach image">üìé</button>
      <input type="file" id="imgFileInput" accept="image/*" style="display:none" onchange="handleImageAttach(event)">
      <input class="text-input" id="textInput" placeholder='Try: "open youtube" ¬∑ "play [song]" ¬∑ "generate image of..."' onkeydown="if(event.key==='Enter')sendText()" autocomplete="off">
      <button class="hud-btn" onclick="sendText()">SEND</button>
      <button class="hud-btn" id="voiceBtn" onclick="toggleListen()">üé§ VOICE</button>
    </div>

    <div style="display:flex;gap:0.75rem;flex-wrap:wrap;justify-content:center;">
      <button class="hud-btn" onclick="clearChat()">CLEAR LOG</button>
      <button class="hud-btn" id="autoSpeakBtn" onclick="toggleAutoSpeak()">üîä AUTO-SPEAK: ON</button>
      <button class="hud-btn" onclick="showApiKeyModal()">üîë OPENAI KEY</button>
      <button class="hud-btn danger" onclick="emergencyStop()">‚ñ† STOP</button>
    </div>
  </div>

  <div class="right-panel">
    <div class="panel">
      <div class="corner-tl"></div><div class="corner-tr"></div><div class="corner-bl"></div><div class="corner-br"></div>
      <div class="section-label">VOICE ANALYZER</div>
      <div class="voice-bars" id="voiceBars"></div>
      <div style="margin-top:0.75rem;display:grid;grid-template-columns:1fr 1fr;gap:0.5rem;">
        <div style="display:flex;flex-direction:column;gap:2px;"><span class="mini-stat-label" style="font-size:0.58rem;">RECOGNITION</span><span class="mini-stat-val" id="rec-accuracy">--</span></div>
        <div style="display:flex;flex-direction:column;gap:2px;"><span class="mini-stat-label" style="font-size:0.58rem;">VOICE RATE</span><span class="mini-stat-val" id="voice-rate" style="color:var(--hud2)">0.88x</span></div>
      </div>
      <div style="margin-top:0.6rem;padding:0.5rem;background:rgba(0,212,255,0.04);border:1px solid rgba(0,212,255,0.1);border-radius:3px;font-family:'Share Tech Mono',monospace;font-size:0.58rem;color:var(--text2);line-height:1.6;">
        üá¨üáß <b style="color:var(--hud)">Best JARVIS voice:</b> Use <b style="color:var(--hud3)">Microsoft Edge</b> browser ‚Äî unlocks "Ryan (Natural) UK" neural voice
      </div>
    </div>

    <div class="panel">
      <div class="corner-tl"></div><div class="corner-tr"></div><div class="corner-bl"></div><div class="corner-br"></div>
      <div class="section-label">VOICE SETTINGS</div>
      <div style="display:flex;flex-direction:column;gap:0.85rem;">
        <div>
          <div class="mini-stat-label" style="font-size:0.65rem;margin-bottom:6px;">SPEECH RATE</div>
          <input type="range" min="0.5" max="1.8" step="0.05" value="0.88" id="rateSlider" style="width:100%;accent-color:var(--hud);" oninput="updateVoiceSettings()">
          <div style="display:flex;justify-content:space-between;font-size:0.6rem;color:var(--text2);margin-top:2px;font-family:'Share Tech Mono',monospace;"><span>0.5x</span><span id="rate-label">0.88x</span><span>1.8x</span></div>
        </div>
        <div>
          <div class="mini-stat-label" style="font-size:0.65rem;margin-bottom:6px;">PITCH</div>
          <input type="range" min="0.5" max="1.4" step="0.05" value="0.82" id="pitchSlider" style="width:100%;accent-color:var(--hud2);" oninput="updateVoiceSettings()">
          <div style="display:flex;justify-content:space-between;font-size:0.6rem;color:var(--text2);margin-top:2px;font-family:'Share Tech Mono',monospace;"><span>LOW</span><span id="pitch-label">0.82</span><span>HIGH</span></div>
        </div>
        <div>
          <div class="mini-stat-label" style="font-size:0.65rem;margin-bottom:6px;">VOICE PROFILE</div>
          <select id="voiceSelect" style="width:100%;background:rgba(0,0,0,0.4);border:1px solid var(--border);color:var(--text);padding:0.4rem;border-radius:4px;font-family:'Share Tech Mono',monospace;font-size:0.65rem;outline:none;" onchange="onVoiceChange()"><option>Detecting...</option></select>
        </div>
        <button class="hud-btn" onclick="testVoice()" style="width:100%;">‚ñ∂ TEST JARVIS VOICE</button>
      </div>
    </div>

    <div class="panel" style="flex:1;overflow:hidden;display:flex;flex-direction:column;">
      <div class="corner-tl"></div><div class="corner-tr"></div><div class="corner-bl"></div><div class="corner-br"></div>
      <div class="section-label">CHAT HISTORY <span id="hist-count" style="color:var(--hud3);margin-left:4px;font-size:0.58rem;">0</span></div>
      <div id="history-list" style="flex:1;overflow-y:auto;"></div>
      <button class="hud-btn danger" onclick="clearHistory()" style="width:100%;margin-top:0.5rem;font-size:0.65rem;">‚ö† WIPE HISTORY</button>
    </div>

    <div class="panel">
      <div class="corner-tl"></div><div class="corner-tr"></div><div class="corner-bl"></div><div class="corner-br"></div>
      <div class="section-label">CAPABILITIES</div>
      <div style="display:flex;flex-direction:column;gap:0.45rem;font-size:0.76rem;">
        <div style="display:flex;align-items:center;gap:8px;"><span style="color:var(--hud3);">‚óâ</span><span style="color:var(--text2);">Voice recognition (STT)</span></div>
        <div style="display:flex;align-items:center;gap:8px;"><span style="color:var(--hud3);">‚óâ</span><span style="color:var(--text2);">JARVIS-tuned British voice</span></div>
        <div style="display:flex;align-items:center;gap:8px;"><span style="color:var(--hud3);">‚óâ</span><span style="color:var(--text2);">Cohere AI chat (free key built-in)</span></div>
        <div style="display:flex;align-items:center;gap:8px;"><span style="color:var(--hud3);">‚óâ</span><span style="color:var(--text2);">Open any website</span></div>
        <div style="display:flex;align-items:center;gap:8px;"><span style="color:var(--hud3);">‚óâ</span><span style="color:var(--text2);">Play music on YouTube</span></div>
        <div style="display:flex;align-items:center;gap:8px;"><span style="color:var(--hud3);">‚óâ</span><span style="color:var(--text2);">Persistent memory vault</span></div>
        <div style="display:flex;align-items:center;gap:8px;"><span style="color:var(--hud3);">‚óâ</span><span style="color:var(--text2);">Chat history log</span></div>
        <div style="display:flex;align-items:center;gap:8px;"><span style="color:var(--hud);">‚óé</span><span style="color:var(--text2);">Image analysis ‚Äî OpenAI key</span></div>
        <div style="display:flex;align-items:center;gap:8px;"><span style="color:var(--hud);">‚óé</span><span style="color:var(--text2);">DALL-E 3 image gen ‚Äî OpenAI key</span></div>
      </div>
    </div>
  </div>

  <div class="footer">
    <span>STARK INDUSTRIES ¬∑ ADVANCED AI DIVISION ¬∑ CONFIDENTIAL</span>
    <span id="footer-status">SYSTEM NOMINAL ¬∑ COHERE AI ONLINE</span>
    <span>BUILD 9.0.0 ¬∑ <span id="session-id">SES-XXXX</span></span>
  </div>
</div>

<script>
// ============================================================
// INIT
// ============================================================
const sessionId='SES-'+Math.random().toString(36).substr(2,6).toUpperCase();
document.getElementById('session-id').textContent=sessionId;
let conversationHistory=[],isListening=false,isSpeaking=false,isThinking=false,autoSpeak=true,totalOps=0,recognition=null,currentMemFilter='all';
let allVoices=[],selectedVoice=null;

// Tick marks on arc reactor
(()=>{const w=document.getElementById('tickWrap');for(let i=0;i<72;i++){const t=document.createElement('div');t.className='tick'+(i%6===0?' major':'');t.style.transform=`rotate(${i*5}deg) translateX(-50%)`;w.appendChild(t);}})();

// Waveform
const waveformEl=document.getElementById('waveform');
for(let i=0;i<44;i++){const b=document.createElement('div');b.className='wave-bar';waveformEl.appendChild(b);}
function animateWave(on){waveformEl.querySelectorAll('.wave-bar').forEach(b=>{if(on){b.style.height=(3+Math.random()*32)+'px';b.classList.add('active');}else{b.style.height='3px';b.classList.remove('active');}});}
let waveInt=null;
function startWave(){if(!waveInt)waveInt=setInterval(()=>animateWave(true),80);}
function stopWave(){clearInterval(waveInt);waveInt=null;animateWave(false);}

// Voice bars
const vBarsEl=document.getElementById('voiceBars');
for(let i=0;i<28;i++){const b=document.createElement('div');b.className='vbar';vBarsEl.appendChild(b);}
function animateVBars(on){vBarsEl.querySelectorAll('.vbar').forEach(b=>{b.style.height=(on?(6+Math.random()*50):(2+Math.random()*6))+'px';b.style.opacity=on?'0.9':'0.2';});}
let vbarInt=null;
function startVBars(){if(!vbarInt)vbarInt=setInterval(()=>animateVBars(true),75);}
function stopVBars(){clearInterval(vbarInt);vbarInt=null;animateVBars(false);}

// Clock
function updateClock(){
  const n=new Date();
  document.getElementById('clock').textContent=`${String(n.getHours()).padStart(2,'0')}:${String(n.getMinutes()).padStart(2,'0')}:${String(n.getSeconds()).padStart(2,'0')}`;
  const D=['SUNDAY','MONDAY','TUESDAY','WEDNESDAY','THURSDAY','FRIDAY','SATURDAY'];
  const M=['JAN','FEB','MAR','APR','MAY','JUN','JUL','AUG','SEP','OCT','NOV','DEC'];
  document.getElementById('date-display').textContent=`${D[n.getDay()]} ¬∑ ${String(n.getDate()).padStart(2,'0')} ${M[n.getMonth()]} ${n.getFullYear()}`;
}
updateClock();setInterval(updateClock,1000);

// Stats
function updateStats(){
  const cpu=30+Math.random()*40,mem=50+Math.random()*30;
  document.getElementById('cpu-val').textContent=cpu.toFixed(1)+'%';
  document.getElementById('mem-val').textContent=mem.toFixed(1)+'%';
  document.getElementById('cpu-bar').style.width=cpu+'%';
  document.getElementById('mem-bar').style.width=mem+'%';
  document.getElementById('stat-ops').textContent=totalOps.toLocaleString();
}
setInterval(updateStats,2000);updateStats();

// Arc state
function setArcState(state){
  const core=document.getElementById('arcCore');
  const st=document.getElementById('arcStatusText');
  const mode=document.getElementById('stat-mode');
  core.className='arc-core';
  const map={standby:{t:'CLICK TO SPEAK',m:'STANDBY'},listening:{c:'listening',t:'LISTENING...',m:'LISTEN'},thinking:{c:'thinking',t:'PROCESSING...',m:'THINK'},speaking:{c:'speaking',t:'SPEAKING...',m:'SPEAK'},imaging:{c:'imaging',t:'RENDERING...',m:'IMAGE'},launching:{c:'thinking',t:'LAUNCHING...',m:'LAUNCH'}};
  const s=map[state]||map.standby;
  if(s.c)core.classList.add(s.c);
  st.textContent=s.t;mode.textContent=s.m;
  if(state==='listening'){startWave();startVBars();}
  else if(state==='speaking'){startVBars();}
  else{stopWave();if(state!=='speaking')stopVBars();}
}

// Image attach
let attachedImageBase64=null,attachedImageName='';
function handleImageAttach(e){
  const f=e.target.files[0];if(!f||!f.type.startsWith('image/')){showNotif('Please attach an image file.','red');return;}
  const r=new FileReader();
  r.onload=(ev)=>{attachedImageBase64=ev.target.result;attachedImageName=f.name;document.getElementById('imgPreviewThumb').src=ev.target.result;document.getElementById('imgPreviewName').textContent=f.name;document.getElementById('imgPreviewBar').classList.add('visible');document.getElementById('imgAttachBtn').classList.add('has-image');showNotif('Image loaded. Ask JARVIS anything about it.','hud3');};
  r.readAsDataURL(f);e.target.value='';
}
function clearAttachedImage(){attachedImageBase64=null;attachedImageName='';document.getElementById('imgPreviewBar').classList.remove('visible');document.getElementById('imgAttachBtn').classList.remove('has-image');document.getElementById('imgPreviewThumb').src='';}

// Memory
const MEM_KEY='jarvis_memories_v3';
function loadMemories(){try{return JSON.parse(localStorage.getItem(MEM_KEY))||[];}catch{return[];}}
function saveMemoriesToStorage(m){localStorage.setItem(MEM_KEY,JSON.stringify(m));}
function saveMemory(){
  const inp=document.getElementById('memInput'),text=inp.value.trim();if(!text)return;
  const l=text.toLowerCase();let cat='general';
  if(/my name|i am|i like|i live|my |i'm |im /.test(l))cat='personal';
  else if(/todo|task|remind|need to|must|deadline|meeting/.test(l))cat='task';
  else if(/fact|note|remember that|always|never/.test(l))cat='fact';
  const mems=loadMemories();mems.unshift({id:Date.now(),text,cat,ts:new Date().toISOString(),tsLabel:new Date().toLocaleString()});
  saveMemoriesToStorage(mems);inp.value='';renderMemories();
  showNotif(`Memory saved: "${text.slice(0,40)}${text.length>40?'...':''}"`, 'hud3');
  speak("Memory stored, sir.");
}
function deleteMemory(id){saveMemoriesToStorage(loadMemories().filter(m=>m.id!==id));renderMemories();showNotif('Memory deleted.','orange');}
function clearAllMemories(){if(!confirm('Wipe ALL memories from JARVIS?'))return;localStorage.removeItem(MEM_KEY);renderMemories();showNotif('All memories wiped, sir.','red');speak('All memories wiped, sir.');}
function filterMemories(cat,btn){currentMemFilter=cat;document.querySelectorAll('.mem-tab').forEach(t=>t.classList.remove('active'));btn.classList.add('active');renderMemories();}
function renderMemories(){
  const mems=loadMemories(),filtered=currentMemFilter==='all'?mems:mems.filter(m=>m.cat===currentMemFilter);
  document.getElementById('mem-count').textContent=mems.length+' STORED';
  const list=document.getElementById('memory-list');
  if(!filtered.length){list.innerHTML=`<div style="color:var(--text2);font-size:0.72rem;font-family:'Share Tech Mono',monospace;padding:0.5rem;opacity:0.5;">No memories in this category.</div>`;return;}
  list.innerHTML=filtered.map(m=>`<div class="memory-item" style="display:flex;align-items:flex-start;gap:4px;"><div style="flex:1;"><span class="mem-cat-badge cat-${m.cat}">${m.cat.toUpperCase()}</span>${escHtml(m.text)}<span class="memory-time">${m.tsLabel}</span></div><button class="mem-delete-btn" onclick="deleteMemory(${m.id})">‚úï</button></div>`).join('');
}
function getMemoriesAsContext(){const m=loadMemories();if(!m.length)return'';return'\n\nMemory Vault:\n'+m.slice(0,25).map(x=>`- [${x.cat.toUpperCase()}] ${x.text}`).join('\n');}

// Chat history
const HIST_KEY='jarvis_history_v3';
function loadHistory(){try{return JSON.parse(localStorage.getItem(HIST_KEY))||[];}catch{return[];}}
function saveHistoryItem(role,text){const h=loadHistory();h.unshift({id:Date.now(),role,text:text.slice(0,100),ts:new Date().toLocaleTimeString()});if(h.length>150)h.pop();localStorage.setItem(HIST_KEY,JSON.stringify(h));renderHistory();}
function clearHistory(){if(!confirm('Wipe all chat history?'))return;localStorage.removeItem(HIST_KEY);renderHistory();showNotif('History wiped.','red');}
function renderHistory(){
  const h=loadHistory();document.getElementById('hist-count').textContent=h.length;
  const list=document.getElementById('history-list');
  if(!h.length){list.innerHTML=`<div style="color:var(--text2);font-size:0.68rem;font-family:'Share Tech Mono',monospace;padding:0.4rem;opacity:0.4">No history yet.</div>`;return;}
  list.innerHTML=h.slice(0,60).map(item=>`<div class="history-item" onclick="document.getElementById('textInput').value=${JSON.stringify(item.text)};showNotif('Loaded from history','hud');"><span style="color:${item.role==='user'?'var(--hud3)':'var(--hud)'};">${item.role==='user'?'YOU':'JAR'}</span><span class="hi-text" style="color:${item.role==='user'?'rgba(0,255,170,0.65)':'var(--text2)'}">${escHtml(item.text)}</span><span class="hi-time">${item.ts}</span></div>`).join('');
}

// Website opener
const SITES={youtube:'https://www.youtube.com',google:'https://www.google.com',gmail:'https://mail.google.com',facebook:'https://www.facebook.com',twitter:'https://twitter.com',instagram:'https://www.instagram.com',reddit:'https://www.reddit.com',github:'https://github.com',netflix:'https://www.netflix.com',spotify:'https://www.spotify.com',amazon:'https://www.amazon.com',wikipedia:'https://en.wikipedia.org',whatsapp:'https://web.whatsapp.com',linkedin:'https://www.linkedin.com',twitch:'https://www.twitch.tv',discord:'https://discord.com/app',stackoverflow:'https://stackoverflow.com',maps:'https://maps.google.com',drive:'https://drive.google.com',docs:'https://docs.google.com',news:'https://news.google.com',translate:'https://translate.google.com',chatgpt:'https://chat.openai.com',claude:'https://claude.ai',canva:'https://www.canva.com',figma:'https://www.figma.com'};
function detectWebCmd(text){
  const m=text.toLowerCase().trim().match(/^(?:open|launch|go to|navigate to|take me to|load|show me)\s+(.+)$/i);
  if(m){const target=m[1].trim().replace(/\s*(please|now)$/,'').trim();for(const[k,url]of Object.entries(SITES)){if(target.includes(k))return{type:'open',url,name:k};}if(/\.(com|org|net|io|co|ai|dev|tv|me|in|uk|app)/.test(target)){let url=target;if(!url.startsWith('http'))url='https://'+url;return{type:'open',url,name:target};}return{type:'search',url:'https://www.google.com/search?q='+encodeURIComponent(target),name:target};}return null;
}
function detectMusicCmd(text){
  const m=text.toLowerCase().trim().match(/^(?:play|put on|play me|search for)\s+(.+?)(?:\s+(?:on\s+)?(?:youtube|spotify|music))?$/i);
  if(m){const q=m[1].trim();if(!/^(a game|games|the game)$/.test(q))return{type:'music',query:q,url:'https://www.youtube.com/results?search_query='+encodeURIComponent(q)};}return null;
}
function sleep(ms){return new Promise(r=>setTimeout(r,ms));}
async function openWebsite(cmd){
  setArcState('launching');
  const overlay=document.getElementById('launchOverlay');
  const label=cmd.type==='music'?`‚ñ∂ ${cmd.query}`.toUpperCase():(cmd.name||cmd.url).toUpperCase();
  document.getElementById('launchTarget').textContent=label.slice(0,30)+(label.length>30?'...':'');
  document.getElementById('launchStatus').textContent='ESTABLISHING CONNECTION...';
  const bar=document.getElementById('launchBarFill');bar.style.animation='none';
  overlay.classList.add('visible');requestAnimationFrame(()=>{bar.style.animation='launchFill 1.4s ease-out forwards';});
  await sleep(500);document.getElementById('launchStatus').textContent='LINK CONFIRMED ‚Äî LAUNCHING...';
  await sleep(900);window.open(cmd.url,'_blank');await sleep(400);
  overlay.classList.remove('visible');setArcState('standby');
  const msgs={open:`Launching ${cmd.name}, sir.`,search:`Searching for "${cmd.name}", sir.`,music:`Playing "${cmd.query}" on YouTube, sir.`};
  return msgs[cmd.type]||'Executed, sir.';
}

// Image gen detection
function isImageGenRequest(t){return /\b(generate|create|draw|make|render|show me|paint|produce|design)\s+(an?\s+)?(image|picture|photo|illustration|artwork|painting|sketch|portrait|scene|visual)\b/i.test(t)||/\b(generate|create|draw|make|render|paint)\b.*\b(of|showing|depicting|with)\b/i.test(t)||/^image of /i.test(t)||/^draw /i.test(t);}

// OpenAI image features
async function generateImage(prompt,key){const r=await fetch('https://api.openai.com/v1/images/generations',{method:'POST',headers:{'Content-Type':'application/json','Authorization':'Bearer '+key},body:JSON.stringify({model:'dall-e-3',prompt,n:1,size:'1024x1024',quality:'standard'})});const d=await r.json();if(d.error)throw new Error(d.error.message);return d.data[0].url;}
async function analyzeImage(b64,q,key){const base64=b64.split(',')[1],mime=(b64.match(/data:([^;]+);/)||[])[1]||'image/jpeg';const r=await fetch('https://api.openai.com/v1/chat/completions',{method:'POST',headers:{'Content-Type':'application/json','Authorization':'Bearer '+key},body:JSON.stringify({model:'gpt-4o',max_tokens:300,messages:[{role:'user',content:[{type:'image_url',image_url:{url:`data:${mime};base64,${base64}`,detail:'auto'}},{type:'text',text:`You are J.A.R.V.I.S., Tony Stark's AI. Analyze this image for: "${q||'Describe it.'}". 2-3 sentences, spoken-word style, dry British wit, address user as "sir".`}]}]})});const d=await r.json();if(d.error)throw new Error(d.error.message);return d.choices[0].message.content;}

// ============================================================
// MAIN MESSAGE HANDLER
// ============================================================
async function sendMessage(text){
  if(!text||isThinking)return;
  document.getElementById('textInput').value='';
  totalOps++;
  const imgToProcess=attachedImageBase64,imgName=attachedImageName;

  const chatArea=document.getElementById('chatArea');
  const userDiv=document.createElement('div');userDiv.className='msg user';
  userDiv.innerHTML=`<span class="msg-label">‚ñ∏ YOU</span><span class="msg-text">${escHtml(text)}</span>`;
  if(imgToProcess){const wrap=document.createElement('div');wrap.className='msg-img-wrap';wrap.setAttribute('data-label','‚óà ATTACHED ¬∑ '+imgName.toUpperCase());const img=document.createElement('img');img.src=imgToProcess;wrap.appendChild(img);userDiv.appendChild(wrap);}
  chatArea.appendChild(userDiv);chatArea.scrollTop=chatArea.scrollHeight;
  if(imgToProcess)clearAttachedImage();

  saveHistoryItem('user',text);
  conversationHistory.push({role:'user',content:text});
  isThinking=true;showTyping();setArcState('thinking');

  // Auto-remember
  for(const pat of[/^(?:please\s+)?remember\s+(?:that\s+)?(.+)/i,/^(?:please\s+)?save\s+(?:to\s+memory\s*)?[:\-]?\s*(.+)/i,/^don'?t forget\s+(?:that\s+)?(.+)/i]){
    const m=text.match(pat);if(m){const t=m[1].trim(),l=t.toLowerCase();let cat='general';if(/my name|i am|i like|i live|my |i'm /.test(l))cat='personal';else if(/task|todo|remind|need to|must|deadline/.test(l))cat='task';else if(/fact|note|always|never|important/.test(l))cat='fact';const mems=loadMemories();mems.unshift({id:Date.now(),text:t,cat,ts:new Date().toISOString(),tsLabel:new Date().toLocaleString()});saveMemoriesToStorage(mems);renderMemories();showNotif(`Saved: "${t.slice(0,38)}"`,'hud3');break;}
  }

  const openaiKey=localStorage.getItem('jarvis_openai_key');
  const COHERE_KEY='pF7g391WplP4RL20bg4JSP4jE9OLLLviaHSeVtvK';

  try{
    // CASE 1: Image analysis
    if(imgToProcess){
      if(!openaiKey){removeTyping();isThinking=false;setArcState('standby');addMsg('system','OpenAI API key required for image analysis. Click üîë OPENAI KEY.');showApiKeyModal();return;}
      const analysis=await analyzeImage(imgToProcess,text,openaiKey);
      removeTyping();conversationHistory.push({role:'assistant',content:analysis});if(conversationHistory.length>20)conversationHistory=conversationHistory.slice(-20);
      addMsg('jarvis',analysis);saveHistoryItem('jarvis',analysis);isThinking=false;setArcState('standby');if(autoSpeak)speak(analysis);return;
    }

    // CASE 2: Music
    const musicCmd=detectMusicCmd(text);
    if(musicCmd){const reply=await openWebsite(musicCmd);removeTyping();addMsg('jarvis',reply);saveHistoryItem('jarvis',reply);conversationHistory.push({role:'assistant',content:reply});isThinking=false;setArcState('standby');if(autoSpeak)speak(reply);return;}

    // CASE 3: Website
    const webCmd=detectWebCmd(text);
    if(webCmd){const reply=await openWebsite(webCmd);removeTyping();addMsg('jarvis',reply);saveHistoryItem('jarvis',reply);conversationHistory.push({role:'assistant',content:reply});isThinking=false;setArcState('standby');if(autoSpeak)speak(reply);return;}

    // CASE 4: Image generation
    if(isImageGenRequest(text)){
      if(!openaiKey){removeTyping();isThinking=false;setArcState('standby');addMsg('system','OpenAI API key required for image generation. Click üîë OPENAI KEY.');showApiKeyModal();return;}
      setArcState('imaging');
      let imgPrompt=text.replace(/^(please\s+)?(generate|create|draw|make|render|show me|paint|produce|design)\s+(an?\s+)?(image|picture|photo|illustration|artwork|painting|sketch|portrait|scene|visual)?\s*(of\s+)?/i,'').replace(/^(please\s+)?/i,'').trim()||text;
      const progDiv=document.createElement('div');progDiv.id='img-gen-progress';progDiv.className='msg jarvis';
      progDiv.innerHTML=`<span class="msg-label">‚ñ∏ J.A.R.V.I.S RENDERING</span><div class="img-gen-progress"><div class="img-gen-spinner"></div><span>DALL-E 3: "${imgPrompt.slice(0,48)}${imgPrompt.length>48?'...':''}"</span></div>`;
      chatArea.appendChild(progDiv);chatArea.scrollTop=chatArea.scrollHeight;
      try{
        const imgUrl=await generateImage(imgPrompt,openaiKey);progDiv.remove();removeTyping();
        const imgDiv=document.createElement('div');imgDiv.className='msg jarvis';
        imgDiv.innerHTML=`<span class="msg-label">‚ñ∏ J.A.R.V.I.S ‚Äî IMAGE SYNTHESIS COMPLETE</span>`;
        const wrap=document.createElement('div');wrap.className='msg-img-wrap generated';wrap.setAttribute('data-label','‚óà DALL-E 3 ¬∑ '+imgPrompt.slice(0,38).toUpperCase()+(imgPrompt.length>38?'...':''));
        const img=document.createElement('img');img.src=imgUrl;img.alt=imgPrompt;img.style.cursor='pointer';img.title='Click to open full size';img.onclick=()=>window.open(imgUrl,'_blank');wrap.appendChild(img);imgDiv.appendChild(wrap);
        const rt='Image rendered, sir. DALL-E 3 synthesis complete.';
        const ts=document.createElement('span');ts.className='msg-text';ts.style.marginTop='6px';ts.textContent=rt;imgDiv.appendChild(ts);
        chatArea.appendChild(imgDiv);chatArea.scrollTop=chatArea.scrollHeight;
        conversationHistory.push({role:'assistant',content:`[Generated image: "${imgPrompt}"]`});saveHistoryItem('jarvis',rt);
        isThinking=false;setArcState('standby');if(autoSpeak)speak(rt);
      }catch(err){progDiv.remove();removeTyping();isThinking=false;setArcState('standby');addMsg('system','IMAGE ERROR: '+err.message);addMsg('jarvis','Image synthesis failed, sir.');if(autoSpeak)speak('Image generation failed, sir.');}
      return;
    }

    // CASE 5: Cohere AI chat
    const memCtx=getMemoriesAsContext();
    const systemPrompt=`You are J.A.R.V.I.S. (Just A Rather Very Intelligent System), Tony Stark's AI. Speak like Paul Bettany's JARVIS: calm, precise, dry British wit, slightly formal but warm. Keep ALL responses to 1-3 short spoken sentences. No bullet points, no markdown, no lists. Write for speech. Use natural contractions. Call the user "sir" occasionally. Never break character.${memCtx}`;
    const chatHistory=conversationHistory.slice(0,-1).map(m=>({role:m.role==='user'?'USER':'CHATBOT',message:m.content}));
    const lastMsg=conversationHistory[conversationHistory.length-1].content;

    // Try command-r-plus first, fallback to command-light (free tier)
    let res=await fetch('https://api.cohere.ai/v1/chat',{method:'POST',headers:{'Content-Type':'application/json','Authorization':'Bearer '+COHERE_KEY},body:JSON.stringify({model:'command-r-plus-08-2024',message:lastMsg,chat_history:chatHistory,preamble:systemPrompt,max_tokens:250,temperature:0.72})});
    if(res.status===429||res.status===402||res.status===403){
      // Fallback to lighter model
      res=await fetch('https://api.cohere.ai/v1/chat',{method:'POST',headers:{'Content-Type':'application/json','Authorization':'Bearer '+COHERE_KEY},body:JSON.stringify({model:'command-light',message:lastMsg,chat_history:chatHistory,preamble:systemPrompt,max_tokens:250,temperature:0.72})});
    }

    const data=await res.json();removeTyping();
    if(data.text){
      // Strip any markdown the model might output
      const reply=data.text.replace(/\*\*(.+?)\*\*/g,'$1').replace(/\*(.+?)\*/g,'$1').replace(/#{1,6}\s/g,'').replace(/\n{2,}/g,' ').trim();
      conversationHistory.push({role:'assistant',content:reply});if(conversationHistory.length>20)conversationHistory=conversationHistory.slice(-20);
      addMsg('jarvis',reply);saveHistoryItem('jarvis',reply);isThinking=false;setArcState('standby');if(autoSpeak)speak(reply);
    }else{
      const errMsg=data.message||JSON.stringify(data);
      // Check if it's a quota/billing issue
      if(errMsg.includes('quota')||errMsg.includes('billing')||errMsg.includes('exceeded')||errMsg.includes('plan')){
        throw new Error('QUOTA_EXCEEDED');
      }
      throw new Error(errMsg);
    }

  }catch(err){
    removeTyping();isThinking=false;setArcState('standby');
    if(err.message==='QUOTA_EXCEEDED'||err.message.includes('quota')||err.message.includes('billing')||err.message.includes('exceeded')){
      addMsg('system','‚ö† COHERE API QUOTA EXCEEDED ‚Äî The trial key has run out of credits. Visit cohere.com/api-keys for a new free key.');
      addMsg('jarvis','My Cohere quota has been exhausted, sir. You will need to obtain a new free API key from cohere.com to restore chat functionality.');
      if(autoSpeak)speak('My Cohere quota has been exhausted, sir. A new API key is required.');
    } else if(err.message.includes('rate')){
      addMsg('system','RATE LIMITED ‚Äî Please wait 30 seconds before trying again.');
      addMsg('jarvis','The rate limit has been reached, sir. Please allow a brief pause before your next query.');
      if(autoSpeak)speak('Rate limit reached, sir. Please wait a moment.');
    } else {
      addMsg('system','ERROR: '+err.message);
      addMsg('jarvis','I encountered a connectivity issue, sir. '+err.message.slice(0,60));
      if(autoSpeak)speak('I encountered a connectivity issue, sir.');
    }
    console.error('JARVIS error:',err);
  }
}

function sendText(){const v=document.getElementById('textInput').value.trim();if(v)sendMessage(v);}
function quickCmd(cmd){document.getElementById('textInput').value=cmd;sendMessage(cmd);}

// Chat UI helpers
function addMsg(type,text){const a=document.getElementById('chatArea');const d=document.createElement('div');d.className='msg '+type;const l=type==='user'?'‚ñ∏ YOU':type==='jarvis'?'‚ñ∏ J.A.R.V.I.S':'‚ñ∏ SYSTEM';d.innerHTML=`<span class="msg-label">${l}</span><span class="msg-text">${escHtml(text)}</span>`;a.appendChild(d);a.scrollTop=a.scrollHeight;}
function showTyping(){const a=document.getElementById('chatArea');const d=document.createElement('div');d.id='typing-indicator';d.className='msg jarvis';d.innerHTML=`<span class="msg-label">‚ñ∏ J.A.R.V.I.S PROCESSING</span><div class="typing-indicator"><div class="typing-dot"></div><div class="typing-dot"></div><div class="typing-dot"></div></div>`;a.appendChild(d);a.scrollTop=a.scrollHeight;}
function removeTyping(){const t=document.getElementById('typing-indicator');if(t)t.remove();}
function escHtml(s){return s.replace(/&/g,'&amp;').replace(/</g,'&lt;').replace(/>/g,'&gt;').replace(/\n/g,'<br>');}
function clearChat(){document.getElementById('chatArea').innerHTML='';conversationHistory=[];addMsg('system','Conversation log cleared. Memory vault retained.');speak('Conversation log cleared, sir.');}

// ============================================================
// JARVIS VOICE ENGINE
// Smart voice scoring ‚Äî prioritises British Neural voices like Paul Bettany
// ============================================================
function scoreVoice(v){
  const n=v.name.toLowerCase(),l=(v.lang||'').toLowerCase();
  let s=0;
  if(l.includes('en-gb')||l.includes('en_gb'))s+=50;
  if(n.includes('natural')||n.includes('neural')||n.includes('online'))s+=40;
  if(n.includes('ryan'))s+=35;
  if(n.includes('george')||n.includes('arthur'))s+=28;
  if(n.includes('google uk')||n.includes('google english'))s+=22;
  if(n.includes('daniel')||n.includes('oliver'))s+=18;
  if(n.includes('james')||n.includes('mark')||n.includes('david'))s+=12;
  if(l.startsWith('en'))s+=8;
  if(/zira|susan|hazel|fiona|samantha|karen|victoria|moira|female|woman/.test(n))s-=25;
  return s;
}

function initVoices(){
  const voices=window.speechSynthesis.getVoices();
  if(!voices.length){setTimeout(initVoices,200);return;}
  allVoices=voices;
  const sel=document.getElementById('voiceSelect');sel.innerHTML='';
  const eng=voices.filter(v=>(v.lang||'').startsWith('en'));
  const pool=eng.length?eng:voices;
  const sorted=[...pool].sort((a,b)=>scoreVoice(b)-scoreVoice(a));
  sorted.forEach(v=>{
    const o=document.createElement('option');o.value=v.name;
    const brit=v.lang.includes('GB')||v.lang.includes('gb');
    o.textContent=(brit?'üá¨üáß ':'')+v.name+(v.lang?` (${v.lang})`:'');
    sel.appendChild(o);
  });
  if(sorted.length){
    selectedVoice=sorted[0];sel.value=sorted[0].name;
    const brit=sorted[0].lang.includes('GB');
    showNotif(`Voice: ${sorted[0].name.slice(0,24)} ${brit?'üá¨üáß':''}`,brit?'hud3':'hud');
  }
  document.getElementById('speech-stat').textContent='READY';
  document.getElementById('speech-stat').style.color='var(--hud3)';
  document.getElementById('speech-bar').style.width='100%';
}
window.speechSynthesis.onvoiceschanged=initVoices;
setTimeout(initVoices,300);

function onVoiceChange(){const name=document.getElementById('voiceSelect').value;const v=allVoices.find(x=>x.name===name);if(v)selectedVoice=v;}
function updateVoiceSettings(){const r=document.getElementById('rateSlider').value,p=document.getElementById('pitchSlider').value;document.getElementById('rate-label').textContent=r+'x';document.getElementById('pitch-label').textContent=p;document.getElementById('voice-rate').textContent=r+'x';}

// Pre-process text for more natural JARVIS speech
function cleanForSpeech(text){
  return text
    .replace(/\*\*(.+?)\*\*/g,'$1').replace(/\*(.+?)\*/g,'$1').replace(/`(.+?)`/g,'$1').replace(/#{1,6}\s/g,'')
    .replace(/\bJ\.A\.R\.V\.I\.S\.?\b/gi,'Jarvis')
    .replace(/\bAI\b/g,'A.I.').replace(/\bAPI\b/g,'A.P.I.').replace(/\bURL\b/g,'the link')
    .replace(/https?:\/\/\S+/g,'').replace(/\n+/g,' ').replace(/\s{2,}/g,' ').trim();
}

// Sentence-chunked speech ‚Äî fixes Chrome 200-char cutoff bug and sounds more natural
function speak(text){
  if(!text||!autoSpeak)return;
  window.speechSynthesis.cancel();
  const cleaned=cleanForSpeech(text);
  const sentences=cleaned.match(/[^.!?‚Ä¶]+[.!?‚Ä¶]+|[^.!?‚Ä¶]+$/g)||[cleaned];
  let idx=0;
  function next(){
    if(idx>=sentences.length){isSpeaking=false;setArcState('standby');stopVBars();return;}
    const chunk=sentences[idx].trim();if(!chunk){idx++;next();return;}
    const utt=new SpeechSynthesisUtterance(chunk);
    const selName=document.getElementById('voiceSelect').value;
    const v=allVoices.find(x=>x.name===selName)||selectedVoice;
    if(v)utt.voice=v;
    utt.rate=parseFloat(document.getElementById('rateSlider').value);
    utt.pitch=parseFloat(document.getElementById('pitchSlider').value);
    utt.volume=1;
    if(idx===0){utt.onstart=()=>{isSpeaking=true;setArcState('speaking');startVBars();};}
    utt.onend=()=>{idx++;next();};
    utt.onerror=()=>{idx++;next();};
    window.speechSynthesis.speak(utt);
  }
  next();
}

function testVoice(){speak("All systems are fully operational, sir. I've completed a diagnostic ‚Äî everything is running within normal parameters. Shall I prepare a status report, or is there something more pressing on your agenda?");}

// Speech recognition
function initRecognition(){
  if(!('webkitSpeechRecognition'in window)&&!('SpeechRecognition'in window)){showNotif('Speech recognition not supported in this browser.','red');return;}
  const SR=window.SpeechRecognition||window.webkitSpeechRecognition;
  recognition=new SR();recognition.continuous=false;recognition.interimResults=true;recognition.lang='en-US';
  recognition.onstart=()=>{isListening=true;setArcState('listening');document.getElementById('voiceBtn').classList.add('active');document.getElementById('voiceBtn').textContent='üé§ STOP';document.getElementById('rec-accuracy').textContent='--';};
  recognition.onresult=(e)=>{let interim='',final='';for(let i=e.resultIndex;i<e.results.length;i++){const t=e.results[i][0].transcript;if(e.results[i].isFinal)final+=t;else interim+=t;}const conf=e.results[e.results.length-1][0].confidence;if(conf)document.getElementById('rec-accuracy').textContent=(conf*100).toFixed(0)+'%';if(final){document.getElementById('textInput').value=final;sendMessage(final);}else if(interim){document.getElementById('textInput').value=interim+'...';}};
  recognition.onend=()=>{isListening=false;document.getElementById('voiceBtn').classList.remove('active');document.getElementById('voiceBtn').textContent='üé§ VOICE';if(!isThinking)setArcState('standby');stopWave();};
  recognition.onerror=(e)=>{isListening=false;document.getElementById('voiceBtn').classList.remove('active');document.getElementById('voiceBtn').textContent='üé§ VOICE';setArcState('standby');stopWave();if(e.error!=='no-speech')showNotif('Voice error: '+e.error,'red');};
}
initRecognition();
function toggleListen(){if(!recognition){showNotif('Speech recognition unavailable.','red');return;}if(isListening){recognition.stop();}else{if(isSpeaking){window.speechSynthesis.cancel();isSpeaking=false;stopVBars();}try{recognition.start();}catch(e){console.log(e);}}}

function toggleAutoSpeak(){autoSpeak=!autoSpeak;document.getElementById('autoSpeakBtn').textContent=`üîä AUTO-SPEAK: ${autoSpeak?'ON':'OFF'}`;if(!autoSpeak)window.speechSynthesis.cancel();}
function emergencyStop(){window.speechSynthesis.cancel();if(recognition&&isListening)recognition.stop();isListening=false;isSpeaking=false;isThinking=false;setArcState('standby');stopWave();stopVBars();removeTyping();document.getElementById('launchOverlay').classList.remove('visible');const p=document.getElementById('img-gen-progress');if(p)p.remove();showNotif('EMERGENCY STOP. All processes halted.','red');}

function showNotif(msg,color='hud'){const c=document.getElementById('notif');const d=document.createElement('div');d.className='notif-item';d.style.borderLeftColor=`var(--${color})`;d.textContent='‚ñ∏ '+msg;c.appendChild(d);setTimeout(()=>{d.style.opacity='0';d.style.transition='opacity 0.4s';setTimeout(()=>d.remove(),400);},3500);}

function showApiKeyModal(){document.getElementById('apiModal').classList.add('visible');const k=localStorage.getItem('jarvis_openai_key');const inp=document.getElementById('apiKeyInput'),st=document.getElementById('apiKeyStatus');if(k){inp.value=k;st.innerHTML='‚úì Key active ‚Äî Image features ONLINE.';st.style.color='rgba(0,255,170,0.7)';}else{inp.value='';st.textContent='No key ‚Äî image features unavailable.';st.style.color='rgba(0,212,255,0.5)';}setTimeout(()=>inp.focus(),100);}
function closeApiModal(){document.getElementById('apiModal').classList.remove('visible');}
function saveApiKey(){const k=document.getElementById('apiKeyInput').value.trim(),s=document.getElementById('apiKeyStatus');if(!k){s.textContent='‚ö† Please enter a key.';s.style.color='rgba(255,136,0,0.8)';return;}if(!k.startsWith('sk-')){s.textContent='‚ö† Key should start with "sk-".';s.style.color='rgba(255,136,0,0.8)';return;}localStorage.setItem('jarvis_openai_key',k);s.innerHTML='‚úì Key saved. Image features ACTIVE.';s.style.color='rgba(0,255,170,0.8)';showNotif('OpenAI key saved. Vision modules online.','hud3');setTimeout(closeApiModal,1200);}
function clearApiKey(){localStorage.removeItem('jarvis_openai_key');document.getElementById('apiKeyInput').value='';document.getElementById('apiKeyStatus').textContent='Key cleared.';document.getElementById('apiKeyStatus').style.color='rgba(255,51,51,0.7)';showNotif('OpenAI key removed.','red');}

document.addEventListener('keydown',e=>{if(e.key==='Escape')emergencyStop();if(e.key===' '&&e.target===document.body){e.preventDefault();toggleListen();}});

// Boot
renderMemories();renderHistory();
const savedCount=loadMemories().length,hasKey=!!localStorage.getItem('jarvis_openai_key');
setTimeout(()=>{
  showNotif('J.A.R.V.I.S. systems online.','hud3');
  const boot=savedCount>0
    ?`Good day, sir. All systems operational. ${savedCount} stored ${savedCount===1?'memory':'memories'} loaded. ${hasKey?'Image systems active.':'Add an OpenAI key for image features.'} How may I assist?`
    :`Good day, sir. All systems operational. You can say "open YouTube", "play a song", or ask me anything. ${hasKey?'Image features active.':''}`;
  addMsg('jarvis',boot);
  if(autoSpeak)setTimeout(()=>speak('Good day, sir. All systems operational. How may I assist you today?'),800);
},1000);
setTimeout(()=>showNotif('Tip: "open [site]" ¬∑ "play [song]" ¬∑ ask anything','hud'),2200);
if(hasKey)setTimeout(()=>showNotif('OpenAI key detected ‚Äî image features active','hud3'),3000);

console.log('%cJ.A.R.V.I.S.','color:#00d4ff;font-size:28px;font-weight:900;font-family:monospace;');
console.log('%cv9.0.0 ‚Äî Cohere AI + JARVIS Voice Engine + Website/Music Launcher','color:#00ffaa;font-size:11px;');
</script>
</body>
</html>
