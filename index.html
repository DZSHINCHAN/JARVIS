<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>J.A.R.V.I.S ‚Äî Just A Rather Very Intelligent System</title>
<link href="https://fonts.googleapis.com/css2?family=Rajdhani:wght@300;400;500;600;700&family=Orbitron:wght@400;500;600;700;900&family=Share+Tech+Mono&display=swap" rel="stylesheet">
<style>
:root {
  --hud: #00c8ff;
  --hud2: #0050dd;
  --hud3: #00ffc8;
  --red: #ff2244;
  --orange: #ff9900;
  --gold: #ffd700;
  --bg: #00050f;
  --panel: rgba(0,140,255,0.03);
  --border: rgba(0,200,255,0.18);
  --border2: rgba(0,200,255,0.5);
  --text: #b8e8ff;
  --text2: rgba(0,200,255,0.5);
  --glow: 0 0 15px rgba(0,200,255,0.5), 0 0 40px rgba(0,200,255,0.15);
}
*{margin:0;padding:0;box-sizing:border-box;}
body{font-family:'Rajdhani',sans-serif;background:var(--bg);color:var(--text);min-height:100vh;overflow-x:hidden;user-select:none;}

/* SCANLINE OVERLAY */
body::before{content:'';position:fixed;inset:0;background:repeating-linear-gradient(0deg,transparent,transparent 3px,rgba(0,200,255,0.012) 3px,rgba(0,200,255,0.012) 4px);pointer-events:none;z-index:9999;}
body::after{content:'';position:fixed;inset:0;background:radial-gradient(ellipse 120% 120% at 50% -20%,rgba(0,80,200,0.12) 0%,transparent 60%);pointer-events:none;z-index:0;}

/* GRID BG */
.grid-bg{position:fixed;inset:0;z-index:0;
  background-image:linear-gradient(rgba(0,180,255,0.035) 1px,transparent 1px),linear-gradient(90deg,rgba(0,180,255,0.035) 1px,transparent 1px);
  background-size:60px 60px;
  mask-image:radial-gradient(ellipse 90% 90% at 50% 50%,black,transparent);}

/* CIRCUIT LINES */
.circuit{position:fixed;inset:0;z-index:0;opacity:0.07;pointer-events:none;}

.app{position:relative;z-index:1;min-height:100vh;display:grid;grid-template-rows:auto 1fr auto;grid-template-columns:260px 1fr 260px;gap:0;padding:0.75rem;}

/* PANEL */
.panel{background:var(--panel);border:1px solid var(--border);border-radius:2px;padding:0.85rem;position:relative;overflow:hidden;backdrop-filter:blur(4px);}
.panel::after{content:'';position:absolute;top:0;left:0;right:0;height:1px;background:linear-gradient(90deg,transparent,var(--hud),transparent);opacity:0;transition:opacity 0.3s;}
.panel:hover::after{opacity:1;}

/* MCU CORNER BRACKETS */
.corner-tl,.corner-tr,.corner-bl,.corner-br{position:absolute;width:14px;height:14px;border-color:var(--hud);border-style:solid;}
.corner-tl{top:0;left:0;border-width:2px 0 0 2px;}
.corner-tr{top:0;right:0;border-width:2px 2px 0 0;}
.corner-bl{bottom:0;left:0;border-width:0 0 2px 2px;}
.corner-br{bottom:0;right:0;border-width:0 2px 2px 0;}

/* HEADER */
.header{grid-column:1/-1;display:flex;align-items:center;justify-content:space-between;padding:0.6rem 1.5rem;border:1px solid var(--border);background:rgba(0,10,30,0.8);margin-bottom:0.75rem;backdrop-filter:blur(12px);position:relative;overflow:hidden;}
.header::before{content:'';position:absolute;bottom:0;left:0;right:0;height:1px;background:linear-gradient(90deg,transparent,var(--hud),transparent);animation:scanH 4s linear infinite;}
@keyframes scanH{0%{transform:translateX(-100%)}100%{transform:translateX(100%)}}

.header-logo{font-family:'Orbitron',monospace;font-size:1.5rem;font-weight:900;color:var(--hud);text-shadow:0 0 20px rgba(0,200,255,0.8),0 0 60px rgba(0,200,255,0.3);letter-spacing:0.25em;}
.header-logo span{color:rgba(0,200,255,0.45);font-size:0.55rem;display:block;letter-spacing:0.35em;margin-top:-2px;font-family:'Share Tech Mono',monospace;font-weight:400;}
.header-status{display:flex;gap:2rem;align-items:center;}
.status-item{display:flex;flex-direction:column;align-items:center;font-size:0.58rem;letter-spacing:0.15em;color:var(--text2);font-family:'Share Tech Mono',monospace;}
.status-item .val{font-size:1rem;color:var(--hud3);font-family:'Orbitron',monospace;font-weight:700;text-shadow:0 0 10px rgba(0,255,200,0.5);}
.header-time{font-family:'Orbitron',monospace;font-size:1.6rem;color:var(--hud);text-shadow:var(--glow);letter-spacing:0.08em;}
.header-date{font-size:0.58rem;color:var(--text2);font-family:'Share Tech Mono',monospace;text-align:right;margin-top:3px;}

.left-panel{grid-column:1;grid-row:2;display:flex;flex-direction:column;gap:0.75rem;padding-right:0.4rem;}
.right-panel{grid-column:3;grid-row:2;display:flex;flex-direction:column;gap:0.75rem;padding-left:0.4rem;}
.center{grid-column:2;grid-row:2;display:flex;flex-direction:column;align-items:center;justify-content:center;gap:1rem;padding:0 0.75rem;}

.section-label{font-family:'Share Tech Mono',monospace;font-size:0.58rem;color:var(--text2);letter-spacing:0.2em;margin-bottom:0.65rem;display:flex;align-items:center;gap:0.4rem;text-transform:uppercase;}
.section-label::before{content:'‚ñ∏';color:var(--hud);}
.section-label::after{content:'';flex:1;height:1px;background:linear-gradient(to right,var(--border),transparent);}

/* ARC REACTOR */
.arc-container{position:relative;width:240px;height:240px;display:flex;align-items:center;justify-content:center;}
.arc-ring{position:absolute;border-radius:50%;border:1px solid var(--border);}
.arc-ring-outer{width:240px;height:240px;border:1px solid rgba(0,180,255,0.2);animation:spinSlowCW 30s linear infinite;}
.arc-ring-mid{width:200px;height:200px;border:1px dashed rgba(0,180,255,0.15);animation:spinSlowCCW 20s linear infinite;}
.arc-ring-inner{width:162px;height:162px;border:1px solid rgba(0,180,255,0.25);animation:spinSlowCW 12s linear infinite;}
@keyframes spinSlowCW{to{transform:rotate(360deg)}}
@keyframes spinSlowCCW{to{transform:rotate(-360deg)}}

/* ORBITAL DOTS */
.orb-dot{position:absolute;width:5px;height:5px;border-radius:50%;background:var(--hud);box-shadow:0 0 8px var(--hud),0 0 16px var(--hud);top:0;left:50%;transform:translateX(-50%) translateY(-2px);}
.arc-ring-outer .orb-dot{animation:spinSlowCW 30s linear infinite;}
.arc-ring-inner .orb-dot{background:var(--hud3);box-shadow:0 0 8px var(--hud3);animation:spinSlowCW 12s linear infinite;}

/* TICK MARKS on outer ring */
.tick-ring{position:absolute;width:240px;height:240px;border-radius:50%;pointer-events:none;}
.tick{position:absolute;width:1px;height:8px;background:rgba(0,200,255,0.4);left:50%;transform-origin:50% 120px;top:0px;}

/* ARC CORE */
.arc-core{width:118px;height:118px;border-radius:50%;position:relative;cursor:pointer;transition:all 0.3s;display:flex;align-items:center;justify-content:center;flex-direction:column;
  background:radial-gradient(circle,rgba(0,180,255,0.18) 0%,rgba(0,100,255,0.08) 45%,transparent 70%);
  border:2px solid rgba(0,200,255,0.5);
  box-shadow:0 0 25px rgba(0,180,255,0.25),inset 0 0 25px rgba(0,180,255,0.1),0 0 60px rgba(0,100,255,0.1);}
.arc-core:hover{box-shadow:0 0 50px rgba(0,200,255,0.5),inset 0 0 35px rgba(0,200,255,0.2);}
.arc-core.listening{border-color:var(--hud3);box-shadow:0 0 50px rgba(0,255,200,0.5),inset 0 0 35px rgba(0,255,200,0.15);animation:listenPulse 1s ease infinite;}
.arc-core.thinking{border-color:#4488ff;animation:thinkGlow 0.8s ease infinite alternate;}
.arc-core.speaking{border-color:var(--orange);box-shadow:0 0 50px rgba(255,153,0,0.4),inset 0 0 30px rgba(255,153,0,0.1);animation:speakPulse 0.35s ease infinite;}
.arc-core.imaging{border-color:#aa44ff;box-shadow:0 0 50px rgba(170,68,255,0.5),inset 0 0 30px rgba(170,68,255,0.15);animation:thinkGlow 0.5s ease infinite alternate;}
@keyframes listenPulse{0%,100%{transform:scale(1)}50%{transform:scale(1.06)}}
@keyframes speakPulse{0%,100%{transform:scale(1)}50%{transform:scale(1.04)}}
@keyframes thinkGlow{from{box-shadow:0 0 30px rgba(68,136,255,0.3)}to{box-shadow:0 0 60px rgba(68,136,255,0.7),inset 0 0 30px rgba(68,136,255,0.2)}}

/* REACTOR CENTER GLOW */
.reactor-center{width:50px;height:50px;border-radius:50%;background:radial-gradient(circle,rgba(0,220,255,0.9) 0%,rgba(0,150,255,0.5) 40%,transparent 70%);box-shadow:0 0 20px rgba(0,200,255,0.8),0 0 40px rgba(0,150,255,0.4);animation:reactorPulse 2s ease infinite;}
@keyframes reactorPulse{0%,100%{opacity:0.9;transform:scale(1)}50%{opacity:1;transform:scale(1.08)}}
.arc-status-text{position:absolute;bottom:-28px;font-family:'Share Tech Mono',monospace;font-size:0.58rem;color:var(--hud);letter-spacing:0.25em;white-space:nowrap;text-shadow:0 0 8px var(--hud);}

/* WAVEFORM */
.waveform-container{width:100%;display:flex;align-items:center;justify-content:center;gap:2px;height:36px;}
.wave-bar{width:2px;background:linear-gradient(to top,var(--hud2),var(--hud));border-radius:1px;opacity:0.25;height:3px;transition:height 0.08s,opacity 0.08s;}
.wave-bar.active{opacity:0.9;}

/* CHAT */
.chat-area{width:100%;max-width:600px;height:240px;overflow-y:auto;display:flex;flex-direction:column;gap:0.6rem;padding:0.85rem;background:rgba(0,0,0,0.35);border:1px solid var(--border);border-radius:2px;}
.chat-area::-webkit-scrollbar{width:2px;}
.chat-area::-webkit-scrollbar-thumb{background:var(--border2);border-radius:99px;}

.msg{display:flex;flex-direction:column;gap:1px;animation:msgIn 0.25s ease both;}
@keyframes msgIn{from{opacity:0;transform:translateY(6px)}to{opacity:1;transform:translateY(0)}}
.msg-label{font-family:'Share Tech Mono',monospace;font-size:0.55rem;letter-spacing:0.2em;text-transform:uppercase;}
.msg.user .msg-label{color:var(--hud3);}
.msg.jarvis .msg-label{color:var(--hud);}
.msg.system .msg-label{color:var(--orange);}
.msg-text{font-size:0.92rem;line-height:1.5;font-weight:400;}
.msg.user .msg-text{color:rgba(0,255,200,0.85);}
.msg.jarvis .msg-text{color:var(--text);}
.msg.system .msg-text{color:rgba(255,153,0,0.75);font-size:0.75rem;font-family:'Share Tech Mono',monospace;letter-spacing:0.04em;}

.msg-img-wrap{position:relative;display:inline-block;margin-top:6px;border:1px solid var(--border2);border-radius:2px;overflow:hidden;}
.msg-img-wrap::before{content:attr(data-label);position:absolute;top:0;left:0;right:0;font-family:'Share Tech Mono',monospace;font-size:0.5rem;color:var(--hud);background:rgba(0,5,15,0.9);padding:3px 8px;letter-spacing:0.12em;z-index:1;}
.msg-img-wrap img{display:block;max-width:280px;max-height:200px;object-fit:contain;margin-top:18px;box-shadow:var(--glow);}
.msg-img-wrap.generated img{max-width:300px;max-height:300px;}

.img-gen-progress{display:flex;align-items:center;gap:8px;padding:6px 0;font-family:'Share Tech Mono',monospace;font-size:0.68rem;color:var(--hud2);}
.img-gen-spinner{width:12px;height:12px;border:2px solid rgba(0,80,220,0.3);border-top-color:var(--hud2);border-radius:50%;animation:spinAnim 0.7s linear infinite;}
@keyframes spinAnim{to{transform:rotate(360deg)}}

.typing-indicator{display:flex;gap:3px;align-items:center;padding:4px 0;}
.typing-dot{width:4px;height:4px;background:var(--hud);border-radius:50%;animation:tdot 1.2s ease infinite;}
.typing-dot:nth-child(2){animation-delay:0.2s;}
.typing-dot:nth-child(3){animation-delay:0.4s;}
@keyframes tdot{0%,60%,100%{opacity:0.2;transform:scale(0.8)}30%{opacity:1;transform:scale(1)}}

/* IMAGE PREVIEW */
.img-preview-bar{display:none;align-items:center;gap:0.6rem;width:100%;max-width:600px;padding:0.4rem 0.65rem;background:rgba(0,255,200,0.04);border:1px solid rgba(0,255,200,0.2);border-radius:2px;font-family:'Share Tech Mono',monospace;font-size:0.6rem;color:var(--hud3);letter-spacing:0.08em;}
.img-preview-bar.visible{display:flex;}
.img-preview-thumb{width:32px;height:32px;object-fit:cover;border:1px solid rgba(0,255,200,0.4);border-radius:2px;}
.img-preview-name{flex:1;overflow:hidden;text-overflow:ellipsis;white-space:nowrap;}
.img-preview-clear{background:none;border:none;color:var(--red);cursor:pointer;font-size:0.9rem;padding:0 3px;line-height:1;}

/* INPUT */
.input-row{display:flex;gap:0.5rem;align-items:center;width:100%;max-width:600px;}
.text-input{flex:1;background:rgba(0,0,0,0.45);border:1px solid var(--border);border-radius:2px;padding:0.65rem 0.9rem;font-family:'Rajdhani',sans-serif;font-size:0.9rem;color:var(--text);outline:none;transition:border-color 0.2s,box-shadow 0.2s;letter-spacing:0.02em;}
.text-input:focus{border-color:var(--border2);box-shadow:var(--glow);}
.text-input::placeholder{color:rgba(0,200,255,0.2);font-size:0.78rem;letter-spacing:0.08em;}

.hud-btn{background:rgba(0,200,255,0.07);border:1px solid var(--border);color:var(--hud);border-radius:2px;padding:0.6rem 1rem;font-family:'Share Tech Mono',monospace;font-size:0.68rem;cursor:pointer;letter-spacing:0.1em;transition:all 0.2s;white-space:nowrap;}
.hud-btn:hover{background:rgba(0,200,255,0.15);border-color:var(--border2);box-shadow:var(--glow);}
.hud-btn.active{background:rgba(0,255,200,0.1);border-color:rgba(0,255,200,0.5);color:var(--hud3);}
.hud-btn.danger{border-color:rgba(255,34,68,0.4);color:var(--red);}
.hud-btn.danger:hover{background:rgba(255,34,68,0.1);}

.img-attach-btn{background:rgba(0,255,200,0.05);border:1px solid rgba(0,255,200,0.2);color:var(--hud3);border-radius:2px;padding:0.6rem 0.75rem;font-size:0.9rem;cursor:pointer;transition:all 0.2s;display:flex;align-items:center;justify-content:center;}
.img-attach-btn:hover{background:rgba(0,255,200,0.12);border-color:rgba(0,255,200,0.45);}
.img-attach-btn.has-image{background:rgba(0,255,200,0.12);border-color:rgba(0,255,200,0.55);box-shadow:0 0 12px rgba(0,255,200,0.2);}

/* MINI STATS */
.mini-stat{display:flex;justify-content:space-between;align-items:center;padding:0.4rem 0;border-bottom:1px solid rgba(0,200,255,0.06);font-size:0.78rem;}
.mini-stat:last-child{border-bottom:none;}
.mini-stat-label{color:var(--text2);letter-spacing:0.05em;font-size:0.72rem;}
.mini-stat-val{font-family:'Orbitron',monospace;font-size:0.68rem;color:var(--hud3);}
.bar-track{height:3px;background:rgba(255,255,255,0.05);border-radius:99px;margin-top:3px;overflow:hidden;}
.bar-fill{height:100%;border-radius:99px;background:linear-gradient(90deg,var(--hud2),var(--hud));position:relative;}
.bar-fill::after{content:'';position:absolute;right:0;top:0;bottom:0;width:3px;background:white;border-radius:99px;box-shadow:0 0 6px white;}

/* MEMORY */
.memory-item{padding:0.35rem 0.55rem;background:rgba(0,200,255,0.03);border:1px solid rgba(0,200,255,0.07);border-left:2px solid var(--hud);border-radius:2px;font-size:0.7rem;color:var(--text2);margin-bottom:0.35rem;line-height:1.4;letter-spacing:0.02em;cursor:pointer;transition:background 0.2s;display:flex;align-items:flex-start;gap:4px;}
.memory-item:hover{background:rgba(0,200,255,0.07);}
.memory-time{font-family:'Share Tech Mono',monospace;font-size:0.52rem;color:var(--text2);opacity:0.45;display:block;margin-top:2px;}
.mem-tab{background:rgba(0,200,255,0.04);border:1px solid var(--border);color:var(--text2);border-radius:2px;padding:0.18rem 0.45rem;font-family:'Share Tech Mono',monospace;font-size:0.56rem;cursor:pointer;letter-spacing:0.08em;transition:all 0.2s;}
.mem-tab:hover,.mem-tab.active{background:rgba(0,200,255,0.12);color:var(--hud);border-color:var(--border2);}
.mem-delete-btn{margin-left:auto;background:none;border:none;color:rgba(255,34,68,0.35);cursor:pointer;font-size:0.65rem;padding:0 2px;line-height:1;transition:color 0.2s;}
.mem-delete-btn:hover{color:var(--red);}
.mem-cat-badge{font-family:'Share Tech Mono',monospace;font-size:0.5rem;padding:0.08rem 0.3rem;border-radius:1px;letter-spacing:0.04em;margin-right:3px;}
.cat-personal{background:rgba(124,58,237,0.2);color:#a78bfa;}
.cat-task{background:rgba(255,153,0,0.15);color:var(--orange);}
.cat-fact{background:rgba(0,200,255,0.1);color:var(--hud);}
.cat-general{background:rgba(255,255,255,0.04);color:var(--text2);}

/* VOICE BARS */
.voice-bars{display:flex;gap:2px;align-items:flex-end;height:55px;padding:0 3px;}
.vbar{flex:1;background:linear-gradient(to top,var(--hud2),var(--hud));border-radius:1px 1px 0 0;height:3px;transition:height 0.07s;opacity:0.5;}

/* QUICK CMDS */
.quick-cmd{display:flex;align-items:center;gap:7px;padding:0.42rem 0.55rem;background:rgba(0,200,255,0.03);border:1px solid var(--border);border-radius:2px;cursor:pointer;transition:all 0.2s;font-size:0.74rem;letter-spacing:0.02em;color:var(--text2);}
.quick-cmd:hover{background:rgba(0,200,255,0.09);color:var(--text);border-color:var(--border2);}
.quick-cmd .qicon{color:var(--hud);font-size:0.85rem;}

/* CHAT HISTORY PANEL */
.history-item{padding:0.35rem 0.55rem;background:rgba(0,0,0,0.3);border:1px solid rgba(0,200,255,0.07);border-radius:2px;font-size:0.68rem;color:var(--text2);margin-bottom:0.3rem;cursor:pointer;transition:all 0.2s;display:flex;align-items:center;gap:6px;}
.history-item:hover{background:rgba(0,200,255,0.08);color:var(--text);border-color:var(--border);}
.history-item .hi-time{font-family:'Share Tech Mono',monospace;font-size:0.5rem;opacity:0.5;white-space:nowrap;}
.history-item .hi-text{flex:1;overflow:hidden;text-overflow:ellipsis;white-space:nowrap;}
.history-session-badge{font-family:'Share Tech Mono',monospace;font-size:0.5rem;padding:0.08rem 0.3rem;background:rgba(0,200,255,0.1);border:1px solid var(--border);border-radius:1px;color:var(--text2);}

/* FOOTER */
.footer{grid-column:1/-1;margin-top:0.75rem;border:1px solid var(--border);padding:0.4rem 1.25rem;display:flex;justify-content:space-between;align-items:center;background:rgba(0,10,30,0.5);font-family:'Share Tech Mono',monospace;font-size:0.56rem;color:var(--text2);letter-spacing:0.1em;}

/* NOTIF */
#notif{position:fixed;top:1rem;right:1rem;z-index:9000;display:flex;flex-direction:column;gap:0.4rem;}
.notif-item{background:rgba(0,10,25,0.95);border:1px solid var(--border2);border-left:3px solid var(--hud);padding:0.5rem 0.85rem;border-radius:2px;font-family:'Share Tech Mono',monospace;font-size:0.65rem;color:var(--text);animation:notifIn 0.25s ease both;backdrop-filter:blur(10px);max-width:260px;}
@keyframes notifIn{from{opacity:0;transform:translateX(18px)}to{opacity:1;transform:translateX(0)}}

/* LAUNCH INDICATOR */
.launch-indicator{position:fixed;top:50%;left:50%;transform:translate(-50%,-50%);background:rgba(0,5,15,0.97);border:1px solid var(--border2);padding:1.5rem 2.5rem;border-radius:4px;font-family:'Share Tech Mono',monospace;font-size:0.75rem;color:var(--hud);letter-spacing:0.15em;text-align:center;z-index:99998;backdrop-filter:blur(20px);display:none;flex-direction:column;gap:0.75rem;box-shadow:0 0 60px rgba(0,180,255,0.2);}
.launch-indicator.visible{display:flex;}
.launch-bar{width:100%;height:3px;background:rgba(0,200,255,0.1);border-radius:99px;overflow:hidden;}
.launch-bar-fill{height:100%;background:linear-gradient(90deg,var(--hud2),var(--hud));border-radius:99px;animation:launchFill 1.5s ease-out forwards;}
@keyframes launchFill{from{width:0}to{width:100%}}

/* MUSIC PLAYER */
.music-player{padding:0.6rem;background:rgba(0,0,0,0.3);border:1px solid rgba(0,200,255,0.12);border-radius:2px;margin-top:0.5rem;}
.music-info{font-family:'Share Tech Mono',monospace;font-size:0.62rem;color:var(--hud3);letter-spacing:0.08em;margin-bottom:0.5rem;overflow:hidden;text-overflow:ellipsis;white-space:nowrap;}
.music-controls{display:flex;gap:0.4rem;align-items:center;}
.music-btn{background:rgba(0,200,255,0.06);border:1px solid rgba(0,200,255,0.15);color:var(--hud);border-radius:2px;padding:0.3rem 0.5rem;font-family:'Share Tech Mono',monospace;font-size:0.6rem;cursor:pointer;transition:all 0.2s;letter-spacing:0.05em;}
.music-btn:hover{background:rgba(0,200,255,0.15);}
.music-btn.playing{border-color:var(--hud3);color:var(--hud3);}
.music-vol{flex:1;accent-color:var(--hud);}

/* SCROLLBAR */
::-webkit-scrollbar{width:3px;}
::-webkit-scrollbar-track{background:transparent;}
::-webkit-scrollbar-thumb{background:var(--border);border-radius:99px;}

/* MODAL */
.modal-overlay{display:none;position:fixed;inset:0;z-index:99999;background:rgba(0,0,0,0.88);backdrop-filter:blur(8px);align-items:center;justify-content:center;}
.modal-overlay.visible{display:flex;}
.modal-box{background:#000d20;border:1px solid rgba(0,200,255,0.4);border-radius:4px;padding:1.75rem;max-width:460px;width:90%;box-shadow:0 0 60px rgba(0,180,255,0.2);}
.modal-title{font-family:'Orbitron',monospace;font-size:0.9rem;color:var(--hud);margin-bottom:0.4rem;letter-spacing:0.2em;}
.modal-desc{font-family:'Share Tech Mono',monospace;font-size:0.65rem;color:rgba(0,200,255,0.5);margin-bottom:1.25rem;line-height:1.7;}
.modal-input{width:100%;background:rgba(0,0,0,0.5);border:1px solid rgba(0,200,255,0.3);border-radius:2px;padding:0.65rem 0.9rem;font-family:'Share Tech Mono',monospace;font-size:0.8rem;color:var(--hud3);outline:none;letter-spacing:0.05em;margin-bottom:0.9rem;}
.modal-btns{display:flex;gap:0.65rem;}

/* MCU DECORATIVE ARCS */
.mcu-arc{position:fixed;border-radius:50%;border:1px solid rgba(0,200,255,0.06);pointer-events:none;z-index:0;}
.mcu-arc-1{width:700px;height:700px;top:50%;left:50%;transform:translate(-50%,-50%);animation:spinSlowCCW 80s linear infinite;}
.mcu-arc-2{width:500px;height:500px;top:50%;left:50%;transform:translate(-50%,-50%);border-style:dashed;animation:spinSlowCW 60s linear infinite;}
</style>
</head>
<body>

<div class="grid-bg"></div>
<div class="mcu-arc mcu-arc-1"></div>
<div class="mcu-arc mcu-arc-2"></div>
<div id="notif"></div>

<!-- LAUNCH INDICATOR -->
<div class="launch-indicator" id="launchIndicator">
  <div id="launchMsg">‚ñ∏ INITIALIZING TARGET...</div>
  <div class="launch-bar"><div class="launch-bar-fill"></div></div>
</div>

<!-- API KEY MODAL -->
<div class="modal-overlay" id="apiModal">
  <div class="modal-box">
    <div class="corner-tl"></div><div class="corner-tr"></div><div class="corner-bl"></div><div class="corner-br"></div>
    <div class="modal-title">‚öô OPENAI API KEY</div>
    <div class="modal-desc">Required for <b style="color:var(--hud3)">all AI features</b>: chat (GPT-3.5), image analysis (GPT-4o Vision), and image generation (DALL-E 3).<br>Saved in browser local storage only ‚Äî never transmitted elsewhere.<br><br>‚ñ∏ Get your key: <a href="https://platform.openai.com/api-keys" target="_blank" style="color:var(--hud)">platform.openai.com/api-keys</a><br><span style="color:rgba(255,153,0,0.6);font-size:0.6rem;">‚ñ∏ Free tier works. Requires a funded account for image generation.</span></div>
    <input class="modal-input" id="apiKeyInput" type="password" placeholder="sk-..." onkeydown="if(event.key==='Enter')saveApiKey()">
    <div class="modal-btns">
      <button class="hud-btn" onclick="saveApiKey()" style="flex:1">SAVE & CONNECT</button>
      <button class="hud-btn danger" onclick="clearApiKey()" style="flex:1">CLEAR KEY</button>
      <button class="hud-btn" onclick="closeApiModal()" style="padding:0.6rem 0.8rem">‚úï</button>
    </div>
    <div id="apiKeyStatus" style="margin-top:0.65rem;font-family:'Share Tech Mono',monospace;font-size:0.62rem;color:rgba(0,200,255,0.5);"></div>
  </div>
</div>

<div class="app">

  <!-- HEADER -->
  <div class="header">
    <div class="corner-tl"></div><div class="corner-tr"></div><div class="corner-bl"></div><div class="corner-br"></div>
    <div class="header-logo">J.A.R.V.I.S<span>JUST A RATHER VERY INTELLIGENT SYSTEM ¬∑ v8.0.0</span></div>
    <div class="header-status">
      <div class="status-item"><span class="val" id="stat-ops">0</span>OPERATIONS</div>
      <div class="status-item"><span class="val" id="stat-uptime">100%</span>UPTIME</div>
      <div class="status-item"><span class="val" id="stat-mode">STANDBY</span>MODE</div>
    </div>
    <div>
      <div class="header-time" id="clock">00:00:00</div>
      <div class="header-date" id="date-display">LOADING...</div>
    </div>
  </div>

  <!-- LEFT PANEL -->
  <div class="left-panel">

    <div class="panel">
      <div class="corner-tl"></div><div class="corner-tr"></div><div class="corner-bl"></div><div class="corner-br"></div>
      <div class="section-label">SYSTEM DIAGNOSTICS</div>
      <div class="mini-stat"><span class="mini-stat-label">CPU CORE</span><span class="mini-stat-val" id="cpu-val">--</span></div>
      <div class="bar-track"><div class="bar-fill" id="cpu-bar" style="width:40%"></div></div>
      <div style="height:8px"></div>
      <div class="mini-stat"><span class="mini-stat-label">MEMORY</span><span class="mini-stat-val" id="mem-val">--</span></div>
      <div class="bar-track"><div class="bar-fill" id="mem-bar" style="width:58%;background:linear-gradient(90deg,#7c3aed,#a78bfa)"></div></div>
      <div style="height:8px"></div>
      <div class="mini-stat"><span class="mini-stat-label">AI ENGINE</span><span class="mini-stat-val" style="color:var(--hud3)">ONLINE</span></div>
      <div class="bar-track"><div class="bar-fill" style="width:100%;background:linear-gradient(90deg,#10b981,#00ffc8)"></div></div>
      <div style="height:8px"></div>
      <div class="mini-stat"><span class="mini-stat-label">SPEECH SYS</span><span class="mini-stat-val" id="speech-stat" style="color:var(--orange)">INIT</span></div>
      <div class="bar-track"><div class="bar-fill" id="speech-bar" style="width:0%;background:linear-gradient(90deg,var(--orange),#ffcc00)"></div></div>
      <div style="height:8px"></div>
      <div class="mini-stat"><span class="mini-stat-label">VISION SYS</span><span class="mini-stat-val" id="vision-stat" style="color:var(--hud3)">ONLINE</span></div>
      <div class="bar-track"><div class="bar-fill" style="width:100%;background:linear-gradient(90deg,#0055ff,#00c8ff)"></div></div>
    </div>

    <!-- MEMORY VAULT -->
    <div class="panel" style="flex:1;overflow:hidden;display:flex;flex-direction:column;">
      <div class="corner-tl"></div><div class="corner-tr"></div><div class="corner-bl"></div><div class="corner-br"></div>
      <div class="section-label">MEMORY VAULT <span id="mem-count" style="color:var(--hud3);margin-left:4px;font-size:0.58rem">0</span></div>
      <div style="display:flex;gap:0.35rem;margin-bottom:0.5rem;">
        <input id="memInput" placeholder="Save to JARVIS memory..." style="flex:1;background:rgba(0,0,0,0.4);border:1px solid var(--border);border-radius:2px;padding:0.35rem 0.55rem;font-family:'Rajdhani',sans-serif;font-size:0.76rem;color:var(--text);outline:none;" onkeydown="if(event.key==='Enter')saveMemory()">
        <button class="hud-btn" onclick="saveMemory()" style="padding:0.35rem 0.55rem;font-size:0.62rem;">SAVE</button>
      </div>
      <div style="display:flex;gap:0.28rem;margin-bottom:0.5rem;flex-wrap:wrap;">
        <button class="mem-tab active" onclick="filterMemories('all',this)">ALL</button>
        <button class="mem-tab" onclick="filterMemories('personal',this)">PERSONAL</button>
        <button class="mem-tab" onclick="filterMemories('task',this)">TASKS</button>
        <button class="mem-tab" onclick="filterMemories('fact',this)">FACTS</button>
      </div>
      <div id="memory-list" style="flex:1;overflow-y:auto;"></div>
      <button class="hud-btn danger" onclick="clearAllMemories()" style="width:100%;margin-top:0.4rem;font-size:0.62rem;">‚ö† WIPE ALL MEMORIES</button>
    </div>

    <!-- QUICK COMMANDS -->
    <div class="panel">
      <div class="corner-tl"></div><div class="corner-tr"></div><div class="corner-bl"></div><div class="corner-br"></div>
      <div class="section-label">QUICK COMMANDS</div>
      <div style="display:flex;flex-direction:column;gap:0.35rem;">
        <div class="quick-cmd" onclick="quickCmd('open youtube')"><span class="qicon">‚ñ∂</span>OPEN YOUTUBE</div>
        <div class="quick-cmd" onclick="quickCmd('play lofi music on youtube')"><span class="qicon">üéµ</span>PLAY LOFI MUSIC</div>
        <div class="quick-cmd" onclick="quickCmd('open google')"><span class="qicon">üåê</span>OPEN GOOGLE</div>
        <div class="quick-cmd" onclick="quickCmd('Generate an image of Iron Man suit in a futuristic lab')"><span class="qicon">üñºÔ∏è</span>GENERATE IMAGE</div>
        <div class="quick-cmd" onclick="quickCmd('Tell me something interesting about artificial intelligence.')"><span class="qicon">üß†</span>AI BRIEFING</div>
        <div class="quick-cmd" onclick="quickCmd('Write me a short motivational speech in the style of Tony Stark.')"><span class="qicon">üéØ</span>TONY STARK MODE</div>
      </div>
    </div>

  </div>

  <!-- CENTER -->
  <div class="center">

    <!-- ARC REACTOR -->
    <div class="arc-container">
      <!-- Tick marks -->
      <div class="tick-ring" id="tickRing"></div>
      <div class="arc-ring arc-ring-outer"><div class="orb-dot"></div></div>
      <div class="arc-ring arc-ring-mid"></div>
      <div class="arc-ring arc-ring-inner"><div class="orb-dot"></div></div>
      <div class="arc-core" id="arcCore" onclick="toggleListen()">
        <div class="reactor-center" id="reactorCenter"></div>
        <div class="arc-status-text" id="arcStatusText">CLICK TO SPEAK</div>
      </div>
    </div>

    <div class="waveform-container" id="waveform"></div>

    <div class="chat-area" id="chatArea">
      <div class="msg system">
        <span class="msg-label">‚ñ∏ SYSTEM BOOT</span>
        <span class="msg-text">J.A.R.V.I.S online. Vision, speech, and command-execution modules active. Good day, sir.</span>
      </div>
    </div>

    <div class="img-preview-bar" id="imgPreviewBar">
      <img id="imgPreviewThumb" class="img-preview-thumb" src="" alt="">
      <span class="img-preview-name" id="imgPreviewName">image.png</span>
      <span style="font-size:0.58rem;color:var(--text2);">READY TO ANALYZE</span>
      <button class="img-preview-clear" onclick="clearAttachedImage()">‚úï</button>
    </div>

    <div class="input-row">
      <button class="img-attach-btn" id="imgAttachBtn" onclick="document.getElementById('imgFileInput').click()" title="Attach image">üìé</button>
      <input type="file" id="imgFileInput" accept="image/*" style="display:none" onchange="handleImageAttach(event)">
      <input class="text-input" id="textInput" placeholder='Try: "open youtube" ¬∑ "play Shape of You" ¬∑ "generate image of..."' onkeydown="if(event.key==='Enter')sendText()" autocomplete="off">
      <button class="hud-btn" onclick="sendText()">SEND</button>
      <button class="hud-btn" id="voiceBtn" onclick="toggleListen()">üé§ VOICE</button>
    </div>

    <div style="display:flex;gap:0.6rem;flex-wrap:wrap;justify-content:center;">
      <button class="hud-btn" onclick="clearChat()">CLEAR LOG</button>
      <button class="hud-btn" id="autoSpeakBtn" onclick="toggleAutoSpeak()">üîä AUTO-SPEAK: ON</button>
      <button class="hud-btn" onclick="showApiKeyModal()">üîë API KEY</button>
      <button class="hud-btn danger" onclick="emergencyStop()">‚ñ† STOP</button>
    </div>

  </div>

  <!-- RIGHT PANEL -->
  <div class="right-panel">

    <div class="panel">
      <div class="corner-tl"></div><div class="corner-tr"></div><div class="corner-bl"></div><div class="corner-br"></div>
      <div class="section-label">VOICE ANALYZER</div>
      <div class="voice-bars" id="voiceBars"></div>
      <div style="margin-top:0.65rem;display:grid;grid-template-columns:1fr 1fr;gap:0.4rem;">
        <div style="display:flex;flex-direction:column;gap:2px;">
          <span class="mini-stat-label" style="font-size:0.56rem;">RECOGNITION</span>
          <span class="mini-stat-val" id="rec-accuracy">--</span>
        </div>
        <div style="display:flex;flex-direction:column;gap:2px;">
          <span class="mini-stat-label" style="font-size:0.56rem;">VOICE RATE</span>
          <span class="mini-stat-val" id="voice-rate" style="color:var(--hud2)">1.0x</span>
        </div>
      </div>
    </div>

    <!-- VOICE SETTINGS -->
    <div class="panel">
      <div class="corner-tl"></div><div class="corner-tr"></div><div class="corner-bl"></div><div class="corner-br"></div>
      <div class="section-label">VOICE SETTINGS</div>
      <div style="display:flex;flex-direction:column;gap:0.75rem;">
        <div>
          <div class="mini-stat-label" style="font-size:0.62rem;margin-bottom:5px;">SPEECH RATE</div>
          <input type="range" min="0.5" max="2" step="0.05" value="0.88" id="rateSlider" style="width:100%;accent-color:var(--hud);" oninput="updateVoiceSettings()">
          <div style="display:flex;justify-content:space-between;font-size:0.56rem;color:var(--text2);margin-top:1px;font-family:'Share Tech Mono',monospace;"><span>0.5x</span><span id="rate-label">0.88x</span><span>2.0x</span></div>
        </div>
        <div>
          <div class="mini-stat-label" style="font-size:0.62rem;margin-bottom:5px;">PITCH</div>
          <input type="range" min="0.5" max="1.5" step="0.05" value="0.82" id="pitchSlider" style="width:100%;accent-color:var(--hud2);" oninput="updateVoiceSettings()">
          <div style="display:flex;justify-content:space-between;font-size:0.56rem;color:var(--text2);margin-top:1px;font-family:'Share Tech Mono',monospace;"><span>LOW</span><span id="pitch-label">0.82</span><span>HIGH</span></div>
        </div>
        <div>
          <div class="mini-stat-label" style="font-size:0.62rem;margin-bottom:5px;">VOICE PROFILE</div>
          <select id="voiceSelect" style="width:100%;background:rgba(0,0,0,0.4);border:1px solid var(--border);color:var(--text);padding:0.35rem;border-radius:2px;font-family:'Share Tech Mono',monospace;font-size:0.65rem;outline:none;"></select>
        </div>
        <button class="hud-btn" onclick="testVoice()" style="width:100%;font-size:0.65rem;">TEST VOICE OUTPUT</button>
      </div>
    </div>

    <!-- CHAT HISTORY -->
    <div class="panel" style="flex:1;overflow:hidden;display:flex;flex-direction:column;">
      <div class="corner-tl"></div><div class="corner-tr"></div><div class="corner-bl"></div><div class="corner-br"></div>
      <div class="section-label">CHAT HISTORY <span id="hist-count" style="color:var(--hud3);margin-left:4px;font-size:0.56rem">0</span></div>
      <div id="history-list" style="flex:1;overflow-y:auto;"></div>
      <button class="hud-btn danger" onclick="clearHistory()" style="width:100%;margin-top:0.4rem;font-size:0.62rem;">‚ö† WIPE HISTORY</button>
    </div>

    <!-- CAPABILITIES -->
    <div class="panel">
      <div class="corner-tl"></div><div class="corner-tr"></div><div class="corner-bl"></div><div class="corner-br"></div>
      <div class="section-label">CAPABILITIES</div>
      <div style="display:flex;flex-direction:column;gap:0.4rem;">
        <div style="display:flex;align-items:center;gap:7px;font-size:0.74rem;"><span style="color:var(--hud3)">‚óâ</span><span style="color:var(--text2)">Voice recognition (STT)</span></div>
        <div style="display:flex;align-items:center;gap:7px;font-size:0.74rem;"><span style="color:var(--hud3)">‚óâ</span><span style="color:var(--text2)">Speech synthesis (TTS)</span></div>
        <div style="display:flex;align-items:center;gap:7px;font-size:0.74rem;"><span style="color:var(--hud3)">‚óâ</span><span style="color:var(--text2)">Cohere AI brain</span></div>
        <div style="display:flex;align-items:center;gap:7px;font-size:0.74rem;"><span style="color:var(--hud3)">‚óâ</span><span style="color:var(--text2)">Open websites / apps</span></div>
        <div style="display:flex;align-items:center;gap:7px;font-size:0.74rem;"><span style="color:var(--hud3)">‚óâ</span><span style="color:var(--text2)">Play music on YouTube</span></div>
        <div style="display:flex;align-items:center;gap:7px;font-size:0.74rem;"><span style="color:var(--hud3)">‚óâ</span><span style="color:var(--text2)">Image analysis (GPT-4o)</span></div>
        <div style="display:flex;align-items:center;gap:7px;font-size:0.74rem;"><span style="color:var(--hud3)">‚óâ</span><span style="color:var(--text2)">Image generation (DALL-E 3)</span></div>
        <div style="display:flex;align-items:center;gap:7px;font-size:0.74rem;"><span style="color:var(--hud3)">‚óâ</span><span style="color:var(--text2)">Persistent memory vault</span></div>
        <div style="display:flex;align-items:center;gap:7px;font-size:0.74rem;"><span style="color:var(--hud3)">‚óâ</span><span style="color:var(--text2)">Chat history log</span></div>
      </div>
    </div>

  </div>

  <div class="footer">
    <span>STARK INDUSTRIES ¬∑ ADVANCED AI DIVISION ¬∑ CONFIDENTIAL</span>
    <span id="footer-status">SYSTEM NOMINAL ¬∑ ALL MODULES ONLINE</span>
    <span>BUILD 8.0.0 ¬∑ <span id="session-id">SES-XXXX</span></span>
  </div>

</div>

<script>
// ===== INIT =====
const sessionId='SES-'+Math.random().toString(36).substr(2,6).toUpperCase();
document.getElementById('session-id').textContent=sessionId;

let conversationHistory=[];
let isListening=false,isSpeaking=false,isThinking=false;
let autoSpeak=true;
let totalOps=0;
let recognition=null;
let currentMemFilter='all';

// ===== TICK MARKS =====
(()=>{
  const ring=document.getElementById('tickRing');
  for(let i=0;i<36;i++){
    const tick=document.createElement('div');
    tick.className='tick';
    tick.style.transform=`rotate(${i*10}deg) translateX(-50%)`;
    if(i%3===0){tick.style.height='12px';tick.style.background='rgba(0,200,255,0.6)';}
    ring.appendChild(tick);
  }
})();

// ===== WAVEFORM =====
const waveformEl=document.getElementById('waveform');
for(let i=0;i<44;i++){const b=document.createElement('div');b.className='wave-bar';waveformEl.appendChild(b);}
function animateWave(active=false){waveformEl.querySelectorAll('.wave-bar').forEach(b=>{if(active){b.style.height=(3+Math.random()*30)+'px';b.classList.add('active');}else{b.style.height='3px';b.classList.remove('active');}});}
let waveInterval=null;
function startWave(){if(!waveInterval)waveInterval=setInterval(()=>animateWave(true),80);}
function stopWave(){clearInterval(waveInterval);waveInterval=null;animateWave(false);}

// ===== VOICE BARS =====
const voiceBarsEl=document.getElementById('voiceBars');
for(let i=0;i<28;i++){const b=document.createElement('div');b.className='vbar';voiceBarsEl.appendChild(b);}
function animateVBars(on=false){voiceBarsEl.querySelectorAll('.vbar').forEach(b=>{b.style.height=(on?(6+Math.random()*48):(2+Math.random()*6))+'px';b.style.opacity=on?'0.85':'0.2';});}
let vbarInterval=null;
function startVBars(){if(!vbarInterval)vbarInterval=setInterval(()=>animateVBars(true),75);}
function stopVBars(){clearInterval(vbarInterval);vbarInterval=null;animateVBars(false);}

// ===== CLOCK =====
function updateClock(){
  const n=new Date();
  document.getElementById('clock').textContent=`${String(n.getHours()).padStart(2,'0')}:${String(n.getMinutes()).padStart(2,'0')}:${String(n.getSeconds()).padStart(2,'0')}`;
  const DAYS=['SUNDAY','MONDAY','TUESDAY','WEDNESDAY','THURSDAY','FRIDAY','SATURDAY'];
  const MONTHS=['JAN','FEB','MAR','APR','MAY','JUN','JUL','AUG','SEP','OCT','NOV','DEC'];
  document.getElementById('date-display').textContent=`${DAYS[n.getDay()]} ¬∑ ${String(n.getDate()).padStart(2,'0')} ${MONTHS[n.getMonth()]} ${n.getFullYear()}`;
}
updateClock();setInterval(updateClock,1000);

// ===== STATS =====
function updateStats(){
  const cpu=28+Math.random()*38,mem=48+Math.random()*28;
  document.getElementById('cpu-val').textContent=cpu.toFixed(1)+'%';
  document.getElementById('mem-val').textContent=mem.toFixed(1)+'%';
  document.getElementById('cpu-bar').style.width=cpu+'%';
  document.getElementById('mem-bar').style.width=mem+'%';
  document.getElementById('stat-ops').textContent=totalOps.toLocaleString();
}
setInterval(updateStats,2000);updateStats();

// ===== ARC STATE =====
function setArcState(state){
  const core=document.getElementById('arcCore');
  const statusText=document.getElementById('arcStatusText');
  const modeEl=document.getElementById('stat-mode');
  core.className='arc-core';
  const states={
    standby:{text:'CLICK TO SPEAK',mode:'STANDBY'},
    listening:{cls:'listening',text:'LISTENING...',mode:'LISTEN'},
    thinking:{cls:'thinking',text:'PROCESSING...',mode:'THINK'},
    speaking:{cls:'speaking',text:'SPEAKING...',mode:'SPEAK'},
    imaging:{cls:'imaging',text:'RENDERING...',mode:'IMAGE'},
    launching:{cls:'thinking',text:'LAUNCHING...',mode:'LAUNCH'},
  };
  const s=states[state]||states.standby;
  if(s.cls)core.classList.add(s.cls);
  statusText.textContent=s.text;
  modeEl.textContent=s.mode;
  if(state==='listening'){startWave();startVBars();}
  else if(state==='speaking'){startVBars();}
  else{stopWave();stopVBars();}
}

// ===== IMAGE ATTACH =====
let attachedImageBase64=null,attachedImageName='';
function handleImageAttach(e){
  const f=e.target.files[0];
  if(!f||!f.type.startsWith('image/')){showNotif('Please attach an image file.','red');return;}
  const r=new FileReader();
  r.onload=(ev)=>{
    attachedImageBase64=ev.target.result;attachedImageName=f.name;
    document.getElementById('imgPreviewThumb').src=attachedImageBase64;
    document.getElementById('imgPreviewName').textContent=f.name;
    document.getElementById('imgPreviewBar').classList.add('visible');
    document.getElementById('imgAttachBtn').classList.add('has-image');
    showNotif('Image loaded. Ask JARVIS anything about it.','hud3');
  };
  r.readAsDataURL(f);e.target.value='';
}
function clearAttachedImage(){
  attachedImageBase64=null;attachedImageName='';
  document.getElementById('imgPreviewBar').classList.remove('visible');
  document.getElementById('imgAttachBtn').classList.remove('has-image');
  document.getElementById('imgPreviewThumb').src='';
}

// ===== MEMORY =====
const MEMORY_KEY='jarvis_memories_v2';
function loadMemories(){try{return JSON.parse(localStorage.getItem(MEMORY_KEY))||[];}catch{return[];}}
function saveMemoriesToStorage(m){localStorage.setItem(MEMORY_KEY,JSON.stringify(m));}
function saveMemory(){
  const input=document.getElementById('memInput'),text=input.value.trim();
  if(!text)return;
  const lower=text.toLowerCase();
  let cat='general';
  if(/my name|i am|i like|i live|my |i'm |im /.test(lower))cat='personal';
  else if(/todo|task|remind|need to|must|deadline|meeting/.test(lower))cat='task';
  else if(/fact|note|remember that|always|never/.test(lower))cat='fact';
  const mems=loadMemories();
  mems.unshift({id:Date.now(),text,cat,ts:new Date().toISOString(),tsLabel:new Date().toLocaleString()});
  saveMemoriesToStorage(mems);input.value='';
  renderMemories();
  showNotif(`Memory saved: "${text.slice(0,38)}${text.length>38?'...':''}"`, 'hud3');
  speak("Memory stored, sir.");
}
function deleteMemory(id){const m=loadMemories().filter(x=>x.id!==id);saveMemoriesToStorage(m);renderMemories();showNotif('Memory deleted.','orange');}
function clearAllMemories(){if(!confirm('Wipe ALL memories from JARVIS?'))return;localStorage.removeItem(MEMORY_KEY);renderMemories();showNotif('All memories wiped, sir.','red');speak('All memories wiped, sir.');}
function filterMemories(cat,btn){currentMemFilter=cat;document.querySelectorAll('.mem-tab').forEach(t=>t.classList.remove('active'));btn.classList.add('active');renderMemories();}
function renderMemories(){
  const mems=loadMemories(),filtered=currentMemFilter==='all'?mems:mems.filter(m=>m.cat===currentMemFilter);
  document.getElementById('mem-count').textContent=mems.length;
  const list=document.getElementById('memory-list');
  if(!filtered.length){list.innerHTML=`<div style="color:var(--text2);font-size:0.68rem;font-family:'Share Tech Mono',monospace;padding:0.4rem;opacity:0.45">No memories in this category.</div>`;return;}
  list.innerHTML=filtered.map(m=>`<div class="memory-item"><div style="flex:1"><span class="mem-cat-badge cat-${m.cat}">${m.cat.toUpperCase()}</span>${escHtml(m.text)}<span class="memory-time">${m.tsLabel}</span></div><button class="mem-delete-btn" onclick="deleteMemory(${m.id})">‚úï</button></div>`).join('');
}
function getMemoriesAsContext(){
  const m=loadMemories();
  if(!m.length)return'';
  return'\n\nPersistent Memory:\n'+m.slice(0,25).map(x=>`- [${x.cat.toUpperCase()}] ${x.text}`).join('\n');
}

// ===== CHAT HISTORY =====
const HIST_KEY='jarvis_chat_history_v2';
function loadHistory(){try{return JSON.parse(localStorage.getItem(HIST_KEY))||[];}catch{return[];}}
function saveHistoryItem(role,text){
  const h=loadHistory();
  h.unshift({id:Date.now(),role,text:text.slice(0,120),full:text,ts:new Date().toLocaleTimeString(),session:sessionId});
  if(h.length>200)h.pop();
  localStorage.setItem(HIST_KEY,JSON.stringify(h));
  renderHistory();
}
function clearHistory(){if(!confirm('Wipe all chat history?'))return;localStorage.removeItem(HIST_KEY);renderHistory();showNotif('Chat history wiped, sir.','red');}
function renderHistory(){
  const h=loadHistory();
  document.getElementById('hist-count').textContent=h.length;
  const list=document.getElementById('history-list');
  if(!h.length){list.innerHTML=`<div style="color:var(--text2);font-size:0.65rem;font-family:'Share Tech Mono',monospace;padding:0.35rem;opacity:0.4">No history yet.</div>`;return;}
  list.innerHTML=h.slice(0,50).map(item=>`
    <div class="history-item" onclick="replayHistoryItem(${JSON.stringify(item.full).replace(/'/g,'&#39;')})">
      <span style="color:${item.role==='user'?'var(--hud3)':'var(--hud)'};">${item.role==='user'?'YOU':'JAR'}</span>
      <span class="hi-text" style="color:${item.role==='user'?'rgba(0,255,200,0.65)':'var(--text2)'}">${escHtml(item.text)}${item.full.length>120?'‚Ä¶':''}</span>
      <span class="hi-time">${item.ts}</span>
    </div>`).join('');
}
function replayHistoryItem(text){
  if(text.length<200 && !text.startsWith('[Generated')){
    document.getElementById('textInput').value=text;
    showNotif('Loaded from history ‚Äî press SEND to replay.','hud');
  }
}

// ===== WEBSITE OPENER =====
const SITE_MAP={
  youtube:'https://www.youtube.com',google:'https://www.google.com',
  gmail:'https://mail.google.com',facebook:'https://www.facebook.com',
  twitter:'https://www.twitter.com',instagram:'https://www.instagram.com',
  reddit:'https://www.reddit.com',github:'https://www.github.com',
  netflix:'https://www.netflix.com',spotify:'https://www.spotify.com',
  amazon:'https://www.amazon.com',wikipedia:'https://www.wikipedia.org',
  whatsapp:'https://web.whatsapp.com',linkedin:'https://www.linkedin.com',
  twitch:'https://www.twitch.tv',discord:'https://discord.com/app',
  stackoverflow:'https://stackoverflow.com',maps:'https://maps.google.com',
  drive:'https://drive.google.com',docs:'https://docs.google.com',
  news:'https://news.google.com',translate:'https://translate.google.com',
};

function detectWebsiteCommand(text){
  const lower=text.toLowerCase().trim();
  // open [site] pattern
  const openMatch=lower.match(/^(?:open|launch|go to|navigate to|take me to|load)\s+(.+)$/i);
  if(openMatch){
    const target=openMatch[1].trim();
    for(const[key,url]of Object.entries(SITE_MAP)){
      if(target.includes(key))return{type:'open',url,name:key};
    }
    // Try as direct URL
    if(/\.(com|org|net|io|co|ai|dev|tv|me)/.test(target)){
      let url=target;
      if(!url.startsWith('http'))url='https://'+url;
      return{type:'open',url,name:target};
    }
    // Google search
    return{type:'search',url:'https://www.google.com/search?q='+encodeURIComponent(target),name:target};
  }
  return null;
}

function detectMusicCommand(text){
  const lower=text.toLowerCase().trim();
  const patterns=[
    /^(?:play|search|find|put on|play me)\s+(.+?)(?:\s+(?:on|in)\s+(?:youtube|spotify|music))?$/i,
    /^(?:play|put on)\s+(.+)\s+(?:music|song|track|playlist)$/i,
  ];
  for(const pat of patterns){
    const m=lower.match(pat);
    if(m){
      const query=m[1].trim();
      if(!query.match(/^(a game|games|video|videos)$/)){
        return{type:'music',query,url:'https://www.youtube.com/results?search_query='+encodeURIComponent(query+' music')};
      }
    }
  }
  return null;
}

async function openWebsite(cmd){
  setArcState('launching');
  showLaunchIndicator(cmd.type==='music'?`‚ñ∏ PLAYING: ${cmd.query||cmd.name}`.toUpperCase():`‚ñ∏ LAUNCHING: ${cmd.name||cmd.url}`.toUpperCase());
  await sleep(1400);
  hideLaunchIndicator();
  window.open(cmd.url,'_blank');
  setArcState('standby');
  const msgs={
    open:`Launching ${cmd.name||cmd.url}, sir. Opening in a new tab.`,
    search:`Performing a Google search for "${cmd.name}", sir.`,
    music:`Playing ${cmd.query} on YouTube, sir. Enjoy.`,
  };
  return msgs[cmd.type]||`Executed, sir.`;
}

function showLaunchIndicator(msg){
  const el=document.getElementById('launchIndicator');
  document.getElementById('launchMsg').textContent=msg;
  el.classList.add('visible');
  // Re-trigger animation
  const bar=el.querySelector('.launch-bar-fill');
  bar.style.animation='none';
  requestAnimationFrame(()=>{bar.style.animation='launchFill 1.4s ease-out forwards';});
}
function hideLaunchIndicator(){document.getElementById('launchIndicator').classList.remove('visible');}
function sleep(ms){return new Promise(r=>setTimeout(r,ms));}

// ===== IMAGE DETECTION =====
function isImageGenRequest(text){
  return /\b(generate|create|draw|make|render|show me|paint|produce|design)\s+(an?\s+)?(image|picture|photo|illustration|artwork|painting|sketch|portrait|scene|visual)\b/i.test(text)
    ||/\b(generate|create|draw|make|render|paint)\b.*\b(of|showing|depicting|with)\b/i.test(text)
    ||/^image of /i.test(text)||/^draw /i.test(text)||/^generate /i.test(text);
}

// ===== IMAGE GENERATION =====
async function generateImage(prompt,key){
  const r=await fetch('https://api.openai.com/v1/images/generations',{method:'POST',headers:{'Content-Type':'application/json','Authorization':'Bearer '+key},body:JSON.stringify({model:'dall-e-3',prompt,n:1,size:'1024x1024',quality:'standard'})});
  const d=await r.json();
  if(d.error)throw new Error(d.error.message);
  return d.data[0].url;
}

// ===== IMAGE ANALYSIS =====
async function analyzeImage(base64DataUrl,question,key){
  const base64=base64DataUrl.split(',')[1];
  const mime=(base64DataUrl.match(/data:([^;]+);\s*/)||[])[1]||'image/jpeg';
  const r=await fetch('https://api.openai.com/v1/chat/completions',{method:'POST',headers:{'Content-Type':'application/json','Authorization':'Bearer '+key},body:JSON.stringify({model:'gpt-4o',max_tokens:300,messages:[{role:'user',content:[{type:'image_url',image_url:{url:`data:${mime};base64,${base64}`,detail:'auto'}},{type:'text',text:`You are J.A.R.V.I.S., Tony Stark's AI. Analyze this image and respond to: "${question||'Describe this image.'}". Keep it 2-3 sentences, spoken-word, dry British wit. Address user as "sir".`}]}]})});
  const d=await r.json();
  if(d.error)throw new Error(d.error.message);
  return d.choices[0].message.content;
}

// ===== MAIN MESSAGE HANDLER =====
async function sendMessage(text){
  if(!text||isThinking)return;
  document.getElementById('textInput').value='';
  totalOps++;

  const imageToProcess=attachedImageBase64,imageName=attachedImageName;

  // User message in chat
  const chatArea=document.getElementById('chatArea');
  const userDiv=document.createElement('div');
  userDiv.className='msg user';
  userDiv.innerHTML=`<span class="msg-label">‚ñ∏ YOU</span><span class="msg-text">${escHtml(text)}</span>`;
  if(imageToProcess){
    const wrap=document.createElement('div');wrap.className='msg-img-wrap';wrap.setAttribute('data-label','‚óà ATTACHED ¬∑ '+imageName.toUpperCase());
    const img=document.createElement('img');img.src=imageToProcess;wrap.appendChild(img);userDiv.appendChild(wrap);
  }
  chatArea.appendChild(userDiv);chatArea.scrollTop=chatArea.scrollHeight;
  if(imageToProcess)clearAttachedImage();

  // Save to history
  saveHistoryItem('user',text);
  conversationHistory.push({role:'user',content:text});
  isThinking=true;
  showTyping();setArcState('thinking');

  // Auto-remember patterns
  for(const pat of[/^(?:please\s+)?remember\s+(?:that\s+)?(.+)/i,/^(?:please\s+)?save\s+(?:to\s+memory)?[:\s]+(.+)/i,/^don'?t forget\s+(?:that\s+)?(.+)/i]){
    const m=text.match(pat);
    if(m){const t=m[1].trim();const lower=t.toLowerCase();let cat='general';
      if(/my name|i am|i like|i live|my |i'm /.test(lower))cat='personal';
      else if(/task|todo|remind|need to|must|deadline/.test(lower))cat='task';
      else if(/fact|note|always|never|important/.test(lower))cat='fact';
      const mems=loadMemories();mems.unshift({id:Date.now(),text:t,cat,ts:new Date().toISOString(),tsLabel:new Date().toLocaleString()});
      saveMemoriesToStorage(mems);renderMemories();showNotif(`Saved to Memory: "${t.slice(0,38)}"`,'hud3');break;}
  }

  const openaiKey=localStorage.getItem('jarvis_openai_key');

  try{
    // CASE 1: Image attached ‚Üí analyze
    if(imageToProcess){
      if(!openaiKey){removeTyping();isThinking=false;setArcState('standby');addMsg('system','OpenAI API key required for image analysis. Click üîë API KEY.');showApiKeyModal();return;}
      const analysis=await analyzeImage(imageToProcess,text,openaiKey);
      removeTyping();conversationHistory.push({role:'assistant',content:analysis});if(conversationHistory.length>20)conversationHistory=conversationHistory.slice(-20);
      addMsg('jarvis',analysis);saveHistoryItem('jarvis',analysis);isThinking=false;setArcState('standby');if(autoSpeak)speak(analysis);return;
    }

    // CASE 2: Music command
    const musicCmd=detectMusicCommand(text);
    if(musicCmd){
      const reply=await openWebsite(musicCmd);
      removeTyping();addMsg('jarvis',reply);saveHistoryItem('jarvis',reply);
      conversationHistory.push({role:'assistant',content:reply});isThinking=false;setArcState('standby');if(autoSpeak)speak(reply);return;
    }

    // CASE 3: Website open command
    const webCmd=detectWebsiteCommand(text);
    if(webCmd){
      const reply=await openWebsite(webCmd);
      removeTyping();addMsg('jarvis',reply);saveHistoryItem('jarvis',reply);
      conversationHistory.push({role:'assistant',content:reply});isThinking=false;setArcState('standby');if(autoSpeak)speak(reply);return;
    }

    // CASE 4: Image generation
    if(isImageGenRequest(text)){
      if(!openaiKey){removeTyping();isThinking=false;setArcState('standby');addMsg('system','OpenAI API key required for image generation. Click üîë API KEY.');showApiKeyModal();return;}
      setArcState('imaging');
      let imgPrompt=text.replace(/^(please\s+)?(generate|create|draw|make|render|show me|paint|produce|design)\s+(an?\s+)?(image|picture|photo|illustration|artwork|painting|sketch|portrait|scene|visual)?\s*(of\s+)?/i,'').replace(/^(please\s+)?/i,'').trim()||text;
      const progDiv=document.createElement('div');progDiv.id='img-gen-progress';progDiv.className='msg jarvis';
      progDiv.innerHTML=`<span class="msg-label">‚ñ∏ J.A.R.V.I.S RENDERING</span><div class="img-gen-progress"><div class="img-gen-spinner"></div><span>DALL-E 3: "${imgPrompt.slice(0,48)}${imgPrompt.length>48?'...':''}"</span></div>`;
      chatArea.appendChild(progDiv);chatArea.scrollTop=chatArea.scrollHeight;
      try{
        const imgUrl=await generateImage(imgPrompt,openaiKey);
        progDiv.remove();removeTyping();
        const imgDiv=document.createElement('div');imgDiv.className='msg jarvis';
        imgDiv.innerHTML=`<span class="msg-label">‚ñ∏ J.A.R.V.I.S ‚Äî IMAGE SYNTHESIS COMPLETE</span>`;
        const wrap=document.createElement('div');wrap.className='msg-img-wrap generated';wrap.setAttribute('data-label','‚óà DALL-E 3 ¬∑ '+imgPrompt.slice(0,36).toUpperCase()+(imgPrompt.length>36?'...':''));
        const img=document.createElement('img');img.src=imgUrl;img.alt=imgPrompt;img.style.cursor='pointer';img.title='Click to open full size';img.onclick=()=>window.open(imgUrl,'_blank');wrap.appendChild(img);imgDiv.appendChild(wrap);
        const replyText=`Image rendered, sir. DALL-E 3 synthesis complete.`;
        const textSpan=document.createElement('span');textSpan.className='msg-text';textSpan.style.marginTop='5px';textSpan.textContent=replyText;imgDiv.appendChild(textSpan);
        chatArea.appendChild(imgDiv);chatArea.scrollTop=chatArea.scrollHeight;
        conversationHistory.push({role:'assistant',content:`[Generated image: "${imgPrompt}"]`});saveHistoryItem('jarvis',replyText);
        isThinking=false;setArcState('standby');if(autoSpeak)speak(replyText);
      }catch(err){
        progDiv.remove();removeTyping();isThinking=false;setArcState('standby');
        addMsg('system','IMAGE GENERATION ERROR: '+err.message);addMsg('jarvis','Image synthesis failed, sir. '+err.message);
        if(autoSpeak)speak('Image generation failed, sir.');
      }
      return;
    }

    // CASE 5: Normal AI chat ‚Äî using OpenAI GPT-3.5 (same key as image features)
    if(!openaiKey){
      removeTyping();isThinking=false;setArcState('standby');
      addMsg('system','An OpenAI API key is required for chat, image analysis, and image generation. Click üîë API KEY to add yours.');
      addMsg('jarvis','I require an OpenAI API key to function, sir. Please click the üîë API KEY button and enter yours.');
      showApiKeyModal();return;
    }
    const memCtx=getMemoriesAsContext();
    const systemPrompt=`You are J.A.R.V.I.S. (Just A Rather Very Intelligent System) ‚Äî Tony Stark's voice AI assistant from Iron Man. You speak exactly like Paul Bettany's portrayal: calm, precise, dry British wit, slightly formal but warm. Responses must be SHORT ‚Äî 1 to 3 spoken sentences maximum. Never use markdown, bullet points, or lists. Write for speech, not text. Use natural contractions. Occasionally address the user as "sir". You are helpful, subtly sarcastic when appropriate, and highly intelligent. Never break character.${memCtx}`;
    const oaiMessages=[{role:'system',content:systemPrompt},...conversationHistory.slice(-14).map(m=>({role:m.role==='user'?'user':'assistant',content:m.content}))];
    const r=await fetch('https://api.openai.com/v1/chat/completions',{method:'POST',headers:{'Content-Type':'application/json','Authorization':'Bearer '+openaiKey},body:JSON.stringify({model:'gpt-3.5-turbo',messages:oaiMessages,max_tokens:200,temperature:0.75})});
    const data=await r.json();removeTyping();
    if(data.choices&&data.choices[0]){
      const reply=data.choices[0].message.content.trim();
      conversationHistory.push({role:'assistant',content:reply});if(conversationHistory.length>20)conversationHistory=conversationHistory.slice(-20);
      addMsg('jarvis',reply);saveHistoryItem('jarvis',reply);isThinking=false;setArcState('standby');if(autoSpeak)speak(reply);
    }else{throw new Error(data.error?.message||'OpenAI error');}
  }catch(err){
    removeTyping();isThinking=false;setArcState('standby');
    addMsg('system','ERROR: '+err.message);addMsg('jarvis','Connectivity issue detected, sir. '+err.message);
    if(autoSpeak)speak('I encountered a connectivity issue, sir.');console.error(err);
  }
}

function sendText(){const v=document.getElementById('textInput').value.trim();if(v)sendMessage(v);}
function quickCmd(cmd){document.getElementById('textInput').value=cmd;sendMessage(cmd);}

// ===== CHAT UI =====
function addMsg(type,text){
  const chatArea=document.getElementById('chatArea');
  const div=document.createElement('div');div.className='msg '+type;
  const lbl=type==='user'?'‚ñ∏ YOU':type==='jarvis'?'‚ñ∏ J.A.R.V.I.S':'‚ñ∏ SYSTEM';
  div.innerHTML=`<span class="msg-label">${lbl}</span><span class="msg-text">${escHtml(text)}</span>`;
  chatArea.appendChild(div);chatArea.scrollTop=chatArea.scrollHeight;
}
function showTyping(){const a=document.getElementById('chatArea');const d=document.createElement('div');d.id='typing-indicator';d.className='msg jarvis';d.innerHTML=`<span class="msg-label">‚ñ∏ J.A.R.V.I.S PROCESSING</span><div class="typing-indicator"><div class="typing-dot"></div><div class="typing-dot"></div><div class="typing-dot"></div></div>`;a.appendChild(d);a.scrollTop=a.scrollHeight;}
function removeTyping(){const t=document.getElementById('typing-indicator');if(t)t.remove();}
function escHtml(s){return s.replace(/&/g,'&amp;').replace(/</g,'&lt;').replace(/>/g,'&gt;').replace(/\n/g,'<br>');}
function clearChat(){document.getElementById('chatArea').innerHTML='';conversationHistory=[];addMsg('system','Conversation log cleared. Memory vault and history retained.');speak('Conversation log cleared, sir.');}

// ===== JARVIS VOICE ENGINE =====
// Priority voice selection ‚Äî tries to get the most natural, British/premium voice available
const JARVIS_VOICE_PRIORITY = [
  // Premium neural voices (Edge/Chrome)
  'Microsoft Ryan Online (Natural) - English (United Kingdom)',
  'Microsoft George Online (Natural) - English (United Kingdom)',
  'Microsoft Abbi Online (Natural) - English (United Kingdom)',
  'Google UK English Male',
  'Google UK English Female',
  // MacOS/iOS premium
  'Daniel','Oliver','Arthur','Tom',
  // Generic British fallbacks
  'en-GB','en_GB',
  // US fallback voices
  'Google US English','Alex','Fred','Daniel',
  'Microsoft David Desktop - English (United States)',
];

let jarvisVoice = null;
let allVoices = [];

function scoreVoice(v){
  const n=v.name.toLowerCase(),l=v.lang.toLowerCase();
  let score=0;
  // British English ‚Äî highest priority
  if(l.includes('en-gb')||l.includes('en_gb'))score+=40;
  // Neural/Natural voices
  if(n.includes('natural')||n.includes('neural')||n.includes('online'))score+=35;
  // Google quality
  if(n.includes('google'))score+=20;
  // Preferred names
  if(/ryan|george|daniel|oliver|arthur|david|james|mark|paul/.test(n))score+=15;
  // English at all
  if(l.startsWith('en'))score+=10;
  // Avoid female unless no choice
  if(/female|woman|girl|zira|susan|hazel|fiona|samantha|karen|victoria|moira/.test(n))score-=5;
  return score;
}

function initVoices(){
  const voices=window.speechSynthesis.getVoices();
  if(!voices.length){setTimeout(initVoices,200);return;}
  allVoices=voices;
  const sel=document.getElementById('voiceSelect');sel.innerHTML='';
  // Show all English voices sorted by score
  const engVoices=voices.filter(v=>v.lang.startsWith('en')||v.lang.startsWith('en'));
  const sorted=[...engVoices].sort((a,b)=>scoreVoice(b)-scoreVoice(a));
  sorted.forEach((v,i)=>{
    const o=document.createElement('option');
    o.value=v.name;
    o.textContent=v.name+(v.lang?` (${v.lang})`:'');
    sel.appendChild(o);
  });
  // Auto-select best voice
  if(sorted.length){
    jarvisVoice=sorted[0];
    sel.value=sorted[0].name;
    const vname=jarvisVoice.name;
    const isBritish=jarvisVoice.lang.includes('GB')||jarvisVoice.lang.includes('gb');
    showNotif(`Voice: ${vname.slice(0,28)} ${isBritish?'üá¨üáß':''}`, isBritish?'hud3':'hud');
  }
  document.getElementById('speech-stat').textContent='READY';
  document.getElementById('speech-stat').style.color='var(--hud3)';
  document.getElementById('speech-bar').style.width='100%';
  showNotif('Speech synthesis online.','hud3');
}
window.speechSynthesis.onvoiceschanged=initVoices;setTimeout(initVoices,400);

function updateVoiceSettings(){
  const r=document.getElementById('rateSlider').value,p=document.getElementById('pitchSlider').value;
  document.getElementById('rate-label').textContent=r+'x';
  document.getElementById('pitch-label').textContent=p;
  document.getElementById('voice-rate').textContent=r+'x';
  // Update selected voice
  const selName=document.getElementById('voiceSelect').value;
  const found=allVoices.find(v=>v.name===selName);
  if(found)jarvisVoice=found;
}

// Process text to sound more natural/JARVIS-like when spoken
function processTextForSpeech(text){
  return text
    // Expand abbreviations JARVIS would say properly
    .replace(/\bJ\.A\.R\.V\.I\.S\.?\b/gi,'Jarvis')
    .replace(/\bAI\b/g,'A. I.')
    .replace(/\bAPI\b/g,'A. P. I.')
    .replace(/\bURL\b/g,'U. R. L.')
    .replace(/\bHTTP[S]?\b/g,'')
    .replace(/\bGPT\b/g,'G. P. T.')
    // Clean up markdown leftovers
    .replace(/[*_`#]/g,'')
    // Natural pauses with commas
    .replace(/\.\s+([A-Z])/g,'. $1')
    // Remove URLs
    .replace(/https?:\/\/\S+/g,'the provided link')
    .trim();
}

function speak(text){
  if(!text||!autoSpeak)return;
  window.speechSynthesis.cancel();

  const processed=processTextForSpeech(text);
  // For long responses, chunk at sentence boundaries to avoid cutoff bug in Chrome
  const sentences=processed.match(/[^.!?]+[.!?]+|[^.!?]+$/g)||[processed];

  let idx=0;
  function speakNext(){
    if(idx>=sentences.length){isSpeaking=false;setArcState('standby');stopVBars();return;}
    const utt=new SpeechSynthesisUtterance(sentences[idx].trim());
    // Use currently selected voice (re-fetch in case user changed it)
    const selName=document.getElementById('voiceSelect').value;
    const selectedVoice=allVoices.find(v=>v.name===selName)||jarvisVoice;
    if(selectedVoice)utt.voice=selectedVoice;
    // JARVIS voice profile: slightly slower, lower pitch, very clear
    const baseRate=parseFloat(document.getElementById('rateSlider').value);
    const basePitch=parseFloat(document.getElementById('pitchSlider').value);
    utt.rate=baseRate;
    utt.pitch=basePitch;
    utt.volume=1;
    if(idx===0){utt.onstart=()=>{isSpeaking=true;setArcState('speaking');startVBars();};}
    utt.onend=()=>{idx++;speakNext();};
    utt.onerror=()=>{idx++;speakNext();};
    window.speechSynthesis.speak(utt);
  }
  speakNext();
}

function testVoice(){
  speak("Good day, sir. J.A.R.V.I.S. is fully operational. All systems are running within normal parameters. Shall I prepare a status report, or is there something more immediately pressing?");
}

// ===== SPEECH RECOGNITION =====
function initRecognition(){
  if(!('webkitSpeechRecognition'in window)&&!('SpeechRecognition'in window)){showNotif('Speech recognition not supported.','red');return;}
  const SR=window.SpeechRecognition||window.webkitSpeechRecognition;
  recognition=new SR();recognition.continuous=false;recognition.interimResults=true;recognition.lang='en-US';
  recognition.onstart=()=>{isListening=true;setArcState('listening');document.getElementById('voiceBtn').classList.add('active');document.getElementById('voiceBtn').textContent='üé§ STOP';};
  recognition.onresult=(e)=>{let interim='',final='';for(let i=e.resultIndex;i<e.results.length;i++){const t=e.results[i][0].transcript;if(e.results[i].isFinal)final+=t;else interim+=t;}const conf=e.results[e.results.length-1][0].confidence;if(conf)document.getElementById('rec-accuracy').textContent=(conf*100).toFixed(0)+'%';if(final){document.getElementById('textInput').value=final;sendMessage(final);}else if(interim){document.getElementById('textInput').value=interim+'...';}};
  recognition.onend=()=>{isListening=false;document.getElementById('voiceBtn').classList.remove('active');document.getElementById('voiceBtn').textContent='üé§ VOICE';if(!isThinking)setArcState('standby');stopWave();};
  recognition.onerror=(e)=>{isListening=false;document.getElementById('voiceBtn').classList.remove('active');document.getElementById('voiceBtn').textContent='üé§ VOICE';setArcState('standby');stopWave();if(e.error!=='no-speech')showNotif('Voice error: '+e.error,'red');};
}
initRecognition();
function toggleListen(){if(!recognition){showNotif('Speech recognition unavailable.','red');return;}if(isListening){recognition.stop();}else{if(isSpeaking){window.speechSynthesis.cancel();isSpeaking=false;}try{recognition.start();}catch(e){console.log(e);}}}

// ===== CONTROLS =====
function toggleAutoSpeak(){autoSpeak=!autoSpeak;document.getElementById('autoSpeakBtn').textContent=`üîä AUTO-SPEAK: ${autoSpeak?'ON':'OFF'}`;if(!autoSpeak)window.speechSynthesis.cancel();}
function emergencyStop(){
  window.speechSynthesis.cancel();if(recognition&&isListening)recognition.stop();
  isListening=false;isSpeaking=false;isThinking=false;
  setArcState('standby');stopWave();stopVBars();removeTyping();hideLaunchIndicator();
  const p=document.getElementById('img-gen-progress');if(p)p.remove();
  showNotif('EMERGENCY STOP. All processes halted.','red');
}

// ===== NOTIFICATIONS =====
function showNotif(msg,color='hud'){
  const c=document.getElementById('notif');const d=document.createElement('div');d.className='notif-item';d.style.borderLeftColor=`var(--${color})`;d.textContent='‚ñ∏ '+msg;c.appendChild(d);
  setTimeout(()=>{d.style.opacity='0';d.style.transition='opacity 0.4s';setTimeout(()=>d.remove(),400);},3200);
}

// ===== API KEY =====
function showApiKeyModal(){
  document.getElementById('apiModal').classList.add('visible');
  const k=localStorage.getItem('jarvis_openai_key'),input=document.getElementById('apiKeyInput'),status=document.getElementById('apiKeyStatus');
  if(k){input.value=k;status.innerHTML='‚úì Key active. Image features ONLINE.';status.style.color='rgba(0,255,200,0.7)';}
  else{input.value='';status.textContent='No key. Image features require an OpenAI key.';status.style.color='rgba(0,200,255,0.4)';}
  setTimeout(()=>input.focus(),100);
}
function closeApiModal(){document.getElementById('apiModal').classList.remove('visible');}
function saveApiKey(){
  const k=document.getElementById('apiKeyInput').value.trim(),s=document.getElementById('apiKeyStatus');
  if(!k){s.textContent='‚ö† Enter a valid key.';s.style.color='rgba(255,153,0,0.8)';return;}
  if(!k.startsWith('sk-')){s.textContent='‚ö† Key should start with "sk-".';s.style.color='rgba(255,153,0,0.8)';return;}
  localStorage.setItem('jarvis_openai_key',k);s.innerHTML='‚úì API key saved. Vision & image gen ACTIVE.';s.style.color='rgba(0,255,200,0.8)';
  showNotif('OpenAI key saved. Vision modules online.','hud3');setTimeout(closeApiModal,1100);
}
function clearApiKey(){localStorage.removeItem('jarvis_openai_key');document.getElementById('apiKeyInput').value='';document.getElementById('apiKeyStatus').textContent='Key cleared.';document.getElementById('apiKeyStatus').style.color='rgba(255,34,68,0.7)';showNotif('OpenAI API key removed.','red');}

// ===== KEYBOARD SHORTCUTS =====
document.addEventListener('keydown',e=>{
  if(e.key==='Escape')emergencyStop();
  if(e.key===' '&&e.target===document.body){e.preventDefault();toggleListen();}
});

// ===== BOOT =====
renderMemories();renderHistory();
const savedCount=loadMemories().length,hasKey=!!localStorage.getItem('jarvis_openai_key');
setTimeout(()=>{
  showNotif('J.A.R.V.I.S. systems online.','hud3');
  const bootMsg=`Good day, sir. All systems are operational. ${savedCount>0?savedCount+' stored memories loaded. ':''}${hasKey?'All modules active ‚Äî ready to assist.':'An OpenAI API key is required. Please click the üîë API KEY button to get started.'}`;
  addMsg('jarvis',bootMsg);
  if(autoSpeak)setTimeout(()=>speak('Good day, sir. All systems operational. How may I assist you today?'),700);
},900);
setTimeout(()=>showNotif('Tip: Say "open [site]" or "play [song name]"','hud'),2500);
if(!hasKey)setTimeout(()=>{showNotif('‚ö† OpenAI key required ‚Äî click üîë API KEY','orange');},3500);

console.log('%cJ.A.R.V.I.S.','color:#00c8ff;font-size:26px;font-weight:900;font-family:monospace;');
console.log('%cJust A Rather Very Intelligent System v8.0.0','color:#00ffc8;font-size:11px;');
</script>
</body>
</html>
